//globals.css
@import "tailwindcss";
@plugin "tailwindcss-animate";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

@layer base {
  :root {
    --background: 210 40% 96%;
    --foreground: 210 40% 3%;
    --card: 0 0% 100%;
    --card-foreground: 210 40% 3%;
  }

  html {
    scroll-behavior: smooth;
  }

  body {
    @apply bg-background text-foreground;
  }
}

@layer components {
  .btn {
    @apply inline-flex items-center justify-center rounded-md font-medium transition-colors;
  }

  .card {
    @apply rounded-lg border border-gray-200 bg-white shadow-sm;
  }
}

@theme inline {
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --color-card: var(--card);
  --color-card-foreground: var(--card-foreground);
  --color-popover: var(--popover);
  --color-popover-foreground: var(--popover-foreground);
  --color-primary: var(--primary);
  --color-primary-foreground: var(--primary-foreground);
  --color-secondary: var(--secondary);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-muted: var(--muted);
  --color-muted-foreground: var(--muted-foreground);
  --color-accent: var(--accent);
  --color-accent-foreground: var(--accent-foreground);
  --color-destructive: var(--destructive);
  --color-border: var(--border);
  --color-input: var(--input);
  --color-ring: var(--ring);
  --color-chart-1: var(--chart-1);
  --color-chart-2: var(--chart-2);
  --color-chart-3: var(--chart-3);
  --color-chart-4: var(--chart-4);
  --color-chart-5: var(--chart-5);
  --color-sidebar: var(--sidebar);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-ring: var(--sidebar-ring);
}

:root {
  --radius: 0.625rem;
  --background: oklch(1 0 0);
  --foreground: oklch(0.145 0 0);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.145 0 0);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.145 0 0);
  --primary: oklch(0.205 0 0);
  --primary-foreground: oklch(0.985 0 0);
  --secondary: oklch(0.97 0 0);
  --secondary-foreground: oklch(0.205 0 0);
  --muted: oklch(0.97 0 0);
  --muted-foreground: oklch(0.556 0 0);
  --accent: oklch(0.97 0 0);
  --accent-foreground: oklch(0.205 0 0);
  --destructive: oklch(0.577 0.245 27.325);
  --border: oklch(0.922 0 0);
  --input: oklch(0.922 0 0);
  --ring: oklch(0.708 0 0);
  --chart-1: oklch(0.646 0.222 41.116);
  --chart-2: oklch(0.6 0.118 184.704);
  --chart-3: oklch(0.398 0.07 227.392);
  --chart-4: oklch(0.828 0.189 84.429);
  --chart-5: oklch(0.769 0.188 70.08);
  --sidebar: oklch(0.985 0 0);
  --sidebar-foreground: oklch(0.145 0 0);
  --sidebar-primary: oklch(0.205 0 0);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.97 0 0);
  --sidebar-accent-foreground: oklch(0.205 0 0);
  --sidebar-border: oklch(0.922 0 0);
  --sidebar-ring: oklch(0.708 0 0);
}

.dark {
  --background: oklch(0.145 0 0);
  --foreground: oklch(0.985 0 0);
  --card: oklch(0.205 0 0);
  --card-foreground: oklch(0.985 0 0);
  --popover: oklch(0.205 0 0);
  --popover-foreground: oklch(0.985 0 0);
  --primary: oklch(0.922 0 0);
  --primary-foreground: oklch(0.205 0 0);
  --secondary: oklch(0.269 0 0);
  --secondary-foreground: oklch(0.985 0 0);
  --muted: oklch(0.269 0 0);
  --muted-foreground: oklch(0.708 0 0);
  --accent: oklch(0.269 0 0);
  --accent-foreground: oklch(0.985 0 0);
  --destructive: oklch(0.704 0.191 22.216);
  --border: oklch(1 0 0 / 10%);
  --input: oklch(1 0 0 / 15%);
  --ring: oklch(0.556 0 0);
  --chart-1: oklch(0.488 0.243 264.376);
  --chart-2: oklch(0.696 0.17 162.48);
  --chart-3: oklch(0.769 0.188 70.08);
  --chart-4: oklch(0.627 0.265 303.9);
  --chart-5: oklch(0.645 0.246 16.439);
  --sidebar: oklch(0.205 0 0);
  --sidebar-foreground: oklch(0.985 0 0);
  --sidebar-primary: oklch(0.488 0.243 264.376);
  --sidebar-primary-foreground: oklch(0.985 0 0);
  --sidebar-accent: oklch(0.269 0 0);
  --sidebar-accent-foreground: oklch(0.985 0 0);
  --sidebar-border: oklch(1 0 0 / 10%);
  --sidebar-ring: oklch(0.556 0 0);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
}


//layout.tsx
import { Inter } from "next/font/google";
import "./globals.css";
import { Toaster } from "sonner";

const inter = Inter({ subsets: ["latin", "vietnamese"] });

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="vi">
      <body className={inter.className}>
        {children}
        <Toaster position="top-right" />
      </body>
    </html>
  );
}


//page.tsx
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import Image from "next/image";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { getStoredUser } from "@/lib/auth/utils";
import { Award, BookOpenCheck, Clock } from "lucide-react";

// --- Dá»¯ liá»‡u giáº£ vá»›i URL áº£nh tháº­t tá»« Unsplash ---
const featuredCourses = [
  {
    id: 1,
    title: "IELTS Foundation: XÃ¢y gá»‘c vá»¯ng cháº¯c cho ngÆ°á»i má»›i",
    instructor: "Ms. Anna",
    price: 3500000,
    imageUrl:
      "https://images.unsplash.com/photo-1543269865-cbf427effbad?q=80&w=800&auto=format&fit=crop",
    level: "Beginner",
  },
  {
    id: 2,
    title: "Giao tiáº¿p thÃ nh tháº¡o: Tá»± tin nÃ³i chuyá»‡n trong 3 thÃ¡ng",
    instructor: "Mr. David",
    price: 2800000,
    imageUrl:
      "https://images.unsplash.com/photo-1557862921-37829c790f19?q=80&w=800&auto=format&fit=crop",
    level: "Intermediate",
  },
  {
    id: 3,
    title: "TOEIC Master: Chinh phá»¥c má»¥c tiÃªu 800+",
    instructor: "Ms. Jenny",
    price: 4200000,
    imageUrl:
      "https://images.unsplash.com/photo-1521737711867-e3b97375f902?q=80&w=800&auto=format&fit=crop",
    level: "Advanced",
  },
];

const testimonials = [
  {
    name: "Minh Anh",
    role: "Sinh viÃªn",
    quote:
      "Lá»™ trÃ¬nh há»c ráº¥t rÃµ rÃ ng vÃ  giáº£ng viÃªn cá»±c ká»³ tÃ¢m huyáº¿t. Em Ä‘Ã£ tÄƒng 1.5 band IELTS chá»‰ sau má»™t khÃ³a há»c!",
    avatarUrl:
      "https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=200&auto=format&fit=crop",
  },
  {
    name: "HoÃ ng Long",
    role: "NhÃ¢n viÃªn vÄƒn phÃ²ng",
    quote:
      "CÃ¡c bÃ i há»c giao tiáº¿p ráº¥t thá»±c táº¿, giÃºp tÃ´i tá»± tin hÆ¡n háº³n trong cÃ¡c cuá»™c há»p vá»›i Ä‘á»‘i tÃ¡c nÆ°á»›c ngoÃ i. Ráº¥t Ä‘Ã¡ng tiá»n!",
    avatarUrl:
      "https://images.unsplash.com/photo-1539571696357-5a69c17a67c6?q=80&w=200&auto=format&fit=crop",
  },
  {
    name: "ThÃ¹y Chi",
    role: "Du há»c sinh",
    quote:
      "Ná»n táº£ng há»c linh hoáº¡t, em cÃ³ thá»ƒ há»c má»i lÃºc má»i nÆ¡i. Nhá» EngBreaking mÃ  em Ä‘Ã£ chuáº©n bá»‹ tá»‘t cho hÃ nh trÃ¬nh du há»c cá»§a mÃ¬nh.",
    avatarUrl:
      "https://images.unsplash.com/photo-1580489944761-15a19d654956?q=80&w=200&auto=format&fit=crop",
  },
];
// --- END OF FAKE DATA ---
export const Logo = () => (
  <Link
    href="/"
    className="flex items-center gap-2 lg:text-lg xl:text-4xl  font-bold text-gray-800"
  >
    <div className="flex -space-x-2.5">
      <div className="w-5 h-7 bg-green-300 rounded-md rotate-[-20deg]"></div>
      <div className="w-5 h-7 bg-blue-300 rounded-md rotate-[-20deg] opacity-90"></div>
    </div>
    <span>EngBreaking</span>
  </Link>
);
// --- SUB-COMPONENTS (CÃ¡c thÃ nh pháº§n con cá»§a trang) ---

// ThÃªm import nÃ y náº¿u chÆ°a cÃ³ á»Ÿ Ä‘áº§u file
export const Header = () => (
  <header className="bg-white sticky top-0 z-50 border-b border-gray-200">
    <div className="flex justify-between items-center h-20 w-full px-[30px] md:px-[100px]">
      {/* 
        px-[30px]: Padding ngang 30px cho mÃ n hÃ¬nh mobile.
        md:px-[50px]: Padding ngang 50px cho mÃ n hÃ¬nh desktop (tá»« breakpoint 'md' trá»Ÿ lÃªn).
        Tailwind JIT compiler sáº½ tá»± Ä‘á»™ng táº¡o ra cÃ¡c class nÃ y.
      */}

      {/* Logo */}
      <Logo />

      {/* Navigation Links - Äáº·t á»Ÿ giá»¯a */}
      <nav className="hidden md:flex items-center gap-8 absolute left-1/2 -translate-x-1/2">
        {/*
          absolute left-1/2 -translate-x-1/2:
          ÄÃ¢y lÃ  ká»¹ thuáº­t CSS kinh Ä‘iá»ƒn Ä‘á»ƒ cÄƒn giá»¯a má»™t pháº§n tá»­ má»™t cÃ¡ch tuyá»‡t Ä‘á»‘i.
        */}
        <Link
          href="/"
          className="text-2xl font-medium text-gray-600 hover:text-primary transition-colors"
        >
          Trang chá»§
        </Link>
        <Link
          href="/courses"
          className="text-2xl font-medium text-gray-600 hover:text-primary transition-colors"
        >
          KhÃ³a há»c
        </Link>
        <Link
          href="//#features"
          className="text-2xl font-medium text-gray-600 hover:text-primary transition-colors"
        >
          Vá» chÃºng tÃ´i
        </Link>
      </nav>

      {/* Auth Buttons */}
      <div className="flex items-center gap-2 ">
        <Link href="/login">
          <Button className="rounded-full text-xl font-semibold bg-green-500 hover:bg-green-600 px-6">
            ÄÄƒng nháº­p
          </Button>
        </Link>
        <Link href="/register">
          <Button className="rounded-full text-xl font-semibold bg-blue-500 hover:bg-blue-600 px-6">
            ÄÄƒng kÃ½
          </Button>
        </Link>
      </div>
    </div>
  </header>
);
const HeroSection = () => (
  <section className="flex flex-col md:flex-row min-h-[calc(100vh-68px)]">
    {/* 
      min-h-[calc(100vh-68px)]: Äáº·t chiá»u cao tá»‘i thiá»ƒu cá»§a section báº±ng chiá»u cao cá»§a viewport trá»« Ä‘i chiá»u cao cá»§a Header.
      Báº¡n cÃ³ thá»ƒ cáº§n Ä‘iá»u chá»‰nh `68px` náº¿u Header cá»§a báº¡n cÃ³ chiá»u cao khÃ¡c. 
    */}

    {/* Pháº§n ná»™i dung text - Chiáº¿m 1/3 */}
    <div className="w-full md:w-1/3 flex items-center justify-center p-8 lg:p-12 bg-green-300">
      <div className="max-w-md w-full text-center md:text-left">
        <h1 className="text-4xl lg:text-5xl font-extrabold text-gray-900 mb-4 leading-tight">
          Chinh phá»¥c Tiáº¿ng Anh ToÃ n diá»‡n, Tá»± tin VÆ°Æ¡n xa
        </h1>
        <p className="text-base text-gray-600 mb-8">
          Ná»n táº£ng há»c trá»±c tuyáº¿n vá»›i lá»™ trÃ¬nh cÃ¡ nhÃ¢n hÃ³a, phÆ°Æ¡ng phÃ¡p thá»±c táº¿
          giÃºp báº¡n giao tiáº¿p lÆ°u loÃ¡t vÃ  Ä‘áº¡t Ä‘iá»ƒm sá»‘ mÆ¡ Æ°á»›c.
        </p>
        <div className="flex flex-col sm:flex-row gap-4 justify-center md:justify-start">
          <Link href="/courses">
            <Button size="lg" className="w-full sm:w-auto">
              KhÃ¡m phÃ¡ khÃ³a há»c
            </Button>
          </Link>
          <a href="#features">
            <Button size="lg" variant="outline" className="w-full sm:w-auto">
              TÃ¬m hiá»ƒu thÃªm
            </Button>
          </a>
        </div>
      </div>
    </div>

    {/* Pháº§n áº£nh ná»n - Chiáº¿m 2/3 */}
    <div className="relative w-full md:w-2/3">
      <Image
        src="/banner.png"
        alt="Online English Academy Banner"
        fill
        style={{ objectFit: "cover" }}
        className="z-0"
        priority // Æ¯u tiÃªn táº£i áº£nh nÃ y Ä‘á»ƒ cáº£i thiá»‡n LCP
      />
      {/* Báº¡n cÃ³ thá»ƒ thÃªm lá»›p phá»§ nháº¹ náº¿u muá»‘n lÃ m dá»‹u áº£nh */}
      {/* <div className="absolute inset-0 bg-black/5"></div> */}
    </div>
  </section>
);

const FeaturesSection = () => (
  <section id="features" className="py-20 bg-white">
    <div className="container mx-auto px-4 text-center">
      <h2 className="text-3xl font-bold mb-4">Táº¡i sao chá»n EngBreaking?</h2>
      <p className="text-muted-foreground mb-12 max-w-2xl mx-auto">
        ChÃºng tÃ´i khÃ´ng chá»‰ dáº¡y ngÃ´n ngá»¯, chÃºng tÃ´i trao cho báº¡n sá»± tá»± tin Ä‘á»ƒ sá»­
        dá»¥ng nÃ³ trong Ä‘á»i thá»±c.
      </p>
      <div className="grid md:grid-cols-3 gap-8">
        <div className="p-6">
          <Award className="h-12 w-12 text-primary mx-auto mb-4" />
          <h3 className="text-xl font-semibold mb-2">Giáº£ng viÃªn ChuyÃªn mÃ´n</h3>
          <p className="text-muted-foreground">
            Äá»™i ngÅ© giáº£ng viÃªn IELTS 8.0+, TESOL, cÃ³ nhiá»u nÄƒm kinh nghiá»‡m giáº£ng
            dáº¡y thá»±c chiáº¿n.
          </p>
        </div>
        <div className="p-6">
          <BookOpenCheck className="h-12 w-12 text-primary mx-auto mb-4" />
          <h3 className="text-xl font-semibold mb-2">Lá»™ trÃ¬nh CÃ¡ nhÃ¢n hÃ³a</h3>
          <p className="text-muted-foreground">
            BÃ i kiá»ƒm tra Ä‘áº§u vÃ o chi tiáº¿t, thiáº¿t káº¿ lá»™ trÃ¬nh há»c riÃªng biá»‡t phÃ¹
            há»£p vá»›i má»¥c tiÃªu vÃ  trÃ¬nh Ä‘á»™ cá»§a báº¡n.
          </p>
        </div>
        <div className="p-6">
          <Clock className="h-12 w-12 text-primary mx-auto mb-4" />
          <h3 className="text-xl font-semibold mb-2">Há»c táº­p Linh hoáº¡t</h3>
          <p className="text-muted-foreground">
            Truy cáº­p bÃ i giáº£ng, tÃ i liá»‡u vÃ  luyá»‡n táº­p má»i lÃºc, má»i nÆ¡i trÃªn má»i
            thiáº¿t bá»‹.
          </p>
        </div>
      </div>
    </div>
  </section>
);

const FeaturedCoursesSection = () => (
  <section className="py-20 bg-gray-50">
    <div className="container mx-auto px-4">
      <h2 className="text-3xl font-bold text-center mb-12">KhÃ³a há»c Ná»•i báº­t</h2>
      <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-8">
        {featuredCourses.map((course) => (
          <Card
            key={course.id}
            className="overflow-hidden hover:shadow-xl transition-shadow duration-300 group"
          >
            <Link href={`/courses`}>
              <div className="relative h-56 w-full">
                <Image
                  src={course.imageUrl}
                  alt={course.title}
                  fill
                  style={{ objectFit: "cover" }}
                  className="group-hover:scale-105 transition-transform duration-300"
                />
              </div>
              <CardContent className="p-6">
                <p className="text-sm text-primary font-semibold mb-2">
                  {course.instructor}
                </p>
                <h3 className="text-lg font-bold mb-4 line-clamp-2 h-14">
                  {course.title}
                </h3>
                <div className="flex justify-between items-center">
                  <p className="text-xl font-bold text-primary">
                    {new Intl.NumberFormat("vi-VN", {
                      style: "currency",
                      currency: "VND",
                    }).format(course.price)}
                  </p>
                  <Button size="sm" asChild>
                    <div className="cursor-pointer">Xem chi tiáº¿t</div>
                  </Button>
                </div>
              </CardContent>
            </Link>
          </Card>
        ))}
      </div>
    </div>
  </section>
);

const TestimonialsSection = () => (
  <section className="py-20 bg-white">
    <div className="container mx-auto px-4">
      <h2 className="text-3xl font-bold text-center mb-12">
        Há»c viÃªn nÃ³i gÃ¬ vá» chÃºng tÃ´i
      </h2>
      <div className="grid md:grid-cols-3 gap-8">
        {testimonials.map((t) => (
          <Card
            key={t.name}
            className="p-6 flex flex-col items-center text-center bg-gray-50 border-gray-200"
          >
            <Avatar className="w-20 h-20 mb-4 border-2 border-primary">
              <AvatarImage src={t.avatarUrl} alt={t.name} />
              <AvatarFallback>{t.name.charAt(0)}</AvatarFallback>
            </Avatar>
            <p className="text-muted-foreground italic mb-4 grow">{t.quote}</p>
            <div className="mt-auto">
              <h4 className="font-semibold">{t.name}</h4>
              <p className="text-sm text-muted-foreground">{t.role}</p>
            </div>
          </Card>
        ))}
      </div>
    </div>
  </section>
);

const StatsBanner = () => (
  <div className="bg-primary text-primary-foreground py-12">
    <div className="container mx-auto grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
      <div>
        <p className="text-4xl font-bold">10,000+</p>
        <p className="opacity-80">Há»c viÃªn</p>
      </div>
      <div>
        <p className="text-4xl font-bold">50+</p>
        <p className="opacity-80">KhÃ³a há»c</p>
      </div>
      <div>
        <p className="text-4xl font-bold">20+</p>
        <p className="opacity-80">Giáº£ng viÃªn</p>
      </div>
      <div>
        <p className="text-4xl font-bold">4.8/5</p>
        <p className="opacity-80">ÄÃ¡nh giÃ¡</p>
      </div>
    </div>
  </div>
);

const FinalCTASection = () => (
  <section className="py-20 text-center bg-gray-50">
    <div className="container mx-auto px-4">
      <h2 className="text-3xl font-bold mb-4">
        Sáºµn sÃ ng Ä‘á»ƒ báº¯t Ä‘áº§u hÃ nh trÃ¬nh cá»§a báº¡n?
      </h2>
      <p className="text-muted-foreground mb-8 max-w-xl mx-auto">
        ÄÄƒng kÃ½ ngay hÃ´m nay Ä‘á»ƒ nháº­n Æ°u Ä‘Ã£i Ä‘áº·c biá»‡t vÃ  báº¯t Ä‘áº§u chinh phá»¥c má»¥c
        tiÃªu tiáº¿ng Anh cá»§a báº¡n!
      </p>
      <Link href="/register">
        <Button size="lg" className="px-10 py-6 text-base">
          ÄÄƒng kÃ½ ngay
        </Button>
      </Link>
    </div>
  </section>
);

const Footer = () => (
  <footer className="bg-gray-900 text-gray-400">
    <div className="container mx-auto px-4 py-12 grid md:grid-cols-4 gap-8">
      <div>
        <h3 className="text-lg font-semibold text-white mb-4">EngBreaking</h3>
        <p className="text-sm">
          Ná»n táº£ng há»c táº­p trá»±c tuyáº¿n chuyÃªn nghiá»‡p, giÃºp báº¡n chinh phá»¥c tiáº¿ng
          Anh má»™t cÃ¡ch hiá»‡u quáº£.
        </p>
      </div>
      <div>
        <h4 className="font-semibold text-white mb-4">KhÃ³a há»c</h4>
        <ul className="space-y-2 text-sm">
          <li>
            <Link href="/courses" className="hover:text-white">
              IELTS
            </Link>
          </li>
          <li>
            <Link href="/courses" className="hover:text-white">
              TOEIC
            </Link>
          </li>
          <li>
            <Link href="/courses" className="hover:text-white">
              Giao tiáº¿p
            </Link>
          </li>
        </ul>
      </div>
      <div>
        <h4 className="font-semibold text-white mb-4">Vá» chÃºng tÃ´i</h4>
        <ul className="space-y-2 text-sm">
          <li>
            <a href="#features" className="hover:text-white">
              Giá»›i thiá»‡u
            </a>
          </li>
          <li>
            <Link href="#" className="hover:text-white">
              LiÃªn há»‡
            </Link>
          </li>
          <li>
            <Link href="#" className="hover:text-white">
              Äiá»u khoáº£n dá»‹ch vá»¥
            </Link>
          </li>
        </ul>
      </div>
      <div>
        <h4 className="font-semibold text-white mb-4">Káº¿t ná»‘i vá»›i chÃºng tÃ´i</h4>
        <p className="text-sm">contact@engbreaking.com</p>
      </div>
    </div>
    <div className="border-t border-gray-800 py-4">
      <p className="container mx-auto text-center text-sm">
        &copy; {new Date().getFullYear()} EngBreaking. All rights reserved.
      </p>
    </div>
  </footer>
);

// --- MAIN HOME PAGE COMPONENT ---
export default function HomePage() {
  const router = useRouter();

  // Giá»¯ láº¡i logic chuyá»ƒn hÆ°á»›ng náº¿u Ä‘Ã£ Ä‘Äƒng nháº­p
  useEffect(() => {
    const user = getStoredUser();
    if (user) {
      router.push(`/${user.role}/dashboard`);
    }
  }, [router]);

  return (
    <div className="bg-white">
      <Header />
      <main>
        <HeroSection />
        <FeaturesSection />
        <FeaturedCoursesSection />
        <TestimonialsSection />
        <StatsBanner />
        <FinalCTASection />
      </main>
      <Footer />
    </div>
  );
}


//(auth)\layout.tsx
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";
import { useAuth } from "@/lib/hooks/useAuth";
import { Logo } from "@/app/page";
import { Loader2 } from "lucide-react";

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const { user, isLoading } = useAuth();
  const router = useRouter();

  useEffect(() => {
    if (!isLoading && user) {
      router.replace(`/${user.role}/dashboard`);
    }
  }, [isLoading, user, router]);

  if (isLoading || user) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-linear-to-br from-blue-50 via-white to-indigo-50">
        <div className="text-center">
          <Loader2 className="h-16 w-16 animate-spin text-blue-600 mx-auto" />
          <p className="mt-6 text-lg text-gray-600 font-medium">Äang táº£i...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-linear-to-br from-blue-50 via-white to-indigo-50 p-6">
      <div className="w-full  max-w-2xl">
        <div className="bg-white rounded-3xl shadow-2xl p-12 lg:p-16 border border-gray-100">
          {/* Logo */}
          <div className="mb-12 flex justify-center items-center">
            <Logo />
          </div>

          {/* Form Content */}
          {children}
        </div>
      </div>
    </div>
  );
}


//(auth)\login\page.tsx
"use client";

import { useState } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import Link from "next/link";
import { useForm } from "react-hook-form";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { toast } from "sonner";
import { authService } from "@/lib/api/authService";
import { setAuthData } from "@/lib/auth/utils";
import { LogIn, Loader2, Mail, Lock, Info } from "lucide-react";
import { LoginRequest } from "@/lib/types";

type LoginFormData = LoginRequest;

export default function LoginPage() {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const searchParams = useSearchParams();
  const form = useForm<LoginFormData>({
    defaultValues: {
      email: "",
      password: "",
    },
  });

  const onSubmit = async (data: LoginFormData) => {
    setIsLoading(true);
    try {
      const authData = await authService.login(data);
      setAuthData(authData.token, authData.user);
      toast.success(`ÄÄƒng nháº­p thÃ nh cÃ´ng! ChÃ o ${authData.user.full_name}`);

      const redirectUrl = searchParams.get("redirect");

      if (redirectUrl) {
        router.replace(redirectUrl);
      } else {
        const { role } = authData.user;
        if (role === "student") {
          router.replace("/student/dashboard");
        } else if (role === "instructor") {
          router.replace("/instructor/dashboard");
        } else {
          router.replace("/admin/dashboard");
        }
      }
    } catch (error: unknown) {
      const errorMessage =
        error instanceof Error
          ? error.message
          : "ÄÄƒng nháº­p tháº¥t báº¡i. Vui lÃ²ng thá»­ láº¡i.";
      toast.error(errorMessage);
    } finally {
      setIsLoading(false);
    }
  };

  const redirectQuery = searchParams.get("redirect");

  return (
    <div className="w-full">
      {/* Header */}
      <div className="mb-12">
        <h2 className="text-5xl font-bold text-gray-900 tracking-tight">
          ChÃ o má»«ng trá»Ÿ láº¡i
        </h2>
        <p className="mt-4 text-2xl text-gray-600">
          ÄÄƒng nháº­p Ä‘á»ƒ tiáº¿p tá»¥c há»c táº­p vÃ  phÃ¡t triá»ƒn
        </p>
      </div>

      {/* Demo Accounts Alert */}
      <Alert className="mb-5 border-blue-200 bg-linear-to-r from-blue-50 to-indigo-50 p-6">
        <Info className="h-6 w-6 text-blue-600" />
        <AlertDescription className="text-lg text-gray-700 ml-3">
          <p className="font-semibold mb-5 text-gray-900 text-xl">
            TÃ i khoáº£n demo:
          </p>
          <div className="space-y-4">
            <div className="flex items-start gap-4">
              <span className="text-3xl">ðŸ‘¨â€ðŸŽ“</span>
              <div className="flex-1">
                <p className="font-medium text-gray-800 text-lg">Há»c viÃªn</p>
                <p className="text-base text-gray-600">
                  student@gmail.com / password
                </p>
              </div>
            </div>
            <div className="flex items-start gap-4">
              <span className="text-3xl">ðŸ‘¨â€ðŸ«</span>
              <div className="flex-1">
                <p className="font-medium text-gray-800 text-lg">Giáº£ng viÃªn</p>
                <p className="text-base text-gray-600">
                  teacher@gmail.com / password
                </p>
              </div>
            </div>
            <div className="flex items-start gap-4">
              <span className="text-3xl">âš™ï¸</span>
              <div className="flex-1">
                <p className="font-medium text-gray-800 text-lg">
                  Quáº£n trá»‹ viÃªn
                </p>
                <p className="text-base text-gray-600">
                  sysadmin@englearning.test / Password123!
                </p>
              </div>
            </div>
            <div className="flex items-start gap-4">
              <span className="text-3xl">âš™ï¸</span>
              <div className="flex-1">
                <p className="font-medium text-gray-800 text-lg">
                  Quáº£n trá»‹ viÃªn
                </p>
                <p className="text-base text-gray-600">
                  support@englearning.test / Password123!
                </p>
              </div>
            </div>
          </div>
        </AlertDescription>
      </Alert>

      {/* Login Form */}
      <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-8">
          <FormField
            control={form.control}
            name="email"
            rules={{
              required: "Email khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.",
              pattern: {
                value: /^\S+@\S+$/i,
                message: "Email khÃ´ng há»£p lá»‡.",
              },
            }}
            render={({ field }) => (
              <FormItem>
                <FormLabel className="text-3xl font-semibold text-gray-900 mb-3 block">
                  Email
                </FormLabel>
                <FormControl>
                  <div className="relative">
                    <Mail className="absolute left-5 top-1/2 -translate-y-1/2 h-7 w-7 text-gray-400" />
                    <Input
                      placeholder="your@email.com"
                      type="email"
                      disabled={isLoading}
                      className="pl-16 h-20 text-2xl md:text-2xl border-2 border-gray-300 focus:border-blue-500 focus:ring-blue-500 rounded-2xl transition-all"
                      {...field}
                    />
                  </div>
                </FormControl>
                <FormMessage className="text-base mt-2" />
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="password"
            rules={{
              required: "Máº­t kháº©u khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.",
              minLength: { value: 1, message: "Vui lÃ²ng nháº­p máº­t kháº©u." },
            }}
            render={({ field }) => (
              <FormItem>
                <FormLabel className="text-3xl font-semibold text-gray-900 mb-3 block">
                  Máº­t kháº©u
                </FormLabel>
                <FormControl>
                  <div className="relative">
                    <Lock className="absolute left-5 top-1/2 -translate-y-1/2 h-7 w-7 text-gray-400" />
                    <Input
                      placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                      type="password"
                      disabled={isLoading}
                      className="pl-16 h-20 text-2xl md:text-2xl border-2 border-gray-300 focus:border-blue-500 focus:ring-blue-500 rounded-2xl transition-all"
                      {...field}
                    />
                  </div>
                </FormControl>
                <FormMessage className="text-base mt-2" />
              </FormItem>
            )}
          />

          <Button
            type="submit"
            disabled={isLoading}
            className="w-full h-20 text-2xl bg-linear-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5 mt-4"
            size="lg"
          >
            {isLoading ? (
              <>
                <Loader2 className="mr-3 h-7 w-7 animate-spin" />
                Äang Ä‘Äƒng nháº­p...
              </>
            ) : (
              <>
                <LogIn className="mr-3 h-7 w-7" />
                ÄÄƒng nháº­p
              </>
            )}
          </Button>
        </form>
      </Form>

      {/* Divider */}
      <div className="relative my-12">
        <div className="absolute inset-0 flex items-center">
          <div className="w-full border-t-2 border-gray-200"></div>
        </div>
        <div className="relative flex justify-center text-xl">
          <span className="px-6 bg-white text-gray-500 font-medium">
            ChÆ°a cÃ³ tÃ i khoáº£n?
          </span>
        </div>
      </div>

      {/* Register Link */}
      <div className="text-center">
        <Link
          href={`/register${redirectQuery ? `?redirect=${redirectQuery}` : ""}`}
          className="inline-flex items-center justify-center w-full h-20 px-8 text-2xl font-semibold text-blue-600 bg-blue-50 border-2 border-blue-200 rounded-2xl hover:bg-blue-100 hover:border-blue-300 transition-all duration-200 transform hover:-translate-y-0.5"
        >
          ÄÄƒng kÃ½ tÃ i khoáº£n má»›i
        </Link>
      </div>
    </div>
  );
}


//(auth)\register\page.tsx
"use client";

import { useState } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import Link from "next/link";
import { useForm } from "react-hook-form";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { toast } from "sonner";
import { authService } from "@/lib/api/authService";
import { setAuthData } from "@/lib/auth/utils";
import { UserPlus, Loader2, Mail, Lock, User, Briefcase } from "lucide-react";
import { RegisterRequest } from "@/lib/types";

type RegisterFormData = RegisterRequest;

export default function RegisterPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<RegisterFormData>({
    defaultValues: {
      full_name: "",
      email: "",
      password: "",
      role: "student",
    },
  });

  const onSubmit = async (data: RegisterFormData) => {
    setIsLoading(true);
    try {
      const authData = await authService.register(data);
      setAuthData(authData.token, authData.user);
      toast.success(`ÄÄƒng kÃ½ thÃ nh cÃ´ng! ChÃ o ${authData.user.full_name}`);

      const redirectUrl = searchParams.get("redirect");

      if (redirectUrl) {
        router.replace(redirectUrl);
      } else {
        const { role } = authData.user;
        if (role === "student") {
          router.replace("/student/dashboard");
        } else if (role === "instructor") {
          router.replace("/instructor/dashboard");
        }
      }
    } catch (error: unknown) {
      const errorMessage =
        error instanceof Error
          ? error.message
          : "ÄÄƒng kÃ½ tháº¥t báº¡i. Vui lÃ²ng thá»­ láº¡i.";
      toast.error(errorMessage);
    } finally {
      setIsLoading(false);
    }
  };

  const redirectQuery = searchParams.get("redirect");

  return (
    <div className="w-full">
      {/* Header */}
      <div className="mb-12">
        <h2 className="text-5xl font-bold text-gray-900 tracking-tight">
          Báº¯t Ä‘áº§u hÃ nh trÃ¬nh
        </h2>
        <p className="mt-4 text-2xl text-gray-600">
          Táº¡o tÃ i khoáº£n Ä‘á»ƒ khÃ¡m phÃ¡ tráº£i nghiá»‡m há»c táº­p tuyá»‡t vá»i
        </p>
      </div>

      {/* Register Form */}
      <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-8">
          <FormField
            control={form.control}
            name="full_name"
            rules={{
              required: "Há» tÃªn khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.",
              minLength: {
                value: 3,
                message: "Há» tÃªn pháº£i cÃ³ Ã­t nháº¥t 3 kÃ½ tá»±.",
              },
            }}
            render={({ field }) => (
              <FormItem>
                <FormLabel className="text-3xl font-semibold text-gray-900 mb-3 block">
                  Há» vÃ  tÃªn
                </FormLabel>
                <FormControl>
                  <div className="relative">
                    <User className="absolute left-5 top-1/2 -translate-y-1/2 h-7 w-7 text-gray-400" />
                    <Input
                      placeholder="Nguyá»…n VÄƒn A"
                      disabled={isLoading}
                      className="pl-16 h-20 text-2xl border-2 border-gray-300 focus:border-blue-500 focus:ring-blue-500 rounded-2xl transition-all"
                      {...field}
                    />
                  </div>
                </FormControl>
                <FormMessage className="text-base mt-2" />
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="email"
            rules={{
              required: "Email khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.",
              pattern: {
                value: /^\S+@\S+$/i,
                message: "Email khÃ´ng há»£p lá»‡.",
              },
            }}
            render={({ field }) => (
              <FormItem>
                <FormLabel className="text-3xl font-semibold text-gray-900 mb-3 block">
                  Email
                </FormLabel>
                <FormControl>
                  <div className="relative">
                    <Mail className="absolute left-5 top-1/2 -translate-y-1/2 h-7 w-7 text-gray-400" />
                    <Input
                      placeholder="your@email.com"
                      type="email"
                      disabled={isLoading}
                      className="pl-16 h-20 text-2xl border-2 border-gray-300 focus:border-blue-500 focus:ring-blue-500 rounded-2xl transition-all"
                      {...field}
                    />
                  </div>
                </FormControl>
                <FormMessage className="text-base mt-2" />
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="password"
            rules={{
              required: "Máº­t kháº©u khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.",
              minLength: {
                value: 6,
                message: "Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±.",
              },
            }}
            render={({ field }) => (
              <FormItem>
                <FormLabel className="text-3xl font-semibold text-gray-900 mb-3 block">
                  Máº­t kháº©u
                </FormLabel>
                <FormControl>
                  <div className="relative">
                    <Lock className="absolute left-5 top-1/2 -translate-y-1/2 h-7 w-7 text-gray-400" />
                    <Input
                      placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                      type="password"
                      disabled={isLoading}
                      className="pl-16 h-20 text-2xl border-2 border-gray-300 focus:border-blue-500 focus:ring-blue-500 rounded-2xl transition-all"
                      {...field}
                    />
                  </div>
                </FormControl>
                <FormMessage className="text-base mt-2" />
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="role"
            rules={{ required: "Vui lÃ²ng chá»n vai trÃ²." }}
            render={({ field }) => (
              <FormItem>
                <FormLabel className="text-3xl font-semibold text-gray-900 mb-3 block">
                  Báº¡n lÃ ?
                </FormLabel>
                <Select
                  onValueChange={field.onChange}
                  defaultValue={field.value}
                  disabled={isLoading}
                >
                  <FormControl>
                    <div className="relative">
                      <Briefcase className="absolute left-5 top-1/2 -translate-y-1/2 h-7 w-7 text-gray-400 z-10 pointer-events-none" />
                      <SelectTrigger className="pl-16 h-20 text-2xl border-2 border-gray-300 focus:border-blue-500 focus:ring-blue-500 rounded-2xl">
                        <SelectValue placeholder="Chá»n vai trÃ²" />
                      </SelectTrigger>
                    </div>
                  </FormControl>
                  <SelectContent>
                    <SelectItem
                      value="student"
                      className="cursor-pointer text-xl py-4"
                    >
                      <div className="flex items-center gap-4">
                        <span className="text-3xl">ðŸ‘¨â€ðŸŽ“</span>
                        <span>TÃ´i lÃ  há»c viÃªn</span>
                      </div>
                    </SelectItem>
                    <SelectItem
                      value="instructor"
                      className="cursor-pointer text-xl py-4"
                    >
                      <div className="flex items-center gap-4">
                        <span className="text-3xl">ðŸ‘¨â€ðŸ«</span>
                        <span>TÃ´i lÃ  giáº£ng viÃªn</span>
                      </div>
                    </SelectItem>
                  </SelectContent>
                </Select>
                <FormMessage className="text-base mt-2" />
              </FormItem>
            )}
          />

          <Button
            type="submit"
            disabled={isLoading}
            className="w-full h-20 text-2xl bg-linear-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5 mt-4"
            size="lg"
          >
            {isLoading ? (
              <>
                <Loader2 className="mr-3 h-7 w-7 animate-spin" />
                ÄÄƒng kÃ½...
              </>
            ) : (
              <>
                <UserPlus className="mr-3 h-7 w-7" />
                ÄÄƒng kÃ½
              </>
            )}
          </Button>
        </form>
      </Form>

      {/* Divider */}
      <div className="relative my-12">
        <div className="absolute inset-0 flex items-center">
          <div className="w-full border-t-2 border-gray-200"></div>
        </div>
        <div className="relative flex justify-center text-xl">
          <span className="px-6 bg-white text-gray-500 font-medium">
            ÄÃ£ cÃ³ tÃ i khoáº£n?
          </span>
        </div>
      </div>

      {/* Login Link */}
      <div className="text-center">
        <Link
          href={`/login${redirectQuery ? `?redirect=${redirectQuery}` : ""}`}
          className="inline-flex items-center justify-center w-full h-20 px-8 text-2xl font-semibold text-blue-600 bg-blue-50 border-2 border-blue-200 rounded-2xl hover:bg-blue-100 hover:border-blue-300 transition-all duration-200 transform hover:-translate-y-0.5"
        >
          ÄÄƒng nháº­p ngay
        </Link>
      </div>
    </div>
  );
}


//(protected)\admin\layout.tsx
// admin/layout.tsx
"use client";

import Link from "next/link";
import { usePathname, useRouter } from "next/navigation";
import {
  LayoutDashboard,
  Users,
  BookCopy,
  UserCheck,
  CreditCard,
  Settings,
  LogOut,
  LifeBuoy,
  User,
} from "lucide-react";
import { cn } from "@/lib/utils";
import { useAuth } from "@/lib/hooks/useAuth";
import { clearAuthData } from "@/lib/auth/utils";
import { Button } from "@/components/ui/button";
import { Logo } from "@/app/page";
import { useEffect } from "react";

const navItems = [
  { href: "/admin/dashboard", icon: LayoutDashboard, label: "Tá»•ng quan" },
  { href: "/admin/users", icon: Users, label: "NgÆ°á»i dÃ¹ng" },
  { href: "/admin/courses", icon: BookCopy, label: "KhÃ³a há»c" },
  { href: "/admin/instructors", icon: UserCheck, label: "Giáº£ng viÃªn" },
  { href: "/admin/transactions", icon: CreditCard, label: "Giao dá»‹ch" },
  { href: "/admin/support", icon: LifeBuoy, label: "Há»— trá»£" },
  { href: "/admin/settings", icon: Settings, label: "CÃ i Ä‘áº·t" },
];

const NavLink = ({ item }: { item: (typeof navItems)[0] }) => {
  const pathname = usePathname();
  const isActive = pathname.startsWith(item.href);
  return (
    <Link
      href={item.href}
      className={cn(
        "flex items-center gap-3 rounded-lg px-3 py-2 text-gray-700 transition-all hover:bg-gray-200",
        isActive && "bg-gray-900 text-white hover:bg-gray-800 hover:text-white"
      )}
    >
      <item.icon className="h-4 w-4" />
      {item.label}
    </Link>
  );
};

export default function AdminLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const { user, isLoading } = useAuth({ redirectToLoginIfFail: true });
  const router = useRouter();

  useEffect(() => {
    if (!isLoading && user && !user.role.includes("admin")) {
      router.replace(`/${user.role}/dashboard`);
    }
  }, [isLoading, user, router]);

  if (isLoading || !user) {
    return <div>Loading...</div>;
  }

  return (
    <div className="grid min-h-screen w-full lg:grid-cols-[280px_1fr]">
      <aside className="hidden border-r bg-white lg:block">
        <div className="flex h-full max-h-screen flex-col gap-2">
          <div className="flex h-20 items-center border-b px-6">
            <Logo />
          </div>
          <div className="flex-1 overflow-auto py-2">
            <nav className="grid items-start px-4 text-sm font-medium">
              {navItems.map((item) => (
                <NavLink key={item.href} item={item} />
              ))}
            </nav>
          </div>
        </div>
      </aside>

      <div className="flex flex-col">
        <header className="flex h-20 items-center gap-4 border-b bg-white px-6">
          <div className="flex-1">
            <h1 className="font-semibold text-lg text-gray-800">
              Admin Control Panel
            </h1>
          </div>
          <div className="flex items-center gap-2 text-sm font-semibold">
            <User className="h-5 w-5 text-gray-700" />
            <span>{user.full_name}</span>
          </div>
          <Button
            onClick={() => {
              clearAuthData();
              router.push("/");
            }}
            variant="destructive"
            size="sm"
          >
            <LogOut className="mr-2 h-4 w-4" /> ÄÄƒng xuáº¥t
          </Button>
        </header>

        <main className="flex flex-1 flex-col gap-4 p-4 md:gap-8 md:p-6 bg-brand-background">
          {children}
        </main>
      </div>
    </div>
  );
}


//(protected)\admin\courses\page.tsx
"use client";

import { useState, useEffect, useCallback } from "react";
import { toast } from "sonner";
import { courseService } from "@/lib/api/courseService";
import { Course, CourseStatus } from "@/lib/types";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import Link from "next/link";
import { CheckCircle, XCircle } from "lucide-react";

const CourseReviewSkeleton = () => (
  <div className="space-y-4">
    {[...Array(3)].map((_, i) => (
      <Card key={i}>
        <CardHeader>
          <Skeleton className="h-6 w-2/3" />
          <Skeleton className="h-4 w-1/3 mt-2" />
        </CardHeader>
        <CardContent>
          <Skeleton className="h-10 w-full" />
        </CardContent>
      </Card>
    ))}
  </div>
);

export default function AdminCoursesReviewPage() {
  const [pendingCourses, setPendingCourses] = useState<Course[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isMutating, setIsMutating] = useState<number | null>(null);

  const fetchPendingCourses = useCallback(async () => {
    setIsLoading(true);
    try {
      const response = await courseService.listCourses({
        approval_status: "pending",
      });
      setPendingCourses(response.data);
    } catch (error) {
      toast.error(
        error instanceof Error
          ? error.message
          : "Lá»—i khi táº£i danh sÃ¡ch khÃ³a há»c."
      );
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchPendingCourses();
  }, [fetchPendingCourses]);

  const handleReview = async (courseId: number, isApproved: boolean) => {
    setIsMutating(courseId);
    let rejectionReason: string | null = null;

    if (!isApproved) {
      rejectionReason = prompt("Vui lÃ²ng nháº­p lÃ½ do tá»« chá»‘i:");
      if (!rejectionReason) {
        toast.info("HÃ nh Ä‘á»™ng Ä‘Ã£ Ä‘Æ°á»£c há»§y.");
        setIsMutating(null);
        return;
      }
    }

    try {
      await courseService.changeCourseStatus(courseId, {
        status: isApproved ? "published" : "rejected",
        approval_status: isApproved ? "approved" : "rejected",
        rejection_reason: rejectionReason || undefined,
      });
      toast.success(
        `ÄÃ£ ${isApproved ? "phÃª duyá»‡t" : "tá»« chá»‘i"} khÃ³a há»c thÃ nh cÃ´ng!`
      );
      fetchPendingCourses(); // Táº£i láº¡i danh sÃ¡ch
    } catch (error) {
      toast.error(
        error instanceof Error ? error.message : "Thao tÃ¡c tháº¥t báº¡i."
      );
    } finally {
      setIsMutating(null);
    }
  };

  return (
    <div className="container mx-auto py-8">
      <h1 className="text-3xl font-bold mb-2">Duyá»‡t ná»™i dung khÃ³a há»c</h1>
      <p className="text-muted-foreground mb-8">
        CÃ¡c khÃ³a há»c Ä‘ang chá» Ä‘Æ°á»£c xem xÃ©t vÃ  xuáº¥t báº£n.
      </p>

      {isLoading ? (
        <CourseReviewSkeleton />
      ) : pendingCourses.length > 0 ? (
        <div className="space-y-6">
          {pendingCourses.map((course) => (
            <Card key={course.course_id}>
              <CardHeader>
                <div className="flex justify-between items-start">
                  <div>
                    <CardTitle className="text-xl">{course.title}</CardTitle>
                    <CardDescription>
                      Bá»Ÿi {course.instructor?.full_name} -
                      <Link
                        href={`/instructor/courses/${course.course_id}`}
                        className="ml-2 text-blue-600 hover:underline"
                      >
                        Xem chi tiáº¿t
                      </Link>
                    </CardDescription>
                  </div>
                  <Badge variant="secondary">{course.approval_status}</Badge>
                </div>
              </CardHeader>
              <CardContent className="flex gap-4">
                <Button
                  size="sm"
                  onClick={() => handleReview(course.course_id, true)}
                  disabled={isMutating === course.course_id}
                >
                  <CheckCircle className="mr-2 h-4 w-4" /> PhÃª duyá»‡t & Xuáº¥t báº£n
                </Button>
                <Button
                  variant="destructive"
                  size="sm"
                  onClick={() => handleReview(course.course_id, false)}
                  disabled={isMutating === course.course_id}
                >
                  <XCircle className="mr-2 h-4 w-4" /> Tá»« chá»‘i
                </Button>
              </CardContent>
            </Card>
          ))}
        </div>
      ) : (
        <div className="text-center py-16 border rounded-lg bg-gray-50">
          <h3 className="text-xl font-semibold">
            KhÃ´ng cÃ³ khÃ³a há»c nÃ o chá» duyá»‡t
          </h3>
          <p className="text-muted-foreground mt-2">
            Má»i thá»© Ä‘á»u Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½!
          </p>
        </div>
      )}
    </div>
  );
}


//(protected)\admin\dashboard\page.tsx
"use client";

import { useState, useEffect } from "react";
import Link from "next/link";
import { toast } from "sonner";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import {
  Users,
  BookOpen,
  CreditCard,
  UserCheck,
  FileClock,
  BarChart3,
} from "lucide-react";
import { useAuth } from "@/lib/hooks/useAuth";
import { adminService } from "@/lib/api/adminService";
import { cn } from "@/lib/utils";

interface DashboardSummary {
  total_users: number;
  total_courses: number;
  pending_courses: number;
  pending_instructors: number;
  total_enrollments: number;
  total_revenue: number;
}

const StatCard = ({
  title,
  value,
  icon: Icon,
  isLoading,
  formatAsCurrency = false,
  href,
  colorClass,
}: {
  title: string;
  value: string | number;
  icon: React.ElementType;
  isLoading: boolean;
  formatAsCurrency?: boolean;
  href?: string;
  colorClass?: string;
}) => {
  const displayValue =
    formatAsCurrency && typeof value === "number"
      ? new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(value)
      : value.toLocaleString("vi-VN");

  const CardContentComponent = (
    <Card
      className={cn(
        "transition-all hover:shadow-lg hover:-translate-y-1",
        colorClass
      )}
    >
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-sm font-medium text-gray-600">
          {title}
        </CardTitle>
        <Icon className="h-4 w-4 text-muted-foreground" />
      </CardHeader>
      <CardContent>
        {isLoading ? (
          <Skeleton className="h-8 w-3/4" />
        ) : (
          <div className="text-2xl font-bold">{displayValue}</div>
        )}
      </CardContent>
    </Card>
  );

  return href ? (
    <Link href={href}>{CardContentComponent}</Link>
  ) : (
    CardContentComponent
  );
};

export default function AdminDashboardPage() {
  const { user } = useAuth();
  const [summary, setSummary] = useState<DashboardSummary | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const fetchSummary = async () => {
      try {
        setIsLoading(true);
        const data = await adminService.getDashboardSummary();
        setSummary(data);
      } catch (error) {
        toast.error(
          error instanceof Error
            ? error.message
            : "KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u dashboard."
        );
      } finally {
        setIsLoading(false);
      }
    };
    fetchSummary();
  }, []);

  return (
    <div className="space-y-8">
      <div className="bg-white rounded-lg border p-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-2">
          ChÃ o má»«ng, {user?.full_name || "Admin"}! ðŸ‘‘
        </h1>
        <p className="text-gray-600">
          Tá»•ng quan tÃ¬nh hÃ¬nh hoáº¡t Ä‘á»™ng cá»§a ná»n táº£ng EngBreaking.
        </p>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <StatCard
          title="Tá»•ng Doanh thu"
          value={summary?.total_revenue || 0}
          icon={CreditCard}
          isLoading={isLoading}
          formatAsCurrency={true}
          href="/admin/transactions"
        />
        <StatCard
          title="Tá»•ng NgÆ°á»i dÃ¹ng"
          value={summary?.total_users || 0}
          icon={Users}
          isLoading={isLoading}
          href="/admin/users"
        />
        <StatCard
          title="Tá»•ng KhÃ³a há»c"
          value={summary?.total_courses || 0}
          icon={BookOpen}
          isLoading={isLoading}
          href="/admin/courses"
        />
        <StatCard
          title="Tá»•ng LÆ°á»£t ghi danh"
          value={summary?.total_enrollments || 0}
          icon={BarChart3}
          isLoading={isLoading}
        />
        <StatCard
          title="GV Chá» duyá»‡t"
          value={summary?.pending_instructors || 0}
          icon={UserCheck}
          isLoading={isLoading}
          href="/admin/instructors"
          colorClass="bg-yellow-100 border-yellow-300 ring-2 ring-yellow-400"
        />
        <StatCard
          title="KhÃ³a há»c Chá» duyá»‡t"
          value={summary?.pending_courses || 0}
          icon={FileClock}
          isLoading={isLoading}
          href="/admin/courses"
          colorClass="bg-yellow-100 border-yellow-300 ring-2 ring-yellow-400"
        />
      </div>

      {/* ThÃªm cÃ¡c section má»›i */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <Card>
          <CardHeader>
            <CardTitle>Biá»ƒu Ä‘á»“ TÄƒng trÆ°á»Ÿng Doanh thu</CardTitle>
            <CardDescription>Dá»¯ liá»‡u giáº£ láº­p 6 thÃ¡ng gáº§n nháº¥t</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="h-72 bg-gray-100 rounded-md flex items-center justify-center">
              <p className="text-muted-foreground">
                [Biá»ƒu Ä‘á»“ sáº½ Ä‘Æ°á»£c hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y]
              </p>
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader>
            <CardTitle>Hoáº¡t Ä‘á»™ng gáº§n Ä‘Ã¢y</CardTitle>
            <CardDescription>
              CÃ¡c sá»± kiá»‡n má»›i nháº¥t trÃªn há»‡ thá»‘ng
            </CardDescription>
          </CardHeader>
          <CardContent>
            <ul className="space-y-3 text-sm">
              <li className="flex items-start gap-3">
                <div className="bg-green-100 p-2 rounded-full">
                  <Users className="h-4 w-4 text-green-600" />
                </div>
                <p className="text-gray-700">
                  NgÆ°á»i dÃ¹ng má»›i
                  <span className="font-semibold">Tráº§n VÄƒn An</span> vá»«a Ä‘Äƒng
                  kÃ½.
                </p>
              </li>
              <li className="flex items-start gap-3">
                <div className="bg-blue-100 p-2 rounded-full">
                  <BookOpen className="h-4 w-4 text-blue-600" />
                </div>
                <p className="text-gray-700">
                  KhÃ³a há»c
                  <span className="font-semibold">IELTS Speaking Master</span>
                  vá»«a cÃ³ 1 lÆ°á»£t ghi danh má»›i.
                </p>
              </li>
              <li className="flex items-start gap-3">
                <div className="bg-yellow-100 p-2 rounded-full">
                  <UserCheck className="h-4 w-4 text-yellow-600" />
                </div>
                <p className="text-gray-700">
                  Giáº£ng viÃªn <span className="font-semibold">LÃª Thá»‹ BÃ­ch</span>
                  vá»«a ná»™p há»“ sÆ¡ chá» duyá»‡t.
                </p>
              </li>
            </ul>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}


//(protected)\admin\instructors\page.tsx
"use client";

import { useState, useEffect, useCallback } from "react";
import { toast } from "sonner";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { instructorService } from "@/lib/api/instructorService";
import { InstructorProfile } from "@/lib/types";
import { Skeleton } from "@/components/ui/skeleton";
import { CheckCircle2, XCircle } from "lucide-react";

const InstructorSkeleton = () => (
  <div className="space-y-4">
    {[...Array(3)].map((_, i) => (
      <Card key={i}>
        <CardHeader>
          <Skeleton className="h-6 w-1/3" />
          <Skeleton className="h-4 w-1/2 mt-2" />
        </CardHeader>
        <CardContent>
          <div className="space-y-2">
            <Skeleton className="h-4 w-full" />
            <Skeleton className="h-4 w-2/3" />
          </div>
        </CardContent>
      </Card>
    ))}
  </div>
);

export default function AdminInstructorsPage() {
  const [profiles, setProfiles] = useState<InstructorProfile[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isMutating, setIsMutating] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // âœ… ThÃªm state phÃ¢n trang
  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [total, setTotal] = useState(0);

  // âœ… Fetch API
  const fetchPendingProfiles = useCallback(async () => {
    setIsLoading(true);
    setError(null);
    try {
      const response = await instructorService.listProfiles({
        page,
        limit: 5, // giá»›i háº¡n má»—i trang 5 há»“ sÆ¡
        status: "pending",
      });

      // âœ… Dá»¯ liá»‡u láº¥y tá»« API Ä‘Ã£ sá»­a trong instructorService
      setProfiles(response.data);
      setTotal(response.meta.total || 0);
      setTotalPages(response.meta.total_pages || 1);
    } catch (err) {
      const errorMessage =
        err instanceof Error ? err.message : "KhÃ´ng thá»ƒ táº£i danh sÃ¡ch.";
      setError(errorMessage);
      toast.error(errorMessage);
      setProfiles([]);
      setTotal(0);
      setTotalPages(1);
    } finally {
      setIsLoading(false);
    }
  }, [page]);

  useEffect(() => {
    fetchPendingProfiles();
  }, [fetchPendingProfiles]);

  // âœ… Duyá»‡t vÃ  tá»« chá»‘i
  const handleApprove = async (profileId: number) => {
    setIsMutating(true);
    try {
      await instructorService.reviewProfile(profileId, "approved");
      toast.success("Há»“ sÆ¡ Ä‘Ã£ Ä‘Æ°á»£c cháº¥p thuáº­n!");
      fetchPendingProfiles();
    } catch (err) {
      toast.error(err instanceof Error ? err.message : "CÃ³ lá»—i xáº£y ra.");
    } finally {
      setIsMutating(false);
    }
  };

  const handleReject = async (profileId: number) => {
    const reason = prompt("Vui lÃ²ng nháº­p lÃ½ do tá»« chá»‘i:");
    if (!reason) {
      toast.info("HÃ nh Ä‘á»™ng Ä‘Ã£ Ä‘Æ°á»£c há»§y.");
      return;
    }
    setIsMutating(true);
    try {
      await instructorService.reviewProfile(profileId, "rejected", reason);
      toast.success("Há»“ sÆ¡ Ä‘Ã£ bá»‹ tá»« chá»‘i.");
      fetchPendingProfiles();
    } catch (err) {
      toast.error(err instanceof Error ? err.message : "CÃ³ lá»—i xáº£y ra.");
    } finally {
      setIsMutating(false);
    }
  };

  // âœ… Render danh sÃ¡ch
  const renderContent = () => {
    if (isLoading && profiles.length === 0) {
      return <InstructorSkeleton />;
    }

    if (error) {
      return (
        <div className="text-red-600 text-center py-10 bg-red-50 rounded-md">
          {error}
        </div>
      );
    }

    if (!profiles || profiles.length === 0) {
      return (
        <div className="text-center py-16 border rounded-lg bg-gray-50">
          <h3 className="text-xl font-semibold">
            KhÃ´ng cÃ³ há»“ sÆ¡ nÃ o chá» duyá»‡t
          </h3>
          <p className="text-muted-foreground mt-2">
            Má»i thá»© Ä‘á»u Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½!
          </p>
        </div>
      );
    }

    return (
      <div className="space-y-6">
        {profiles.map((profile) => (
          <Card key={profile.profile_id}>
            <CardHeader>
              <div className="flex justify-between items-start">
                <div>
                  <CardTitle className="text-xl">
                    {profile.user?.full_name}
                  </CardTitle>
                  <CardDescription>{profile.user?.email}</CardDescription>
                </div>
                <Badge variant="secondary">{profile.approval_status}</Badge>
              </div>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <div>
                  <h4 className="font-semibold text-sm">Bio</h4>
                  <p className="text-sm text-muted-foreground">
                    {profile.bio || "N/A"}
                  </p>
                </div>
                <div>
                  <h4 className="font-semibold text-sm">Há»c váº¥n</h4>
                  <p className="text-sm text-muted-foreground">
                    {profile.education || "N/A"}
                  </p>
                </div>
                <div>
                  <h4 className="font-semibold text-sm">Kinh nghiá»‡m</h4>
                  <p className="text-sm text-muted-foreground">
                    {profile.experience || "N/A"}
                  </p>
                </div>
              </div>

              <div className="flex gap-4 mt-6 pt-4 border-t">
                <Button
                  size="sm"
                  onClick={() => handleApprove(profile.profile_id)}
                  disabled={isMutating}
                >
                  <CheckCircle2 className="mr-2 h-4 w-4" /> Cháº¥p thuáº­n
                </Button>
                <Button
                  variant="destructive"
                  size="sm"
                  onClick={() => handleReject(profile.profile_id)}
                  disabled={isMutating}
                >
                  <XCircle className="mr-2 h-4 w-4" /> Tá»« chá»‘i
                </Button>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>
    );
  };

  return (
    <div className="container mx-auto py-8">
      <h1 className="text-3xl font-bold mb-2">Duyá»‡t há»“ sÆ¡ Giáº£ng viÃªn</h1>
      <p className="text-muted-foreground mb-6">
        CÃ¡c há»“ sÆ¡ Ä‘ang chá» Ä‘Æ°á»£c xem xÃ©t.
      </p>

      {renderContent()}

      {/* âœ… PhÃ¢n trang */}
      {!isLoading && (
        <div className="flex items-center justify-between py-6 mt-8 border-t">
          <span className="text-sm text-muted-foreground">
            Tá»•ng cá»™ng: {total} há»“ sÆ¡
          </span>
          <div className="flex items-center space-x-2">
            <span className="text-sm text-muted-foreground">
              Trang {page} / {totalPages}
            </span>
            <Button
              variant="outline"
              size="sm"
              onClick={() => setPage((p) => Math.max(1, p - 1))}
              disabled={page <= 1 || isLoading}
            >
              TrÆ°á»›c
            </Button>
            <Button
              variant="outline"
              size="sm"
              onClick={() => setPage((p) => Math.min(totalPages, p + 1))}
              disabled={page >= totalPages || isLoading}
            >
              Sau
            </Button>
          </div>
        </div>
      )}
    </div>
  );
}


//(protected)\admin\profile\page.tsx
"use client";

import { useAuth } from "@/lib/hooks/useAuth";
import { UserProfile } from "@/components/shared/UserProfile";
import { Skeleton } from "@/components/ui/skeleton";
import { ProfilePageSkeleton } from "@/components/skeleton/ProfilePageSkeleton";

export default function AdminProfilePage() {
  const { user, isLoading } = useAuth({ redirectToLoginIfFail: true });
  console.log(user, "user");
  if (isLoading) return <ProfilePageSkeleton />;
  if (!user) return null;

  return (
    <div>
      <h1 className="text-3xl font-bold mb-8 text-center">
        Trang cÃ¡ nhÃ¢n Admin
      </h1>
      <UserProfile user={user} />
    </div>
  );
}


//(protected)\admin\settings\page.tsx
"use client";

import { useState, useEffect, useCallback } from "react";
import { toast } from "sonner";
import { adminService } from "@/lib/api/adminService";
import { SystemSetting } from "@/lib/types";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Skeleton } from "@/components/ui/skeleton";
import { Trash2, PlusCircle } from "lucide-react";
import { useForm } from "react-hook-form";

const SettingsSkeleton = () => (
  // Sá»­a láº¡i skeleton Ä‘á»ƒ khá»›p vá»›i sá»‘ cá»™t
  <TableBody>
    {[...Array(3)].map((_, i) => (
      <TableRow key={`skeleton-${i}`}>
        <TableCell>
          <Skeleton className="h-5 w-32" />
        </TableCell>
        <TableCell>
          <Skeleton className="h-5 w-48" />
        </TableCell>
        <TableCell>
          <Skeleton className="h-5 w-full" />
        </TableCell>
        <TableCell className="text-right">
          <Skeleton className="h-8 w-8 ml-auto" />
        </TableCell>
      </TableRow>
    ))}
  </TableBody>
);

export default function AdminSettingsPage() {
  const { register, handleSubmit, reset } = useForm<{
    key: string;
    value: string;
    description: string;
  }>();
  const [settings, setSettings] = useState<SystemSetting[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isMutating, setIsMutating] = useState(false);

  const fetchSettings = useCallback(async () => {
    setIsLoading(true);
    try {
      const data = await adminService.listSettings();
      setSettings(data);
    } catch (error) {
      toast.error(
        error instanceof Error ? error.message : "KhÃ´ng thá»ƒ táº£i cÃ i Ä‘áº·t."
      );
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchSettings();
  }, [fetchSettings]);

  const onSubmit = async (data: {
    key: string;
    value: string;
    description: string;
  }) => {
    setIsMutating(true);
    try {
      await adminService.upsertSetting(data.key, data.value, data.description);
      toast.success("CÃ i Ä‘áº·t Ä‘Ã£ Ä‘Æ°á»£c lÆ°u.");
      fetchSettings();
      reset({ key: "", value: "", description: "" });
    } catch (error) {
      toast.error(error instanceof Error ? error.message : "LÆ°u tháº¥t báº¡i.");
    } finally {
      setIsMutating(false);
    }
  };

  const handleDelete = async (key: string) => {
    if (!confirm(`Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a cÃ i Ä‘áº·t "${key}"?`)) return;
    setIsMutating(true);
    try {
      await adminService.deleteSetting(key);
      toast.success("CÃ i Ä‘áº·t Ä‘Ã£ Ä‘Æ°á»£c xÃ³a.");
      fetchSettings();
    } catch (error) {
      toast.error(error instanceof Error ? error.message : "XÃ³a tháº¥t báº¡i.");
    } finally {
      setIsMutating(false);
    }
  };

  return (
    <div className="container mx-auto py-8">
      <h1 className="text-3xl font-bold mb-6">CÃ i Ä‘áº·t há»‡ thá»‘ng</h1>

      <form
        onSubmit={handleSubmit(onSubmit)}
        className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 p-4 border rounded-lg bg-card"
      >
        <Input
          {...register("key")}
          placeholder="Key"
          required
          disabled={isMutating}
        />
        <Input
          {...register("value")}
          placeholder="Value"
          disabled={isMutating}
        />
        <Input
          {...register("description")}
          placeholder="MÃ´ táº£"
          className="md:col-span-2"
          disabled={isMutating}
        />
        <Button type="submit" disabled={isMutating} className="md:col-start-4">
          <PlusCircle className="mr-2 h-4 w-4" />
          {isMutating ? "Äang lÆ°u..." : "ThÃªm/Cáº­p nháº­t"}
        </Button>
      </form>

      <div className="rounded-lg border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Key</TableHead>
              <TableHead>Value</TableHead>
              <TableHead>MÃ´ táº£</TableHead>
              <TableHead className="text-right">HÃ nh Ä‘á»™ng</TableHead>
            </TableRow>
          </TableHeader>

          {isLoading ? (
            // âœ… Sá»¬A Lá»–I á»ž ÄÃ‚Y: DÃ¹ng component Skeleton riÃªng
            <SettingsSkeleton />
          ) : (
            <TableBody>
              {settings?.length > 0 ? (
                settings.map((setting) => (
                  <TableRow key={setting.setting_id}>
                    <TableCell className="font-mono">
                      {setting.setting_key}
                    </TableCell>
                    <TableCell>{setting.setting_value}</TableCell>
                    <TableCell className="text-muted-foreground">
                      {setting.description}
                    </TableCell>
                    <TableCell className="text-right">
                      <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => handleDelete(setting.setting_key)}
                        disabled={isMutating}
                      >
                        <Trash2 className="h-4 w-4 text-red-500" />
                      </Button>
                    </TableCell>
                  </TableRow>
                ))
              ) : (
                <TableRow>
                  <TableCell colSpan={4} className="h-24 text-center">
                    KhÃ´ng cÃ³ cÃ i Ä‘áº·t nÃ o.
                  </TableCell>
                </TableRow>
              )}
            </TableBody>
          )}
        </Table>
      </div>
    </div>
  );
}


//(protected)\admin\support\page.tsx
"use client";

import { useState, useEffect, useCallback } from "react";
import { toast } from "sonner";
import { adminService } from "@/lib/api/adminService";
import { SupportTicket } from "@/lib/types";
import { Badge } from "@/components/ui/badge";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Skeleton } from "@/components/ui/skeleton";
import { format } from "date-fns";

const SupportTicketsSkeleton = () => (
  <TableBody>
    {[...Array(5)].map((_, i) => (
      <TableRow key={`skeleton-${i}`}>
        <TableCell>
          <Skeleton className="h-5 w-10" />
        </TableCell>
        <TableCell>
          <Skeleton className="h-5 w-48" />
        </TableCell>
        <TableCell>
          <Skeleton className="h-5 w-24" />
        </TableCell>
        <TableCell>
          <Skeleton className="h-5 w-20" />
        </TableCell>
        <TableCell>
          <Skeleton className="h-5 w-32" />
        </TableCell>
      </TableRow>
    ))}
  </TableBody>
);

export default function AdminSupportPage() {
  const [tickets, setTickets] = useState<SupportTicket[] | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);

  const fetchTickets = useCallback(async () => {
    setIsLoading(true);
    setError(null);
    try {
      const data = await adminService.listSupportTickets(page);
      setTickets(data.data); // âœ… láº¥y tá»« PaginatedResponse
      setTotalPages(data.meta.total_pages); // âœ… meta tá»« server
    } catch (err) {
      const errorMessage =
        err instanceof Error ? err.message : "KhÃ´ng thá»ƒ táº£i danh sÃ¡ch ticket.";
      setError(errorMessage);
      toast.error(errorMessage);
      setTickets([]); // fallback máº£ng rá»—ng
    } finally {
      setIsLoading(false);
    }
  }, [page]);

  useEffect(() => {
    fetchTickets();
  }, [fetchTickets]);

  const renderTableBody = () => {
    if (isLoading && tickets === null) {
      return <SupportTicketsSkeleton />;
    }

    if (error) {
      return (
        <TableBody>
          <TableRow>
            <TableCell colSpan={5} className="text-center h-24 text-red-600">
              {error}
            </TableCell>
          </TableRow>
        </TableBody>
      );
    }

    if (!tickets || tickets.length === 0) {
      return (
        <TableBody>
          <TableRow>
            <TableCell colSpan={5} className="text-center h-24">
              KhÃ´ng cÃ³ ticket há»— trá»£ nÃ o.
            </TableCell>
          </TableRow>
        </TableBody>
      );
    }

    return (
      <TableBody>
        {tickets.map((ticket) => (
          <TableRow key={ticket.ticket_id}>
            <TableCell>{ticket.ticket_id}</TableCell>
            <TableCell className="font-medium">{ticket.subject}</TableCell>
            <TableCell>{ticket.user?.full_name || "N/A"}</TableCell>
            <TableCell>
              <Badge>{ticket.status}</Badge>
            </TableCell>
            <TableCell>
              {format(new Date(ticket.created_at), "dd/MM/yyyy HH:mm")}
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    );
  };

  return (
    <div className="container mx-auto py-8">
      <h1 className="text-3xl font-bold mb-6">Quáº£n lÃ½ Há»— trá»£</h1>
      <div className="rounded-lg border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>ID</TableHead>
              <TableHead>TiÃªu Ä‘á»</TableHead>
              <TableHead>NgÆ°á»i gá»­i</TableHead>
              <TableHead>Tráº¡ng thÃ¡i</TableHead>
              <TableHead>NgÃ y táº¡o</TableHead>
            </TableRow>
          </TableHeader>
          {renderTableBody()}
        </Table>
      </div>
    </div>
  );
}


//(protected)\admin\transactions\page.tsx
export default function AdminTransactionsPage() {
  return (
    <div>
      <h1 className="text-2xl font-bold">Admin: Manage Transactions</h1>
      <p>This is a placeholder page for administrators to view transactions.</p>
    </div>
  );
}


//(protected)\admin\users\page.tsx
"use client";

import { useState, useEffect, useCallback } from "react";
import { toast } from "sonner";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { AuthenticatedUser, UserRole, UserStatus } from "@/lib/types";
import { userService } from "@/lib/api/userService";
import { useDebounce } from "use-debounce";
import { Skeleton } from "@/components/ui/skeleton";

// ----------------- Skeleton Table -----------------
const UsersTableSkeleton = () => (
  <TableBody>
    {[...Array(5)].map((_, i) => (
      <TableRow key={`skeleton-${i}`}>
        {[...Array(6)].map((_, j) => (
          <TableCell key={j}>
            <Skeleton className="h-5 w-full" />
          </TableCell>
        ))}
      </TableRow>
    ))}
  </TableBody>
);

// ----------------- Component chÃ­nh -----------------
export default function AdminUsersPage() {
  const [users, setUsers] = useState<AuthenticatedUser[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [total, setTotal] = useState(0);

  const [filters, setFilters] = useState({
    keyword: "",
    role: undefined as UserRole | undefined,
    status: undefined as UserStatus | undefined,
  });

  const [debouncedKeyword] = useDebounce(filters.keyword, 500);

  const fetchUsers = useCallback(async () => {
    setIsLoading(true);
    setError(null);
    try {
      const res = await userService.listUsers({
        page,
        limit: 10,
        keyword: debouncedKeyword,
        role: filters.role,
        status: filters.status,
      });

      const usersData = res.data || [];
      const meta = res.meta;

      setUsers(usersData);
      setTotal(meta.total || 0);
      setTotalPages(meta.total_pages || 1);
    } catch (err: unknown) {
      const errorMessage =
        err instanceof Error
          ? err.message
          : "KhÃ´ng thá»ƒ táº£i danh sÃ¡ch ngÆ°á»i dÃ¹ng.";
      setError(errorMessage);
      toast.error(errorMessage);
      setUsers([]);
      setTotalPages(1);
      setTotal(0);
    } finally {
      setIsLoading(false);
    }
  }, [page, debouncedKeyword, filters.role, filters.status]);

  useEffect(() => {
    fetchUsers();
  }, [fetchUsers]);

  // ----------------- Xá»­ lÃ½ thay Ä‘á»•i bá»™ lá»c -----------------
  const handleFilterChange = (key: "role" | "status", value: string) => {
    setFilters((prev) => ({
      ...prev,
      [key]: value === "all" ? undefined : (value as UserRole | UserStatus),
    }));
    setPage(1);
  };

  // ----------------- Hiá»ƒn thá»‹ báº£ng -----------------
  const renderTableBody = () => {
    if (isLoading && users.length === 0) return <UsersTableSkeleton />;

    if (error) {
      return (
        <TableBody>
          <TableRow>
            <TableCell colSpan={6} className="text-center h-24 text-red-600">
              {error}
            </TableCell>
          </TableRow>
        </TableBody>
      );
    }

    if (!users || users.length === 0) {
      return (
        <TableBody>
          <TableRow>
            <TableCell colSpan={6} className="text-center h-24">
              KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i dÃ¹ng nÃ o.
            </TableCell>
          </TableRow>
        </TableBody>
      );
    }

    return (
      <TableBody>
        {users.map((user) => (
          <TableRow key={user.id}>
            <TableCell>{user.id}</TableCell>
            <TableCell className="font-medium">{user.full_name}</TableCell>
            <TableCell>{user.email}</TableCell>
            <TableCell>
              <Badge
                variant={
                  user.role.includes("admin") ? "destructive" : "secondary"
                }
              >
                {user.role}
              </Badge>
            </TableCell>
            <TableCell>
              <Badge variant={user.status === "active" ? "default" : "outline"}>
                {user.status}
              </Badge>
            </TableCell>
            <TableCell>
              <Button variant="outline" size="sm">
                Xem
              </Button>
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    );
  };

  // ----------------- Render chÃ­nh -----------------
  return (
    <div className="container mx-auto py-8">
      <h1 className="text-3xl font-bold mb-6">Quáº£n lÃ½ NgÆ°á»i dÃ¹ng</h1>

      {/* Bá»™ lá»c */}
      <div className="flex flex-col md:flex-row gap-4 mb-6">
        <Input
          placeholder="TÃ¬m kiáº¿m theo email, há» tÃªn..."
          value={filters.keyword}
          onChange={(e) =>
            setFilters((prev) => ({ ...prev, keyword: e.target.value }))
          }
          className="max-w-sm"
        />
        <Select
          value={filters.role || "all"}
          onValueChange={(value) => handleFilterChange("role", value)}
        >
          <SelectTrigger className="w-full md:w-[180px]">
            <SelectValue placeholder="Lá»c theo vai trÃ²" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">Táº¥t cáº£ vai trÃ²</SelectItem>
            <SelectItem value="student">Há»c viÃªn</SelectItem>
            <SelectItem value="instructor">Giáº£ng viÃªn</SelectItem>
            <SelectItem value="support_admin">Support Admin</SelectItem>
            <SelectItem value="system_admin">System Admin</SelectItem>
          </SelectContent>
        </Select>

        <Select
          value={filters.status || "all"}
          onValueChange={(value) => handleFilterChange("status", value)}
        >
          <SelectTrigger className="w-full md:w-[180px]">
            <SelectValue placeholder="Lá»c theo tráº¡ng thÃ¡i" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">Táº¥t cáº£ tráº¡ng thÃ¡i</SelectItem>
            <SelectItem value="active">Active</SelectItem>
            <SelectItem value="inactive">Inactive</SelectItem>
            <SelectItem value="pending">Pending</SelectItem>
            <SelectItem value="locked">Locked</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* Báº£ng hiá»ƒn thá»‹ */}
      <div className="rounded-lg border shadow-sm">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>ID</TableHead>
              <TableHead>Há» vÃ  TÃªn</TableHead>
              <TableHead>Email</TableHead>
              <TableHead>Vai trÃ²</TableHead>
              <TableHead>Tráº¡ng thÃ¡i</TableHead>
              <TableHead>HÃ nh Ä‘á»™ng</TableHead>
            </TableRow>
          </TableHeader>
          {renderTableBody()}
        </Table>
      </div>

      {/* PhÃ¢n trang */}
      <div className="flex items-center justify-between py-4">
        <span className="text-sm text-muted-foreground">
          Tá»•ng cá»™ng: {total} ngÆ°á»i dÃ¹ng
        </span>
        <div className="flex items-center space-x-2">
          <span className="text-sm text-muted-foreground">
            Trang {page} / {totalPages}
          </span>
          <Button
            variant="outline"
            size="sm"
            onClick={() => setPage((p) => Math.max(1, p - 1))}
            disabled={page <= 1 || isLoading}
          >
            TrÆ°á»›c
          </Button>
          <Button
            variant="outline"
            size="sm"
            onClick={() => setPage((p) => Math.min(totalPages, p + 1))}
            disabled={page >= totalPages || isLoading}
          >
            Sau
          </Button>
        </div>
      </div>
    </div>
  );
}


//(protected)\instructor\layout.tsx
"use client";

import { useState, useEffect } from "react";
import Link from "next/link";
import { usePathname, useRouter } from "next/navigation";
import { Button } from "@/components/ui/button";
import {
  User,
  LogOut,
  Loader2,
  AlertTriangle,
  LayoutDashboard,
  BookCopy,
  PlusCircle,
} from "lucide-react";
import { useAuth } from "@/lib/hooks/useAuth";
import { instructorService } from "@/lib/api/instructorService";
import { InstructorProfile } from "@/lib/types";
import { clearAuthData } from "@/lib/auth/utils";
import { Logo } from "@/app/page";
import { cn } from "@/lib/utils";

// --- Component ApplicationPrompt (giá»¯ nguyÃªn, khÃ´ng thay Ä‘á»•i) ---
type PromptStatus = "pending" | "rejected" | "no_profile";
const ApplicationPrompt = ({
  status,
  reason,
}: {
  status: PromptStatus;
  reason?: string | null;
}) => {
  const handleLogoutAndRedirectHome = () => {
    clearAuthData();
    window.location.href = "/";
  };
  const getStatusMessage = () => {
    switch (status) {
      case "pending":
        return {
          title: "Há»“ sÆ¡ cá»§a báº¡n Ä‘ang chá» duyá»‡t",
          description:
            "ChÃºng tÃ´i Ä‘ang xem xÃ©t há»“ sÆ¡ cá»§a báº¡n. Vui lÃ²ng quay láº¡i sau. Báº¡n cÃ³ thá»ƒ chá»‰nh sá»­a há»“ sÆ¡ náº¿u cáº§n.",
        };
      case "rejected":
        return {
          title: "Há»“ sÆ¡ cá»§a báº¡n Ä‘Ã£ bá»‹ tá»« chá»‘i",
          description: `LÃ½ do: ${
            reason || "KhÃ´ng cÃ³ lÃ½ do cá»¥ thá»ƒ"
          }. Vui lÃ²ng cáº­p nháº­t láº¡i há»“ sÆ¡ vÃ  gá»­i láº¡i Ä‘á»ƒ chÃºng tÃ´i xem xÃ©t.`,
        };
      default:
        return {
          title: "HoÃ n thÃ nh há»“ sÆ¡ cá»§a báº¡n",
          description:
            "Äá»ƒ báº¯t Ä‘áº§u giáº£ng dáº¡y, báº¡n cáº§n táº¡o vÃ  gá»­i há»“ sÆ¡ Ä‘á»ƒ chÃºng tÃ´i xem xÃ©t. Sau khi Ä‘Æ°á»£c phÃª duyá»‡t, báº¡n sáº½ cÃ³ quyá»n truy cáº­p Ä‘áº§y Ä‘á»§ vÃ o cÃ¡c cÃ´ng cá»¥ dÃ nh cho giáº£ng viÃªn.",
        };
    }
  };
  const { title, description } = getStatusMessage();
  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-brand-background p-6 text-center">
      <div className="bg-white p-8 rounded-lg shadow-md max-w-lg">
        <AlertTriangle className="h-12 w-12 text-yellow-500 mx-auto mb-4" />
        <h1 className="text-2xl font-bold mb-2">{title}</h1>
        <p className="text-muted-foreground mb-6">{description}</p>
        <div className="flex flex-col sm:flex-row gap-4 justify-center">
          <Link href="/instructor/profile">
            <Button>Äáº¿n trang há»“ sÆ¡</Button>
          </Link>
          <Button variant="outline" onClick={handleLogoutAndRedirectHome}>
            ÄÄƒng xuáº¥t & Vá» trang chá»§
          </Button>
        </div>
      </div>
    </div>
  );
};
// --- END ---

const navItems = [
  { href: "/instructor/dashboard", icon: LayoutDashboard, label: "Tá»•ng quan" },
  { href: "/instructor/my-courses", icon: BookCopy, label: "Quáº£n lÃ½ khÃ³a há»c" },
  {
    href: "/instructor/create-course",
    icon: PlusCircle,
    label: "Táº¡o khÃ³a há»c má»›i",
  },
];

export default function InstructorLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const router = useRouter();
  const pathname = usePathname();
  const { user, isLoading: isAuthLoading } = useAuth({
    redirectToLoginIfFail: true,
  });

  const [profile, setProfile] = useState<InstructorProfile | null>(null);
  const [isProfileLoading, setIsProfileLoading] = useState(true);

  useEffect(() => {
    if (isAuthLoading || !user) return;
    if (user.role !== "instructor") {
      router.replace(`/${user.role}/dashboard`);
      return;
    }
    const fetchProfile = async () => {
      setIsProfileLoading(true);
      try {
        const myProfile = await instructorService.getMyProfile();
        setProfile(myProfile);
      } catch (error) {
        console.error("Failed to fetch instructor profile:", error);
        setProfile(null);
      } finally {
        setIsProfileLoading(false);
      }
    };
    fetchProfile();
  }, [user, isAuthLoading, router]);

  const handleLogout = () => {
    clearAuthData();
    router.push("/login");
  };

  const isLoading = isAuthLoading || isProfileLoading;

  if (isLoading || !user || (user.role !== "instructor" && !isAuthLoading)) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-brand-background">
        <Loader2 className="h-12 w-12 animate-spin text-brand-green" />
      </div>
    );
  }

  const approvalStatus = profile?.approval_status;

  if (approvalStatus === "approved") {
    return (
      <div className="min-h-screen bg-gray-50 text-gray-800">
        <header className="bg-white sticky top-0 z-50 border-b ">
          <div className="flex justify-between items-center h-30 w-full max-w-[90%] mx-auto">
            <Logo />

            <nav className="absolute left-1/2 -translate-x-1/2 hidden md:flex items-center gap-2 rounded-full bg-gray-100 p-1">
              {navItems.map((item) => {
                const isActive = pathname.startsWith(item.href);
                return (
                  <Link
                    key={item.href}
                    href={item.href}
                    className={cn(
                      "flex items-center gap-2 text-sm lg:text-lg xl:text-xl  font-semibold py-2 px-4 rounded-full transition-colors",
                      isActive
                        ? "bg-white shadow-sm text-primary"
                        : "text-gray-600 hover:text-gray-800"
                    )}
                  >
                    <item.icon className="h-4 w-4" />
                    {item.label}
                  </Link>
                );
              })}
            </nav>

            <div className="flex items-center gap-4">
              <Link
                href="/instructor/profile"
                className="flex items-center gap-2 text-sm lg:text-lg xl:text-xl  font-semibold text-gray-700 hover:text-primary"
              >
                <User className="h-5 w-5" />
                <span>{user.full_name}</span>
              </Link>
              <Button
                variant="ghost"
                size="sm"
                onClick={handleLogout}
                className="text-gray-600 hover:bg-red-50 hover:text-red-600 lg:text-lg xl:text-xl "
              >
                <LogOut className="mr-2 h-4 w-4" /> ÄÄƒng xuáº¥t
              </Button>
            </div>
          </div>
        </header>
        <main className="w-full max-w-[90%] mx-auto py-10">{children}</main>
      </div>
    );
  }

  if (pathname === "/instructor/profile") {
    return (
      <div className="min-h-screen bg-brand-background py-10">{children}</div>
    );
  }

  return (
    <ApplicationPrompt
      status={approvalStatus || "no_profile"}
      reason={profile?.rejection_reason}
    />
  );
}


//(protected)\instructor\apply\page.tsx
"use client";

import { useState } from "react";
import { useForm } from "react-hook-form";
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import { instructorService } from "@/lib/api/instructorService";
import { InstructorApplicationForm } from "@/lib/types";

export default function InstructorApplyPage() {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const { register, handleSubmit } = useForm<InstructorApplicationForm>();

  const onSubmit = async (data: InstructorApplicationForm) => {
    setIsLoading(true);
    try {
      await instructorService.createProfile(data);
      toast.success("Application submitted!");
      router.push("/instructor/dashboard");
    } catch (error) {
      toast.error("Failed to submit application");
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="max-w-2xl mx-auto p-6">
      <div className="bg-white rounded-lg shadow p-6">
        <h1 className="text-2xl font-bold mb-6">Apply as Instructor</h1>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-2">Bio</label>
            <textarea
              {...register("bio")}
              rows={3}
              className="w-full px-4 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-2">Education</label>
            <textarea
              {...register("education")}
              rows={2}
              className="w-full px-4 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-2">Experience</label>
            <textarea
              {...register("experience")}
              rows={2}
              className="w-full px-4 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-2">
              Certificates
            </label>
            <textarea
              {...register("certificates")}
              rows={2}
              className="w-full px-4 py-2 border rounded-lg"
            />
          </div>

          <button
            type="submit"
            disabled={isLoading}
            className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg"
          >
            {isLoading ? "Submitting..." : "Submit Application"}
          </button>
        </form>
      </div>
    </div>
  );
}


//(protected)\instructor\courses\[id]\page.tsx
"use client";

import { useState, useEffect, useCallback } from "react";
import { useParams, useRouter } from "next/navigation";
import { toast } from "sonner";
import { courseService } from "@/lib/api/courseService";
import { Course, Section, Lesson } from "@/lib/types";
import { Skeleton } from "@/components/ui/skeleton";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import {
  GripVertical,
  PlusCircle,
  Pencil,
  Trash2,
  PlayCircle,
} from "lucide-react";
import { SectionFormDialog } from "./_components/SectionForm";
import { LessonFormDialog } from "./_components/LessonFormDialog";

const CourseManageSkeleton = () => (
  <div className="container mx-auto py-8">
    <Skeleton className="h-9 w-3/4 mb-4" />
    <Skeleton className="h-5 w-1/2 mb-8" />
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div className="lg:col-span-2 space-y-6">
        <Skeleton className="h-48 w-full" />
        <Skeleton className="h-32 w-full" />
      </div>
      <div className="space-y-4">
        <Skeleton className="h-24 w-full" />
        <Skeleton className="h-12 w-full" />
      </div>
    </div>
  </div>
);

export default function ManageCoursePage() {
  const params = useParams();
  const courseId = Number(params.id);

  const [course, setCourse] = useState<Course | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  // State cho dialog Section
  const [isSectionFormOpen, setIsSectionFormOpen] = useState(false);
  const [editingSection, setEditingSection] = useState<Section | null>(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  // State cho dialog Lesson
  const [isLessonFormOpen, setIsLessonFormOpen] = useState(false);
  const [editingLesson, setEditingLesson] = useState<Lesson | null>(null);
  const [currentSectionId, setCurrentSectionId] = useState<number | null>(null);
  const handleSubmitForReview = async () => {
    if (
      !course ||
      !confirm("Báº¡n cÃ³ cháº¯c muá»‘n gá»­i khÃ³a há»c nÃ y Ä‘á»ƒ xÃ©t duyá»‡t khÃ´ng?")
    )
      return;

    setIsSubmitting(true);
    try {
      const updatedCourse = await courseService.changeCourseStatus(
        course.course_id,
        {
          status: "pending",
          approval_status: "pending",
        }
      );
      setCourse(updatedCourse); // Cáº­p nháº­t láº¡i state cá»§a course trÃªn UI
      toast.success("ÄÃ£ gá»­i yÃªu cáº§u xÃ©t duyá»‡t thÃ nh cÃ´ng!");
    } catch (error) {
      toast.error(
        error instanceof Error ? error.message : "Gá»­i yÃªu cáº§u tháº¥t báº¡i."
      );
    } finally {
      setIsSubmitting(false);
    }
  };
  const fetchCourseDetails = useCallback(async () => {
    if (!courseId) return;
    try {
      const courseData = await courseService.getCourse(courseId);
      setCourse(courseData);
    } catch (error) {
      toast.error(
        error instanceof Error
          ? error.message
          : "KhÃ´ng thá»ƒ táº£i chi tiáº¿t khÃ³a há»c."
      );
    } finally {
      setIsLoading(false);
    }
  }, [courseId]);

  useEffect(() => {
    setIsLoading(true);
    fetchCourseDetails();
  }, [fetchCourseDetails]);

  // === SECTION HANDLERS ===
  const handleOpenSectionForm = (section: Section | null = null) => {
    setEditingSection(section);
    setIsSectionFormOpen(true);
  };
  const handleDeleteSection = async (sectionId: number) => {
    if (
      !confirm(
        "Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a chÆ°Æ¡ng nÃ y? Táº¥t cáº£ bÃ i há»c bÃªn trong cÅ©ng sáº½ bá»‹ xÃ³a."
      )
    )
      return;
    try {
      await courseService.deleteSection(courseId, sectionId);
      toast.success("ÄÃ£ xÃ³a chÆ°Æ¡ng há»c.");
      fetchCourseDetails();
    } catch (error) {
      toast.error(error instanceof Error ? error.message : "XÃ³a tháº¥t báº¡i.");
    }
  };

  // === LESSON HANDLERS ===
  const handleOpenLessonForm = (
    sectionId: number,
    lesson: Lesson | null = null
  ) => {
    setCurrentSectionId(sectionId);
    setEditingLesson(lesson);
    setIsLessonFormOpen(true);
  };
  const handleDeleteLesson = async (sectionId: number, lessonId: number) => {
    if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a bÃ i há»c nÃ y?")) return;
    try {
      await courseService.deleteLesson(sectionId, lessonId);
      toast.success("ÄÃ£ xÃ³a bÃ i há»c.");
      fetchCourseDetails();
    } catch (error) {
      toast.error(error instanceof Error ? error.message : "XÃ³a tháº¥t báº¡i.");
    }
  };

  if (isLoading) return <CourseManageSkeleton />;
  if (!course)
    return (
      <div className="text-center py-20">
        <h1>KhÃ´ng tÃ¬m tháº¥y khÃ³a há»c</h1>
      </div>
    );

  return (
    <>
      <div className="container mx-auto py-8">
        <header className="mb-8">
          <p className="text-sm text-muted-foreground">Quáº£n lÃ½ khÃ³a há»c</p>
          <h1 className="text-4xl font-bold">{course.title}</h1>
        </header>
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div className="lg:col-span-2 space-y-6">
            <Card>
              <CardHeader className="flex flex-row justify-between items-center">
                <CardTitle>ChÆ°Æ¡ng trÃ¬nh giáº£ng dáº¡y</CardTitle>
                <Button
                  variant="outline"
                  onClick={() => handleOpenSectionForm()}
                >
                  <PlusCircle className="mr-2 h-4 w-4" /> ThÃªm chÆ°Æ¡ng
                </Button>
              </CardHeader>
              <CardContent>
                {course.sections && course.sections.length > 0 ? (
                  <div className="space-y-4">
                    {course.sections.map((section) => (
                      <div
                        key={section.section_id}
                        className="p-4 border rounded-md bg-slate-50"
                      >
                        <div className="flex justify-between items-center mb-2">
                          <h3 className="font-semibold flex items-center gap-2">
                            <GripVertical className="cursor-move text-muted-foreground" />
                            {section.title}
                          </h3>
                          <div className="flex items-center gap-2">
                            <Button
                              variant="ghost"
                              size="icon"
                              onClick={() => handleOpenSectionForm(section)}
                            >
                              <Pencil className="h-4 w-4" />
                            </Button>
                            <Button
                              variant="ghost"
                              size="icon"
                              onClick={() =>
                                handleDeleteSection(section.section_id)
                              }
                            >
                              <Trash2 className="h-4 w-4 text-destructive" />
                            </Button>
                          </div>
                        </div>
                        <div className="pl-6 space-y-2 border-l-2 ml-2 pt-2">
                          {section.lessons && section.lessons.length > 0 ? (
                            section.lessons.map((lesson) => (
                              <div
                                key={lesson.lesson_id}
                                className="flex justify-between items-center p-2 rounded-md hover:bg-slate-100 group"
                              >
                                <p className="text-sm flex items-center gap-2">
                                  <PlayCircle className="h-4 w-4 text-muted-foreground" />
                                  {lesson.title}
                                </p>
                                <div className="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                                  <Button
                                    variant="ghost"
                                    size="sm"
                                    onClick={() =>
                                      handleOpenLessonForm(
                                        section.section_id,
                                        lesson
                                      )
                                    }
                                  >
                                    Sá»­a
                                  </Button>
                                  <Button
                                    variant="ghost"
                                    size="sm"
                                    className="text-destructive hover:text-destructive"
                                    onClick={() =>
                                      handleDeleteLesson(
                                        section.section_id,
                                        lesson.lesson_id
                                      )
                                    }
                                  >
                                    XÃ³a
                                  </Button>
                                </div>
                              </div>
                            ))
                          ) : (
                            <p className="text-sm text-muted-foreground italic p-2">
                              ChÆ°a cÃ³ bÃ i há»c
                            </p>
                          )}
                          <Button
                            variant="link"
                            size="sm"
                            className="w-full justify-start h-8"
                            onClick={() =>
                              handleOpenLessonForm(section.section_id)
                            }
                          >
                            <PlusCircle className="mr-2 h-4 w-4" /> ThÃªm bÃ i há»c
                          </Button>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="text-center text-muted-foreground py-8">
                    KhÃ³a há»c nÃ y chÆ°a cÃ³ ná»™i dung. HÃ£y báº¯t Ä‘áº§u báº±ng cÃ¡ch thÃªm
                    chÆ°Æ¡ng má»›i.
                  </p>
                )}
              </CardContent>
            </Card>
          </div>
          <aside className="space-y-6 self-start sticky top-24">
            <Card>
              <CardHeader>
                <CardTitle>ThÃ´ng tin khÃ³a há»c</CardTitle>
              </CardHeader>
              <CardContent>
                <Button className="w-full">Chá»‰nh sá»­a thÃ´ng tin</Button>
              </CardContent>
            </Card>
            <Card>
              <CardHeader>
                <CardTitle>HÃ nh Ä‘á»™ng</CardTitle>
              </CardHeader>
              <CardContent className="space-y-2">
                <Button
                  variant="outline"
                  className="w-full"
                  onClick={handleSubmitForReview}
                  disabled={
                    isSubmitting ||
                    course.status === "pending" ||
                    course.status === "published"
                  }
                >
                  {isSubmitting ? "Äang gá»­i..." : "Gá»­i yÃªu cáº§u xÃ©t duyá»‡t"}
                </Button>
                <Button variant="destructive" className="w-full">
                  XÃ³a khÃ³a há»c
                </Button>
              </CardContent>
            </Card>
          </aside>
        </div>
      </div>
      {isSectionFormOpen && (
        <SectionFormDialog
          courseId={courseId}
          section={editingSection}
          isOpen={isSectionFormOpen}
          onClose={() => setIsSectionFormOpen(false)}
          onSuccess={fetchCourseDetails}
        />
      )}
      {isLessonFormOpen && currentSectionId && (
        <LessonFormDialog
          sectionId={currentSectionId}
          lesson={editingLesson}
          isOpen={isLessonFormOpen}
          onClose={() => setIsLessonFormOpen(false)}
          onSuccess={fetchCourseDetails}
        />
      )}
    </>
  );
}


//(protected)\instructor\courses\[id]\_components\LessonFormDialog.tsx
"use client";

import { useForm } from "react-hook-form";
import { Lesson, LessonForm, LessonType } from "@/lib/types";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { courseService } from "@/lib/api/courseService";
import { toast } from "sonner";
import { Checkbox } from "@/components/ui/checkbox";

interface LessonFormProps {
  sectionId: number;
  lesson?: Lesson | null;
  isOpen: boolean;
  onClose: () => void;
  onSuccess: (newLesson: Lesson) => void;
}

const lessonTypes: LessonType[] = ["video", "document", "quiz"];

export function LessonFormDialog({
  sectionId,
  lesson,
  isOpen,
  onClose,
  onSuccess,
}: LessonFormProps) {
  const form = useForm<LessonForm>({
    defaultValues: {
      title: lesson?.title || "",
      description: lesson?.description || "",
      lesson_type: lesson?.lesson_type || "video",
      video_url: lesson?.video_url || "",
      allow_preview: lesson?.allow_preview || false,
    },
  });

  const onSubmit = async (data: LessonForm) => {
    try {
      let result;
      const payload = {
        ...data,
        video_duration: data.video_duration ? Number(data.video_duration) : 0,
      };

      if (lesson) {
        result = await courseService.updateLesson(
          sectionId,
          lesson.lesson_id,
          payload
        );
      } else {
        result = await courseService.createLesson(sectionId, payload);
      }
      toast.success(`BÃ i há»c Ä‘Ã£ Ä‘Æ°á»£c ${lesson ? "cáº­p nháº­t" : "táº¡o"}!`);
      onSuccess(result);
      onClose();
    } catch (error) {
      toast.error(error instanceof Error ? error.message : "ÄÃ£ xáº£y ra lá»—i.");
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-[600px]">
        <DialogHeader>
          <DialogTitle>
            {lesson ? "Chá»‰nh sá»­a bÃ i há»c" : "Táº¡o bÃ i há»c má»›i"}
          </DialogTitle>
        </DialogHeader>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              name="title"
              control={form.control}
              rules={{ required: "TiÃªu Ä‘á» lÃ  báº¯t buá»™c" }}
              render={({ field }) => (
                <FormItem>
                  <FormLabel>TiÃªu Ä‘á» bÃ i há»c</FormLabel>
                  <FormControl>
                    <Input
                      placeholder="VÃ­ dá»¥: BÃ i 1 - Báº£ng chá»¯ cÃ¡i"
                      {...field}
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            <FormField
              name="lesson_type"
              control={form.control}
              rules={{ required: "Vui lÃ²ng chá»n loáº¡i bÃ i há»c" }}
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Loáº¡i bÃ i há»c</FormLabel>
                  <Select
                    onValueChange={field.onChange}
                    defaultValue={field.value}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {lessonTypes.map((type) => (
                        <SelectItem
                          key={type}
                          value={type}
                          className="capitalize"
                        >
                          {type}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />
            <FormField
              name="video_url"
              control={form.control}
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Link Video (tÃ¹y chá»n)</FormLabel>
                  <FormControl>
                    <Input placeholder="https://youtube.com/..." {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            <FormField
              name="description"
              control={form.control}
              render={({ field }) => (
                <FormItem>
                  <FormLabel>MÃ´ táº£ (tÃ¹y chá»n)</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="MÃ´ táº£ ngáº¯n vá» ná»™i dung bÃ i há»c..."
                      {...field}
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            <FormField
              name="allow_preview"
              control={form.control}
              render={({ field }) => (
                <FormItem className="flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4">
                  <FormControl>
                    <Checkbox
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                  <div className="space-y-1 leading-none">
                    <FormLabel>Cho phÃ©p xem trÆ°á»›c</FormLabel>
                  </div>
                </FormItem>
              )}
            />
            <DialogFooter>
              <Button type="button" variant="ghost" onClick={onClose}>
                Há»§y
              </Button>
              <Button type="submit">LÆ°u</Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}


//(protected)\instructor\courses\[id]\_components\SectionForm.tsx
"use client";

import { useForm } from "react-hook-form";
import { Section, SectionForm } from "@/lib/types";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Textarea } from "@/components/ui/textarea";
import { courseService } from "@/lib/api/courseService";
import { toast } from "sonner";

interface SectionFormProps {
  courseId: number;
  section?: Section | null; // DÃ¹ng Ä‘á»ƒ chá»‰nh sá»­a
  isOpen: boolean;
  onClose: () => void;
  onSuccess: (newSection: Section) => void;
}

export function SectionFormDialog({
  courseId,
  section,
  isOpen,
  onClose,
  onSuccess,
}: SectionFormProps) {
  const form = useForm<SectionForm>({
    defaultValues: {
      title: section?.title || "",
      description: section?.description || "",
    },
  });

  const onSubmit = async (data: SectionForm) => {
    try {
      let result;
      if (section) {
        // Chá»©c nÄƒng cáº­p nháº­t
        result = await courseService.updateSection(
          courseId,
          section.section_id,
          data
        );
      } else {
        // Chá»©c nÄƒng táº¡o má»›i
        result = await courseService.createSection(courseId, data);
      }
      toast.success(`ChÆ°Æ¡ng há»c Ä‘Ã£ Ä‘Æ°á»£c ${section ? "cáº­p nháº­t" : "táº¡o"}!`);
      onSuccess(result);
      onClose();
    } catch (error) {
      toast.error(error instanceof Error ? error.message : "ÄÃ£ xáº£y ra lá»—i.");
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>
            {section ? "Chá»‰nh sá»­a chÆ°Æ¡ng há»c" : "Táº¡o chÆ°Æ¡ng há»c má»›i"}
          </DialogTitle>
        </DialogHeader>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              name="title"
              control={form.control}
              rules={{ required: "TiÃªu Ä‘á» lÃ  báº¯t buá»™c" }}
              render={({ field }) => (
                <FormItem>
                  <FormLabel>TiÃªu Ä‘á» chÆ°Æ¡ng</FormLabel>
                  <FormControl>
                    <Input
                      placeholder="VÃ­ dá»¥: ChÆ°Æ¡ng 1 - Giá»›i thiá»‡u"
                      {...field}
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            <FormField
              name="description"
              control={form.control}
              render={({ field }) => (
                <FormItem>
                  <FormLabel>MÃ´ táº£ (tÃ¹y chá»n)</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="MÃ´ táº£ ngáº¯n vá» ná»™i dung chÆ°Æ¡ng..."
                      {...field}
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            <DialogFooter>
              <Button type="button" variant="ghost" onClick={onClose}>
                Há»§y
              </Button>
              <Button type="submit">LÆ°u</Button>
            </DialogFooter>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}


//(protected)\instructor\create-course\page.tsx
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { useForm } from "react-hook-form";
import { toast } from "sonner";
import { courseService } from "@/lib/api/courseService";
import { Category, CourseForm, CourseTag } from "@/lib/types";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Loader2, PlusCircle } from "lucide-react";
import { Checkbox } from "@/components/ui/checkbox";

export default function CreateCoursePage() {
  const router = useRouter();
  const [categories, setCategories] = useState<Category[]>([]);
  const [tags, setTags] = useState<CourseTag[]>([]);
  const [isLoadingMeta, setIsLoadingMeta] = useState(true);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const form = useForm<CourseForm>({
    // KhÃ´ng dÃ¹ng zodResolver
    defaultValues: {
      title: "",
      description: "",
      language: "Tiáº¿ng Viá»‡t",
      level: "beginner",
      price: 0,
      duration_hours: 1,
      tag_ids: [],
    },
  });

  // Fetch dá»¯ liá»‡u meta (categories, tags)
  useEffect(() => {
    async function fetchMetaData() {
      setIsLoadingMeta(true);
      try {
        const [categoriesData, tagsData] = await Promise.all([
          courseService.listCategories(),
          courseService.listTags(),
        ]);
        setCategories(categoriesData);
        setTags(tagsData);
      } catch (error) {
        toast.error("Lá»—i khi táº£i dá»¯ liá»‡u cho form. Vui lÃ²ng thá»­ láº¡i.");
      } finally {
        setIsLoadingMeta(false);
      }
    }
    fetchMetaData();
  }, []);

  const onSubmit = async (data: CourseForm) => {
    setIsSubmitting(true);
    try {
      // Ã‰p kiá»ƒu cÃ¡c giÃ¡ trá»‹ tá»« input (string) sang number trÆ°á»›c khi gá»­i Ä‘i
      const payload: CourseForm = {
        ...data,
        category_id: Number(data.category_id),
        price: Number(data.price),
        duration_hours: Number(data.duration_hours),
        discount_price: data.discount_price
          ? Number(data.discount_price)
          : undefined,
      };

      const newCourse = await courseService.createCourse(payload);
      toast.success("Táº¡o khÃ³a há»c thÃ nh cÃ´ng!");
      router.push(`/instructor/my-courses`);
    } catch (error) {
      toast.error(
        error instanceof Error ? error.message : "Táº¡o khÃ³a há»c tháº¥t báº¡i."
      );
    } finally {
      setIsSubmitting(false);
    }
  };

  if (isLoadingMeta) {
    return (
      <div className="flex justify-center items-center h-screen">
        <Loader2 className="mr-2 h-8 w-8 animate-spin" />
        <span>Äang táº£i dá»¯ liá»‡u form...</span>
      </div>
    );
  }

  return (
    <div className="container mx-auto py-8">
      <Card className="max-w-4xl mx-auto">
        <CardHeader>
          <CardTitle className="text-2xl">Táº¡o khÃ³a há»c má»›i</CardTitle>
          <CardDescription>
            Äiá»n cÃ¡c thÃ´ng tin cÆ¡ báº£n vá» khÃ³a há»c cá»§a báº¡n.
          </CardDescription>
        </CardHeader>
        <CardContent>
          <Form {...form}>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
              <FormField
                control={form.control}
                name="title"
                rules={{
                  required: "TiÃªu Ä‘á» khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.",
                  minLength: {
                    value: 5,
                    message: "TiÃªu Ä‘á» pháº£i cÃ³ Ã­t nháº¥t 5 kÃ½ tá»±.",
                  },
                }}
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>TiÃªu Ä‘á» khÃ³a há»c</FormLabel>
                    <FormControl>
                      <Input
                        placeholder="VÃ­ dá»¥: Luyá»‡n thi IELTS 7.0 cáº¥p tá»‘c"
                        {...field}
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="description"
                rules={{
                  required: "MÃ´ táº£ khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.",
                  minLength: {
                    value: 20,
                    message: "MÃ´ táº£ pháº£i cÃ³ Ã­t nháº¥t 20 kÃ½ tá»±.",
                  },
                }}
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>MÃ´ táº£ chi tiáº¿t</FormLabel>
                    <FormControl>
                      <Textarea
                        rows={5}
                        placeholder="MÃ´ táº£ vá» nhá»¯ng gÃ¬ há»c viÃªn sáº½ há»c Ä‘Æ°á»£c..."
                        {...field}
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <FormField
                  control={form.control}
                  name="category_id"
                  rules={{ required: "Vui lÃ²ng chá»n danh má»¥c." }}
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Danh má»¥c</FormLabel>
                      <Select
                        onValueChange={field.onChange}
                        defaultValue={String(field.value)}
                      >
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Chá»n danh má»¥c" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          {categories.map((c) => (
                            <SelectItem
                              key={c.category_id}
                              value={String(c.category_id)}
                            >
                              {c.name}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                <FormField
                  control={form.control}
                  name="level"
                  rules={{ required: "Vui lÃ²ng chá»n trÃ¬nh Ä‘á»™." }}
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>TrÃ¬nh Ä‘á»™</FormLabel>
                      <Select
                        onValueChange={field.onChange}
                        defaultValue={field.value}
                      >
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Chá»n trÃ¬nh Ä‘á»™" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          <SelectItem value="beginner">
                            NgÆ°á»i má»›i báº¯t Ä‘áº§u
                          </SelectItem>
                          <SelectItem value="intermediate">
                            Trung cáº¥p
                          </SelectItem>
                          <SelectItem value="advanced">NÃ¢ng cao</SelectItem>
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <FormField
                  control={form.control}
                  name="price"
                  rules={{
                    required: "GiÃ¡ khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.",
                    min: { value: 0, message: "GiÃ¡ khÃ´ng thá»ƒ lÃ  sá»‘ Ã¢m." },
                  }}
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>GiÃ¡ (VND)</FormLabel>
                      <FormControl>
                        <Input type="number" placeholder="0" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                <FormField
                  control={form.control}
                  name="duration_hours"
                  rules={{
                    required: "Thá»i lÆ°á»£ng khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.",
                    min: { value: 1, message: "Thá»i lÆ°á»£ng pháº£i lá»›n hÆ¡n 0." },
                  }}
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Thá»i lÆ°á»£ng (giá»)</FormLabel>
                      <FormControl>
                        <Input type="number" placeholder="1" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </div>

              <FormField
                control={form.control}
                name="language"
                rules={{ required: "NgÃ´n ngá»¯ khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng." }}
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>NgÃ´n ngá»¯</FormLabel>
                    <FormControl>
                      <Input placeholder="Tiáº¿ng Viá»‡t" {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="tag_ids"
                render={() => (
                  <FormItem>
                    <FormLabel>Tags</FormLabel>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 rounded-md border p-4">
                      {tags.map((tag) => (
                        <FormField
                          key={tag.tag_id}
                          control={form.control}
                          name="tag_ids"
                          render={({ field }) => {
                            const currentValue = field.value || [];
                            return (
                              <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                                <FormControl>
                                  <Checkbox
                                    checked={currentValue.includes(tag.tag_id)}
                                    onCheckedChange={(checked) => {
                                      if (checked) {
                                        field.onChange([
                                          ...currentValue,
                                          tag.tag_id,
                                        ]);
                                      } else {
                                        field.onChange(
                                          currentValue.filter(
                                            (value) => value !== tag.tag_id
                                          )
                                        );
                                      }
                                    }}
                                  />
                                </FormControl>
                                <FormLabel className="font-normal">
                                  {tag.name}
                                </FormLabel>
                              </FormItem>
                            );
                          }}
                        />
                      ))}
                    </div>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <Button type="submit" disabled={isSubmitting} size="lg">
                {isSubmitting ? (
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                ) : (
                  <PlusCircle className="mr-2 h-4 w-4" />
                )}
                Táº¡o khÃ³a há»c
              </Button>
            </form>
          </Form>
        </CardContent>
      </Card>
    </div>
  );
}


//(protected)\instructor\dashboard\page.tsx
"use client";

import { useState, useEffect } from "react";
import { useAuth } from "@/lib/hooks/useAuth";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Skeleton } from "@/components/ui/skeleton";
import {
  BookOpen,
  Users,
  TrendingUp,
  DollarSign,
  Clock,
  Star,
  HelpCircle,
  MessageSquare,
  Loader2,
} from "lucide-react";
import { cn } from "@/lib/utils";
import type { LucideProps } from "lucide-react";
import { toast } from "sonner";
import { InstructorSummary, ActionItems } from "@/lib/types/index"; // Import the new service and types
import { formatDistanceToNow } from "date-fns";
import { vi } from "date-fns/locale";
import { instructorService } from "@/lib/api/instructorService";

// Stat Card Component (No changes needed, but I'll fix the 'any' type for icon)
interface StatCardProps {
  title: string;
  value: string | number;
  icon: React.ForwardRefExoticComponent<
    Omit<LucideProps, "ref"> & React.RefAttributes<SVGSVGElement>
  >;
  isLoading: boolean;
  formatAsCurrency?: boolean;
}

const StatCard = ({
  title,
  value,
  icon: Icon,
  isLoading,
  formatAsCurrency = false,
}: StatCardProps) => {
  const displayValue =
    formatAsCurrency && typeof value === "number"
      ? new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(value)
      : typeof value === "number"
      ? value.toLocaleString("vi-VN")
      : value;

  return (
    <Card className="shadow-sm hover:shadow-md transition-shadow bg-white">
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-base font-medium text-gray-500">
          {title}
        </CardTitle>
        <Icon className="h-5 w-5 text-gray-400" />
      </CardHeader>
      <CardContent>
        {isLoading ? (
          <Skeleton className="h-9 w-3/4" />
        ) : (
          <div className="text-3xl font-bold">{displayValue}</div>
        )}
      </CardContent>
    </Card>
  );
};

export default function InstructorDashboard() {
  const { user } = useAuth();
  const [isLoading, setIsLoading] = useState(true);
  const [summary, setSummary] = useState<InstructorSummary | null>(null);
  const [actionItems, setActionItems] = useState<ActionItems | null>(null);

  useEffect(() => {
    const fetchDashboardData = async () => {
      setIsLoading(true);
      try {
        const [summaryData, actionItemsData] = await Promise.all([
          instructorService.getDashboardSummary(),
          instructorService.getActionItems(),
        ]);
        setSummary(summaryData);
        setActionItems(actionItemsData);
      } catch (error) {
        toast.error("KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u dashboard. Vui lÃ²ng thá»­ láº¡i.");
        console.error("Dashboard fetch error:", error);
      } finally {
        setIsLoading(false);
      }
    };
    fetchDashboardData();
  }, []);

  if (isLoading && !summary) {
    return (
      <div className="flex items-center justify-center min-h-[600px]">
        <Loader2 className="h-12 w-12 animate-spin text-primary" />
      </div>
    );
  }

  return (
    <div className="space-y-8">
      <div className="bg-light-green border border-green-200 text-green-900 rounded-xl p-6">
        <h1 className="text-2xl xl:text-3xl font-bold">
          ChÃ o má»«ng, {user?.full_name}! ðŸš€
        </h1>
        <p className="text-green-800 text-base xl:text-lg">
          ÄÃ¢y lÃ  trung tÃ¢m Ä‘iá»u hÃ nh cÃ¡c khÃ³a há»c cá»§a báº¡n.
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <StatCard
          title="Tá»•ng doanh thu"
          value={summary?.total_revenue ?? 0}
          icon={DollarSign}
          isLoading={isLoading}
          formatAsCurrency
        />
        <StatCard
          title="Tá»•ng há»c viÃªn"
          value={summary?.total_students ?? 0}
          icon={Users}
          isLoading={isLoading}
        />
        <StatCard
          title="ÄÃ¡nh giÃ¡ trung bÃ¬nh"
          value={summary?.average_rating?.toFixed(1) ?? "N/A"}
          icon={Star}
          isLoading={isLoading}
        />
        <StatCard
          title="CÃ¢u há»i chá» tráº£ lá»i"
          value={summary?.pending_questions_count ?? 0}
          icon={HelpCircle}
          isLoading={isLoading}
        />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <Card className="lg:col-span-2 shadow-sm bg-white">
          <CardHeader>
            <CardTitle className="text-xl xl:text-xl">
              Thá»‘ng kÃª Doanh thu & Há»c viÃªn má»›i
            </CardTitle>
            <CardDescription className="text-base">
              Dá»¯ liá»‡u Ä‘Æ°á»£c tá»•ng há»£p theo thÃ¡ng.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="h-80 bg-gray-100 rounded-md flex items-center justify-center">
              <p className="text-muted-foreground">
                [Biá»ƒu Ä‘á»“ sáº½ Ä‘Æ°á»£c hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y]
              </p>
            </div>
          </CardContent>
        </Card>

        <Card className="shadow-sm bg-white">
          <CardHeader>
            <CardTitle className="text-xl xl:text-xl">Cáº§n báº¡n xá»­ lÃ½</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            {isLoading ? (
              <div className="space-y-4">
                <Skeleton className="h-20 w-full" />
                <Skeleton className="h-20 w-full" />
              </div>
            ) : (
              <>
                <div className="flex items-center justify-between p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                  <div>
                    <p className="font-semibold text-gray-700">
                      CÃ¢u há»i chÆ°a tráº£ lá»i
                    </p>
                    <p className="text-3xl font-bold text-gray-800">
                      {actionItems?.pending_questions?.length ?? 0}
                    </p>
                  </div>
                  <Button variant="outline" size="sm">
                    Xem ngay
                  </Button>
                </div>
                <div className="flex items-center justify-between p-4 bg-blue-50 border border-blue-200 rounded-lg">
                  <div>
                    <p className="font-semibold text-gray-700">ÄÃ¡nh giÃ¡ má»›i</p>
                    <p className="text-3xl font-bold text-gray-800">
                      {actionItems?.recent_reviews?.length ?? 0}
                    </p>
                  </div>
                  <Button variant="outline" size="sm">
                    Xem Ä‘Ã¡nh giÃ¡
                  </Button>
                </div>
              </>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}


//(protected)\instructor\my-courses\page.tsx
"use client";

import { useState, useEffect, useCallback } from "react";
import Link from "next/link";
import { toast } from "sonner";
import { courseService } from "@/lib/api/courseService";
import { Course } from "@/lib/types";
import { useAuth } from "@/lib/hooks/useAuth";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import { PlusCircle } from "lucide-react";
import Image from "next/image";

const CourseCardSkeleton = () => (
  <Card>
    <div className="flex flex-col space-y-3 p-4">
      <Skeleton className="h-40 w-full" />
      <Skeleton className="h-6 w-3/4" />
      <Skeleton className="h-5 w-1/2" />
    </div>
  </Card>
);

export default function MyCoursesPage() {
  const { user } = useAuth();
  const [courses, setCourses] = useState<Course[] | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  const fetchMyCourses = useCallback(async () => {
    if (!user) return;
    setIsLoading(true);
    try {
      const response = await courseService.listCourses({
        instructor_id: user.id,
      });

      setCourses(response.data);
    } catch (error) {
      toast.error(
        error instanceof Error
          ? error.message
          : "KhÃ´ng thá»ƒ táº£i danh sÃ¡ch khÃ³a há»c."
      );
      setCourses([]);
    } finally {
      setIsLoading(false);
    }
  }, [user]);

  useEffect(() => {
    fetchMyCourses();
  }, [fetchMyCourses]);

  if (isLoading) {
    return (
      <div className="container mx-auto py-8">
        <div className="flex justify-between items-center mb-8">
          <h1 className="text-3xl font-bold">KhÃ³a há»c cá»§a tÃ´i</h1>
          <Skeleton className="h-10 w-40" />
        </div>
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {[...Array(3)].map((_, i) => (
            <CourseCardSkeleton key={i} />
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto py-8">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">KhÃ³a há»c cá»§a tÃ´i</h1>
        <Link href="/instructor/create-course">
          <Button>
            <PlusCircle className="mr-2 h-4 w-4" /> Táº¡o khÃ³a há»c má»›i
          </Button>
        </Link>
      </div>

      {courses && courses.length > 0 ? (
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {courses.map((course) => (
            <Link
              href={`/instructor/courses/${course.course_id}`}
              key={course.course_id}
            >
              <Card className="hover:shadow-lg transition-shadow">
                <CardHeader className="p-0">
                  <Image
                    src={course.thumbnail_url || "/placeholder.png"}
                    alt={course.title}
                    width={400}
                    height={200}
                    className="rounded-t-lg w-full object-cover aspect-[16/9]"
                  />
                </CardHeader>
                <CardContent className="p-4">
                  <CardTitle className="line-clamp-2 mb-2">
                    {course.title}
                  </CardTitle>
                  <div className="flex gap-2">
                    <Badge variant="outline" className="capitalize">
                      {course.status}
                    </Badge>
                    <Badge
                      variant={
                        course.approval_status === "approved"
                          ? "default"
                          : course.approval_status === "rejected"
                          ? "destructive"
                          : "secondary"
                      }
                    >
                      {course.approval_status}
                    </Badge>
                  </div>
                </CardContent>
              </Card>
            </Link>
          ))}
        </div>
      ) : (
        <div className="text-center py-20 border-2 border-dashed rounded-lg">
          <h2 className="text-xl font-semibold">Báº¡n chÆ°a cÃ³ khÃ³a há»c nÃ o</h2>
          <p className="text-muted-foreground mt-2 mb-4">
            HÃ£y báº¯t Ä‘áº§u chia sáº» kiáº¿n thá»©c cá»§a báº¡n ngay hÃ´m nay!
          </p>
          <Link href="/instructor/create-course">
            <Button>Táº¡o khÃ³a há»c Ä‘áº§u tiÃªn</Button>
          </Link>
        </div>
      )}
    </div>
  );
}


//(protected)\instructor\profile\page.tsx
"use client";

import { useState, useEffect, useCallback } from "react";
import { useAuth } from "@/lib/hooks/useAuth";
import { UserProfile } from "@/components/shared/UserProfile";
import { instructorService } from "@/lib/api/instructorService";
import { useForm } from "react-hook-form";
import { InstructorApplicationForm, InstructorProfile } from "@/lib/types";
import { toast } from "sonner";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Loader2 } from "lucide-react";
import { ProfilePageSkeleton } from "@/components/skeleton/ProfilePageSkeleton";

// Form ná»™p/cáº­p nháº­t há»“ sÆ¡
const InstructorApplication = ({
  profile,
  onProfileUpdate,
}: {
  profile: InstructorProfile | null;
  onProfileUpdate: () => void;
}) => {
  const isUpdate = !!profile; // Náº¿u cÃ³ profile lÃ  update, khÃ´ng thÃ¬ lÃ  create
  const {
    register,
    handleSubmit,
    formState: { isDirty },
  } = useForm<InstructorApplicationForm>({
    defaultValues: {
      bio: profile?.bio || "",
      education: profile?.education || "",
      experience: profile?.experience || "",
      certificates: profile?.certificates || "",
    },
  });
  const [isSubmitting, setIsSubmitting] = useState(false);

  const onSubmit = async (data: InstructorApplicationForm) => {
    setIsSubmitting(true);
    try {
      if (isUpdate) {
        await instructorService.updateProfile(data);
      } else {
        await instructorService.createProfile(data);
      }
      toast.success(
        `Há»“ sÆ¡ Ä‘Ã£ Ä‘Æ°á»£c ${
          isUpdate ? "cáº­p nháº­t" : "ná»™p"
        } thÃ nh cÃ´ng vÃ  Ä‘ang chá» duyá»‡t láº¡i.`
      );
      onProfileUpdate(); // Táº£i láº¡i dá»¯ liá»‡u á»Ÿ component cha
    } catch (error) {
      toast.error(
        error instanceof Error ? error.message : "Thao tÃ¡c tháº¥t báº¡i."
      );
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>
          {isUpdate ? "Cáº­p nháº­t há»“ sÆ¡ giáº£ng viÃªn" : "Ná»™p há»“ sÆ¡ giáº£ng viÃªn"}
        </CardTitle>
        <CardDescription>
          Cung cáº¥p thÃ´ng tin Ä‘á»ƒ chÃºng tÃ´i cÃ³ thá»ƒ xem xÃ©t vÃ  phÃª duyá»‡t tÃ i khoáº£n
          cá»§a báº¡n.
        </CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          <div>
            <label className="text-sm font-medium">Bio</label>
            <Textarea
              {...register("bio")}
              rows={3}
              placeholder="Giá»›i thiá»‡u ngáº¯n vá» báº£n thÃ¢n vÃ  chuyÃªn mÃ´n cá»§a báº¡n..."
            />
          </div>
          <div>
            <label className="text-sm font-medium">Há»c váº¥n</label>
            <Textarea
              {...register("education")}
              rows={2}
              placeholder="CÃ¡c báº±ng cáº¥p, trÆ°á»ng Ä‘áº¡i há»c..."
            />
          </div>
          <div>
            <label className="text-sm font-medium">Kinh nghiá»‡m</label>
            <Textarea
              {...register("experience")}
              rows={2}
              placeholder="Kinh nghiá»‡m giáº£ng dáº¡y hoáº·c lÃ m viá»‡c liÃªn quan..."
            />
          </div>
          <div>
            <label className="text-sm font-medium">Chá»©ng chá»‰</label>
            <Textarea
              {...register("certificates")}
              rows={2}
              placeholder="CÃ¡c chá»©ng chá»‰ chuyÃªn mÃ´n (IELTS, TESOL...)"
            />
          </div>
          <Button type="submit" disabled={isSubmitting || !isDirty}>
            {isSubmitting ? (
              <Loader2 className="mr-2 h-4 w-4 animate-spin" />
            ) : null}
            {isUpdate ? "Cáº­p nháº­t há»“ sÆ¡" : "Ná»™p há»“ sÆ¡"}
          </Button>
        </form>
      </CardContent>
    </Card>
  );
};

// Trang Profile chÃ­nh
export default function InstructorProfilePage() {
  const { user, isLoading: isAuthLoading } = useAuth({
    redirectToLoginIfFail: true,
  });
  const [profile, setProfile] = useState<InstructorProfile | null>(null);
  const [isProfileLoading, setIsProfileLoading] = useState(true);

  const fetchProfile = useCallback(async () => {
    setIsProfileLoading(true);
    try {
      const myProfile = await instructorService.getMyProfile();
      setProfile(myProfile);
    } catch (error) {
      console.error("Failed to fetch instructor profile:", error);
      setProfile(null);
    } finally {
      setIsProfileLoading(false);
    }
  }, []);

  useEffect(() => {
    if (user) fetchProfile();
  }, [user, fetchProfile]);

  if (isAuthLoading || (isProfileLoading && !profile && user)) {
    return <ProfilePageSkeleton />;
  }
  if (!user) return null;

  return (
    <div className="container mx-auto py-8 space-y-8">
      <UserProfile user={user} />
      {profile?.approval_status === "approved" && (
        <p className="text-center p-4 bg-green-100 rounded-md text-green-800 font-medium">
          Há»“ sÆ¡ cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c phÃª duyá»‡t!
        </p>
      )}
      {profile?.approval_status === "pending" && (
        <p className="text-center p-4 bg-yellow-100 rounded-md text-yellow-800">
          Há»“ sÆ¡ cá»§a báº¡n Ä‘ang chá» duyá»‡t.
        </p>
      )}
      {profile?.approval_status === "rejected" && (
        <p className="text-center p-4 bg-red-100 rounded-md text-red-800">
          Há»“ sÆ¡ bá»‹ tá»« chá»‘i. LÃ½ do: {profile.rejection_reason}
        </p>
      )}

      <InstructorApplication profile={profile} onProfileUpdate={fetchProfile} />
    </div>
  );
}


//(protected)\learn\courses\[courseId]\layout.tsx
// app/(student)/learn/courses/[courseId]/lessons/[lessonId]/layout.tsx

// KhÃ´ng cáº§n thay Ä‘á»•i nhiá»u á»Ÿ file nÃ y, cáº¥u trÃºc hiá»‡n táº¡i lÃ  á»•n.
// NÃ³ chá»‰ cáº§n cung cáº¥p má»™t khung chung.

import Link from "next/link";
import { BookOpen } from "lucide-react";

export default function CoursePlayerLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="flex flex-col h-screen">
      {/* Header nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c loáº¡i bá» hoáº·c tÃ¹y biáº¿n náº¿u báº¡n muá»‘n header chung
          cho táº¥t cáº£ cÃ¡c trang, nhÆ°ng chÃºng ta sáº½ táº¡o má»™t header riÃªng cho trang player
          Ä‘á»ƒ cÃ³ nhiá»u chá»©c nÄƒng hÆ¡n. Hiá»‡n táº¡i cá»© Ä‘á»ƒ nguyÃªn. */}
      <header className="sticky top-0 z-50 flex items-center h-16 px-4 border-b bg-background shadow-sm md:px-6">
        <Link
          href="/student/my-courses"
          className="flex items-center gap-2 font-semibold"
        >
          <BookOpen className="h-6 w-6 text-primary" />
          <span className="hidden sm:inline text-lg">KhÃ³a há»c cá»§a tÃ´i</span>
        </Link>
        {/* ChÃºng ta sáº½ thÃªm title khÃ³a há»c vÃ  progress vÃ o Ä‘Ã¢y tá»« trang con */}
      </header>
      <div className="flex-1 flex overflow-hidden">{children}</div>
    </div>
  );
}


//(protected)\learn\courses\[courseId]\page.tsx
"use client";

import { useEffect } from "react";
import { useParams, useRouter } from "next/navigation";
import { learningService } from "@/lib/api/learningService";
import { toast } from "sonner";

export default function CourseLearnRedirectPage() {
  const params = useParams();
  const router = useRouter();
  const courseId = Number(params.courseId);

  useEffect(() => {
    if (!courseId) return;

    const findFirstLesson = async () => {
      try {
        const enrollment = await learningService.getMyCourseContent(courseId);
        const allLessons =
          enrollment.course.sections?.flatMap((s) => s.lessons || []) || [];

        if (allLessons.length === 0) {
          toast.error("KhÃ³a há»c nÃ y chÆ°a cÃ³ ná»™i dung.");
          router.replace("/student/my-courses");
          return;
        }

        // TÃ¬m bÃ i há»c Ä‘áº§u tiÃªn chÆ°a hoÃ n thÃ nh
        const completedLessonIds = new Set(
          enrollment.lessonProgress
            .filter((p) => p.status === "completed")
            .map((p) => p.lesson_id)
        );
        const firstUncompletedLesson = allLessons.find(
          (l) => !completedLessonIds.has(l.lesson_id)
        );

        // Náº¿u táº¥t cáº£ Ä‘Ã£ hoÃ n thÃ nh, Ä‘i Ä‘áº¿n bÃ i Ä‘áº§u tiÃªn. Náº¿u khÃ´ng, Ä‘i Ä‘áº¿n bÃ i chÆ°a hoÃ n thÃ nh Ä‘áº§u tiÃªn.
        const targetLesson = firstUncompletedLesson || allLessons[0];

        router.replace(
          `/learn/courses/${courseId}/lessons/${targetLesson.lesson_id}`
        );
      } catch (error) {
        console.error("Failed to find first lesson:", error);

        router.replace("/student/my-courses");
        toast.error("Lá»—i khi tÃ¬m bÃ i há»c Ä‘á»ƒ báº¯t Ä‘áº§u.");
        router.replace("/student/my-courses");
      }
    };

    findFirstLesson();
  }, [courseId, router]);

  return (
    <div className="flex h-screen items-center justify-center">
      <p>Äang táº£i khÃ³a há»c...</p>
    </div>
  );
}


//(protected)\learn\courses\[courseId]\lessons\[lessonId]\page.tsx
// app/(student)/learn/courses/[courseId]/lessons/[lessonId]/page.tsx
"use client";

import { useState, useEffect, useMemo } from "react";
import { useParams, useRouter } from "next/navigation";
import { toast } from "sonner";
import { learningService } from "@/lib/api/learningService";
import { Enrollment, Lesson } from "@/lib/types";
import { Skeleton } from "@/components/ui/skeleton";
import { CourseSidebar } from "../../_components/CourseSideBar";
import { LessonContent } from "../../_components/LessonContent";
import { CoursePlayerHeader } from "../../_components/CoursePlayerHeader"; // Component má»›i
import { cn } from "@/lib/utils";

const PlayerSkeleton = () => (
  <div className="flex h-[calc(100vh-4rem)]">
    <div className="flex-1 p-6 lg:p-8">
      <Skeleton className="h-full w-full" />
    </div>
    <div className="w-80 border-l p-4 space-y-4 hidden lg:block">
      <Skeleton className="h-full w-full" />
    </div>
  </div>
);

export default function CoursePlayerPage() {
  const params = useParams();
  const router = useRouter();
  const courseId = Number(params.courseId);
  const lessonId = Number(params.lessonId);

  const [enrollment, setEnrollment] = useState<Enrollment | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isSidebarOpen, setIsSidebarOpen] = useState(true);

  useEffect(() => {
    if (!courseId) return;
    const fetchContent = async () => {
      setIsLoading(true);
      try {
        const data = await learningService.getMyCourseContent(courseId);
        setEnrollment(data);
      } catch (error) {
        toast.error("Báº¡n khÃ´ng cÃ³ quyá»n truy cáº­p khÃ³a há»c nÃ y.");
        router.replace("/student/my-courses");
      } finally {
        setIsLoading(false);
      }
    };
    fetchContent();
  }, [courseId, router]);

  const { currentLesson, totalLessons, completedLessons } = useMemo(() => {
    if (!enrollment?.course?.sections) {
      return { currentLesson: null, totalLessons: 0, completedLessons: 0 };
    }
    let foundLesson: Lesson | null = null;
    const allLessons: Lesson[] = [];
    for (const section of enrollment.course.sections) {
      if (section.lessons) {
        allLessons.push(...section.lessons);
        if (!foundLesson) {
          const lesson = section.lessons.find((l) => l.lesson_id === lessonId);
          if (lesson) foundLesson = lesson;
        }
      }
    }
    const completedCount = enrollment.lessonProgress.filter(
      (p) => p.status === "completed"
    ).length;

    return {
      currentLesson: foundLesson,
      totalLessons: allLessons.length,
      completedLessons: completedCount,
    };
  }, [enrollment, lessonId]);

  const handleMarkComplete = async (completedLessonId: number) => {
    // ... (Giá»¯ nguyÃªn logic cá»§a báº¡n)
    try {
      await learningService.recordProgress(completedLessonId, "completed");
      toast.success("ÄÃ£ cáº­p nháº­t tiáº¿n Ä‘á»™!");
      setEnrollment((prev) => {
        if (!prev) return null;
        const newProgress = [...prev.lessonProgress];
        const progressIndex = newProgress.findIndex(
          (p) => p.lesson_id === completedLessonId
        );
        if (progressIndex > -1) {
          newProgress[progressIndex].status = "completed";
        } else {
          newProgress.push({
            progress_id: Date.now(), // Fake ID for optimistic update
            enrollment_id: prev.enrollment_id,
            lesson_id: completedLessonId,
            status: "completed",
            video_progress: 100,
          });
        }
        return { ...prev, lessonProgress: newProgress };
      });

      const allLessons =
        enrollment?.course.sections?.flatMap((s) => s.lessons || []) || [];
      const currentIndex = allLessons.findIndex(
        (l) => l.lesson_id === completedLessonId
      );
      if (currentIndex > -1 && currentIndex < allLessons.length - 1) {
        const nextLesson = allLessons[currentIndex + 1];
        router.push(
          `/learn/courses/${courseId}/lessons/${nextLesson.lesson_id}`
        );
      }
    } catch (error) {
      toast.error("KhÃ´ng thá»ƒ cáº­p nháº­t tiáº¿n Ä‘á»™.");
    }
  };

  if (isLoading) return <PlayerSkeleton />;

  if (!enrollment || !enrollment.course || !currentLesson) {
    return (
      <div className="flex-1 text-center py-20">
        KhÃ´ng tÃ¬m tháº¥y ná»™i dung bÃ i há»c.
      </div>
    );
  }

  const isCompleted = enrollment.lessonProgress.some(
    (p) => p.lesson_id === lessonId && p.status === "completed"
  );

  return (
    <div className="flex flex-col h-full w-full">
      <CoursePlayerHeader
        courseTitle={enrollment.course.title}
        completedLessons={completedLessons}
        totalLessons={totalLessons}
        onToggleSidebar={() => setIsSidebarOpen(!isSidebarOpen)}
      />
      <div className="flex flex-1 overflow-hidden">
        <main
          className={cn(
            "flex-1 overflow-y-auto transition-all duration-300",
            isSidebarOpen ? "lg:mr-[350px]" : "mr-0"
          )}
        >
          <LessonContent
            lesson={currentLesson}
            onMarkComplete={handleMarkComplete}
            isCompleted={isCompleted}
          />
        </main>
        <div
          className={cn(
            "fixed top-16 right-0 h-[calc(100vh-4rem)] w-[350px] bg-white border-l transition-transform duration-300 ease-in-out z-40",
            isSidebarOpen ? "translate-x-0" : "translate-x-full"
          )}
        >
          <CourseSidebar
            courseId={courseId}
            courseTitle={enrollment.course.title}
            sections={enrollment.course.sections || []}
            lessonProgress={enrollment.lessonProgress || []}
            currentLessonId={lessonId}
          />
        </div>
      </div>
    </div>
  );
}


//(protected)\learn\courses\[courseId]\_components\CoursePlayerHeader.tsx
// app/(student)/learn/courses/_components/CoursePlayerHeader.tsx
"use client";

import { ArrowLeft, PanelRightOpen, PanelLeft } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import Link from "next/link";

interface Props {
  courseTitle: string;
  completedLessons: number;
  totalLessons: number;
  onToggleSidebar: () => void;
}

export const CoursePlayerHeader = ({
  courseTitle,
  completedLessons,
  totalLessons,
  onToggleSidebar,
}: Props) => {
  const progressPercentage =
    totalLessons > 0 ? (completedLessons / totalLessons) * 100 : 0;

  return (
    <header className="flex h-16 items-center justify-between border-b bg-background px-4 md:px-6 shrink-0">
      <div className="flex items-center gap-4">
        <Link href="/student/my-courses">
          <Button variant="outline" size="icon" className="h-8 w-8">
            <ArrowLeft className="h-4 w-4" />
            <span className="sr-only">Quay láº¡i</span>
          </Button>
        </Link>
        <h1 className="text-lg font-semibold hidden md:block">{courseTitle}</h1>
      </div>
      <div className="flex items-center gap-4 w-full max-w-xs">
        <div className="w-full">
          <Progress value={progressPercentage} className="w-full h-2" />
          <p className="text-xs text-muted-foreground mt-1 text-right">
            HoÃ n thÃ nh {completedLessons}/{totalLessons} bÃ i
          </p>
        </div>
      </div>
      <div className="flex items-center gap-2">
        {/* NÃºt nÃ y sáº½ hiá»‡n á»Ÿ mÃ n hÃ¬nh lá»›n Ä‘á»ƒ Ä‘Ã³ng/má»Ÿ sidebar */}
        <Button
          variant="outline"
          size="icon"
          onClick={onToggleSidebar}
          className="h-8 w-8"
        >
          <PanelRightOpen className="h-4 w-4" />
          <span className="sr-only">Toggle Sidebar</span>
        </Button>
      </div>
    </header>
  );
};


//(protected)\learn\courses\[courseId]\_components\CourseSideBar.tsx
// app/(student)/learn/courses/_components/CourseSideBar.tsx
"use client";

import Link from "next/link";
// Äáº£m báº£o báº¡n Ä‘Ã£ import cÃ¡c type nÃ y
import { Section, LessonProgress } from "@/lib/types";
import { CheckCircle, Circle, PlayCircle } from "lucide-react";
import { cn } from "@/lib/utils";
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "@/components/ui/accordion";
import { useMemo } from "react";

// THÃŠM Äá»ŠNH NGHÄ¨A NÃ€Y VÃ€O
interface Props {
  courseId: number;
  courseTitle: string;
  sections: Section[];
  lessonProgress: LessonProgress[];
  currentLessonId: number;
}

export const CourseSidebar = ({
  courseId,
  courseTitle,
  sections,
  lessonProgress,
  currentLessonId,
}: Props) => {
  const progressMap = new Map(
    lessonProgress.map((p) => [p.lesson_id, p.status])
  );

  const activeSectionValue = useMemo(() => {
    const activeSection = sections.find((section) =>
      section.lessons?.some((lesson) => lesson.lesson_id === currentLessonId)
    );
    return activeSection ? `section-${activeSection.section_id}` : undefined;
  }, [sections, currentLessonId]);

  return (
    <aside className="h-full flex flex-col bg-white">
      <div className="p-4 border-b">
        <h2 className="text-xl font-bold line-clamp-2">Ná»™i dung khÃ³a há»c</h2>
        <p className="text-sm text-muted-foreground">{courseTitle}</p>
      </div>
      <nav className="flex-1 overflow-y-auto">
        <Accordion
          type="single"
          collapsible
          className="w-full"
          defaultValue={activeSectionValue}
        >
          {sections.map((section, sectionIndex) => (
            <AccordionItem
              value={`section-${section.section_id}`}
              key={section.section_id}
            >
              <AccordionTrigger className="px-4 py-3 text-left hover:no-underline hover:bg-slate-50">
                <div className="flex flex-col">
                  <span className="font-semibold text-sm">
                    Pháº§n {sectionIndex + 1}: {section.title}
                  </span>
                </div>
              </AccordionTrigger>
              <AccordionContent className="p-0">
                <ul className="space-y-0">
                  {section.lessons?.map((lesson) => {
                    const isCompleted =
                      progressMap.get(lesson.lesson_id) === "completed";
                    const isActive = lesson.lesson_id === currentLessonId;

                    return (
                      <li key={lesson.lesson_id}>
                        <Link
                          href={`/learn/courses/${courseId}/lessons/${lesson.lesson_id}`}
                          className={cn(
                            "flex items-start gap-3 p-4 text-sm transition-colors border-b border-b-slate-100",
                            isActive
                              ? "bg-blue-50 text-primary font-medium"
                              : "text-gray-700 hover:bg-slate-50"
                          )}
                        >
                          {isActive ? (
                            <PlayCircle className="h-5 w-5 mt-0.5 text-blue-600 flex-shrink-0" />
                          ) : isCompleted ? (
                            <CheckCircle className="h-5 w-5 mt-0.5 text-green-500 flex-shrink-0" />
                          ) : (
                            <Circle className="h-5 w-5 mt-0.5 text-gray-300 flex-shrink-0" />
                          )}
                          <span className="flex-1">{lesson.title}</span>
                        </Link>
                      </li>
                    );
                  })}
                </ul>
              </AccordionContent>
            </AccordionItem>
          ))}
        </Accordion>
      </nav>
    </aside>
  );
};


//(protected)\learn\courses\[courseId]\_components\LessonContent.tsx
// app/(student)/learn/courses/_components/LessonContent.tsx
"use client";

// Äáº£m báº£o báº¡n Ä‘Ã£ import cÃ¡c type nÃ y
import { Lesson, LessonResource } from "@/lib/types";
import { Button } from "@/components/ui/button";
import {
  CheckCircle,
  Download,
  FileText,
  Info,
  MessageSquare,
  Notebook,
} from "lucide-react";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Separator } from "@/components/ui/separator";

// THÃŠM Äá»ŠNH NGHÄ¨A NÃ€Y VÃ€O
interface Props {
  lesson: Lesson;
  onMarkComplete: (lessonId: number) => void;
  isCompleted: boolean;
}

const ResourceItem = ({ resource }: { resource: LessonResource }) => (
  <a
    href={resource.file_url}
    target="_blank"
    rel="noopener noreferrer"
    className="flex items-center gap-3 p-3 bg-slate-100 hover:bg-slate-200 rounded-md transition-colors"
  >
    <Download className="h-5 w-5 text-primary" />
    <div className="flex-1">
      <p className="font-medium text-sm">{resource.title}</p>
      {resource.file_size && (
        <p className="text-xs text-muted-foreground">
          ({(resource.file_size / 1024 / 1024).toFixed(2)} MB)
        </p>
      )}
    </div>
  </a>
);

export const LessonContent = ({
  lesson,
  onMarkComplete,
  isCompleted,
}: Props) => {
  const getEmbedUrl = (url: string) => {
    let videoId = "";
    if (url.includes("youtube.com/watch?v=")) {
      videoId = new URL(url).searchParams.get("v") || "";
    } else if (url.includes("youtu.be/")) {
      videoId = new URL(url).pathname.slice(1);
    }
    return videoId ? `https://www.youtube.com/embed/${videoId}` : "";
  };

  const embedUrl = lesson.video_url ? getEmbedUrl(lesson.video_url) : "";

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {lesson.lesson_type === "video" && embedUrl && (
        <div className="aspect-video bg-black rounded-lg overflow-hidden shadow-lg mb-6">
          <iframe
            className="w-full h-full"
            src={embedUrl}
            title={lesson.title}
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowFullScreen
          ></iframe>
        </div>
      )}

      <header className="mb-6">
        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <h1 className="text-2xl lg:text-3xl font-bold tracking-tight">
            {lesson.title}
          </h1>
          <Button
            size="lg"
            onClick={() => onMarkComplete(lesson.lesson_id)}
            disabled={isCompleted}
            className="shrink-0"
          >
            <CheckCircle className="mr-2 h-5 w-5" />
            {isCompleted ? "ÄÃ£ hoÃ n thÃ nh" : "ÄÃ¡nh dáº¥u Ä‘Ã£ hoÃ n thÃ nh"}
          </Button>
        </div>
      </header>

      <Separator className="mb-6" />

      <Tabs defaultValue="overview" className="w-full">
        <TabsList className="grid w-full grid-cols-2 md:grid-cols-4 mb-6">
          <TabsTrigger value="overview">
            <Info className="w-4 h-4 mr-2" />
            MÃ´ táº£
          </TabsTrigger>
          <TabsTrigger value="resources">
            <Download className="w-4 h-4 mr-2" />
            TÃ i liá»‡u
          </TabsTrigger>
          <TabsTrigger value="qna">
            <MessageSquare className="w-4 h-4 mr-2" />
            Há»i & ÄÃ¡p
          </TabsTrigger>
          <TabsTrigger value="notes">
            <Notebook className="w-4 h-4 mr-2" />
            Ghi chÃº
          </TabsTrigger>
        </TabsList>

        <TabsContent value="overview">
          <div className="prose max-w-none p-6 border rounded-lg bg-white">
            {lesson.description && <p className="lead">{lesson.description}</p>}
            {lesson.lesson_type === "document" && lesson.content && (
              <div dangerouslySetInnerHTML={{ __html: lesson.content }} />
            )}
            {lesson.lesson_type === "quiz" && (
              <div className="text-center p-8 border-2 border-dashed rounded-lg bg-blue-50">
                <p className="text-xl font-semibold">
                  BÃ i kiá»ƒm tra: {lesson.title}
                </p>
                <Button className="mt-6" size="lg">
                  Báº¯t Ä‘áº§u lÃ m bÃ i
                </Button>
              </div>
            )}
          </div>
        </TabsContent>

        <TabsContent value="resources">
          <div className="p-6 border rounded-lg bg-white">
            <h3 className="text-lg font-semibold mb-4">TÃ i liá»‡u bÃ i há»c</h3>
            {lesson.resources && lesson.resources.length > 0 ? (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {lesson.resources.map((res) => (
                  <ResourceItem key={res.resource_id} resource={res} />
                ))}
              </div>
            ) : (
              <p className="text-muted-foreground">
                KhÃ´ng cÃ³ tÃ i liá»‡u nÃ o cho bÃ i há»c nÃ y.
              </p>
            )}
          </div>
        </TabsContent>

        <TabsContent value="qna">
          <div className="p-6 border rounded-lg bg-white text-center">
            <h3 className="text-lg font-semibold mb-2">Há»i & ÄÃ¡p</h3>
            <p className="text-muted-foreground">
              TÃ­nh nÄƒng nÃ y Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn.
            </p>
          </div>
        </TabsContent>

        <TabsContent value="notes">
          <div className="p-6 border rounded-lg bg-white text-center">
            <h3 className="text-lg font-semibold mb-2">Ghi chÃº cÃ¡ nhÃ¢n</h3>
            <p className="text-muted-foreground">
              TÃ­nh nÄƒng nÃ y Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn.
            </p>
          </div>
        </TabsContent>
      </Tabs>
    </div>
  );
};


//(protected)\student\layout.tsx
// student/layout.tsx
"use client";

import Link from "next/link";
import { useRouter } from "next/navigation";
import { useAuth } from "@/lib/hooks/useAuth";
import { clearAuthData } from "@/lib/auth/utils";
import { Button } from "@/components/ui/button";
import { Logo } from "@/app/page";
import {
  User,
  LogOut,
  Loader2,
  LayoutDashboard,
  BookMarked,
  History,
} from "lucide-react";
import { useEffect } from "react";

const navItems = [
  { href: "/student/dashboard", icon: LayoutDashboard, label: "Tá»•ng quan" },
  { href: "/student/my-courses", icon: BookMarked, label: "KhÃ³a há»c cá»§a tÃ´i" },
  { href: "/student/transactions", icon: History, label: "Lá»‹ch sá»­ giao dá»‹ch" },
];

export default function StudentLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const router = useRouter();
  const { user, isLoading } = useAuth({ redirectToLoginIfFail: true });

  useEffect(() => {
    if (!isLoading && user && user.role !== "student") {
      router.replace(`/${user.role}/dashboard`);
    }
  }, [isLoading, user, router]);

  if (isLoading || !user) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <Loader2 className="h-12 w-12 animate-spin text-brand-blue" />
      </div>
    );
  }

  const handleLogout = () => {
    clearAuthData();
    router.push("/");
  };

  return (
    <div className="min-h-screen bg-brand-background">
      <header className="bg-white sticky top-0 z-50 border-b">
        <div className="flex justify-between items-center h-20 lg:h-24 w-full px-4 md:px-8 lg:px-12 py-5">
          <Logo />
          <nav className="hidden md:flex items-center gap-6 lg:gap-8">
            {navItems.map((item) => (
              <Link
                key={item.href}
                href={item.href}
                className="flex items-center gap-2 text-base lg:text-lg xl:text-3xl font-medium text-gray-600 hover:text-primary transition-colors"
              >
                <item.icon className="h-5 w-5 lg:h-6 lg:w-6" />
                {item.label}
              </Link>
            ))}
          </nav>
          <div className="flex items-center gap-4">
            <Link
              href="/instructor/profile"
              className="flex items-center gap-2 text-sm lg:text-lg xl:text-xl  font-semibold text-gray-700 hover:text-primary"
            >
              <User className="h-5 w-5" />
              <span>{user.full_name}</span>
            </Link>
            <Button
              variant="ghost"
              size="sm"
              onClick={handleLogout}
              className="text-gray-600 hover:bg-red-50 hover:text-red-600 lg:text-lg xl:text-xl "
            >
              <LogOut className="mr-2 h-4 w-4" /> ÄÄƒng xuáº¥t
            </Button>
          </div>
        </div>
      </header>

      <main className="container mx-auto py-8 lg:py-12 px-4 lg:px-6">
        {children}
      </main>
    </div>
  );
}


//(protected)\student\dashboard\page.tsx
"use client";

import { useState, useEffect } from "react";
import Link from "next/link";
import { toast } from "sonner";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { Skeleton } from "@/components/ui/skeleton";
import {
  BookOpen,
  Trophy,
  Clock,
  PlayCircle,
  ArrowRight,
  Activity,
  CheckCircle,
  HelpCircle,
} from "lucide-react";
import type { LucideProps } from "lucide-react";
import { useAuth } from "@/lib/hooks/useAuth";
import { learningService } from "@/lib/api/learningService";
import { Enrollment, RecentActivity, StudentStats } from "@/lib/types";
import { formatDistanceToNow } from "date-fns";
import { vi } from "date-fns/locale";

// StatCard (giá»¯ nguyÃªn, khÃ´ng thay Ä‘á»•i)
interface StatCardProps {
  title: string;
  value: number;
  unit: string;
  icon: React.ForwardRefExoticComponent<
    Omit<LucideProps, "ref"> & React.RefAttributes<SVGSVGElement>
  >;
  isLoading: boolean;
}
const StatCard = ({
  title,
  value,
  unit,
  icon: Icon,
  isLoading,
}: StatCardProps) => (
  <Card className="shadow-sm hover:shadow-lg transition-shadow bg-white">
    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-3">
      <CardTitle className="text-base xl:text-lg font-medium text-gray-500">
        {title}
      </CardTitle>
      <Icon className="h-6 w-6 text-gray-400" />
    </CardHeader>
    <CardContent>
      {isLoading ? (
        <Skeleton className="h-10 xl:h-12 w-1/2 mt-2" />
      ) : (
        <>
          <span className="text-3xl xl:text-4xl font-bold text-gray-900">
            {value.toLocaleString("vi-VN")}
          </span>
          <span className="text-base xl:text-lg text-muted-foreground ml-2">
            {unit}
          </span>
        </>
      )}
    </CardContent>
  </Card>
);

const ActivityItem = ({ activity }: { activity: RecentActivity }) => {
  const getIcon = () => {
    switch (activity.type) {
      case "lesson_completed":
        return <CheckCircle className="h-5 w-5 text-green-600" />;
      case "quiz_submitted":
        return <HelpCircle className="h-5 w-5 text-blue-600" />;
      case "course_enrolled":
        return <BookOpen className="h-5 w-5 text-purple-600" />;
      default:
        return <Activity className="h-5 w-5 text-gray-600" />;
    }
  };
  return (
    <div className="flex items-start gap-4 p-4 hover:bg-gray-50 rounded-lg">
      <div className="pt-1">{getIcon()}</div>
      <div>
        <p className="font-medium text-base xl:text-lg text-gray-800">
          {activity.title}
        </p>
        <p className="text-sm xl:text-base text-gray-500">
          {activity.course_title}
        </p>
        <p className="text-xs xl:text-sm text-gray-400 mt-1">
          {formatDistanceToNow(new Date(activity.timestamp), {
            addSuffix: true,
            locale: vi,
          })}
        </p>
      </div>
    </div>
  );
};

export default function StudentDashboard() {
  const { user } = useAuth();
  const [enrollments, setEnrollments] = useState<Enrollment[] | null>(null);
  const [stats, setStats] = useState<StudentStats | null>(null);
  const [activities, setActivities] = useState<RecentActivity[] | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const fetchData = async () => {
      try {
        setIsLoading(true);
        // Gá»i 3 API song song Ä‘á»ƒ tá»‘i Æ°u tá»‘c Ä‘á»™ táº£i
        const [enrollmentsResponse, statsResponse, activitiesResponse] =
          await Promise.all([
            learningService.getMyEnrollments({ limit: 3 }), // Chá»‰ láº¥y 3 khÃ³a gáº§n nháº¥t
            learningService.getMyStats(),
            learningService.getActivityFeed(5), // Láº¥y 5 hoáº¡t Ä‘á»™ng gáº§n nháº¥t
          ]);

        setEnrollments(enrollmentsResponse.data);
        setStats(statsResponse);
        setActivities(activitiesResponse);
      } catch (error) {
        toast.error("KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u dashboard. Vui lÃ²ng thá»­ láº¡i.");
        console.error("Dashboard fetch error:", error);
      } finally {
        setIsLoading(false);
      }
    };
    fetchData();
  }, []);

  const coursesInProgress =
    enrollments?.filter((e) => e.status === "active") || [];

  return (
    <div className="space-y-10">
      <div className="bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl shadow-lg p-8 lg:p-10">
        <h1 className="text-2xl md:text-3xl xl:text-4xl font-bold mb-2">
          ChÃ o má»«ng trá»Ÿ láº¡i, {user?.full_name}! ðŸ‘‹
        </h1>
        <p className="text-indigo-100 text-base xl:text-lg">
          HÃ£y tiáº¿p tá»¥c hÃ nh trÃ¬nh chinh phá»¥c tiáº¿ng Anh cá»§a báº¡n.
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <StatCard
          title="KhÃ³a há»c Ä‘Ã£ Ä‘Äƒng kÃ½"
          value={stats?.total_courses_enrolled ?? 0}
          icon={BookOpen}
          unit="khÃ³a"
          isLoading={isLoading}
        />
        <StatCard
          title="KhÃ³a há»c hoÃ n thÃ nh"
          value={stats?.total_courses_completed ?? 0}
          icon={Trophy}
          unit="khÃ³a"
          isLoading={isLoading}
        />
        <StatCard
          title="Giá» há»c tÃ­ch lÅ©y"
          value={Math.round(stats?.total_hours_learned ?? 0)}
          icon={Clock}
          unit="giá»"
          isLoading={isLoading}
        />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <Card className="bg-white shadow-sm lg:col-span-2">
          <CardHeader className="flex flex-row justify-between items-center pb-6">
            <div>
              <CardTitle className="text-xl xl:text-xl mb-1">
                CÃ¡c khÃ³a há»c Ä‘ang tham gia
              </CardTitle>
              <CardDescription className="text-base xl:text-lg">
                Tiáº¿p tá»¥c tá»« nÆ¡i báº¡n Ä‘Ã£ dá»«ng láº¡i.
              </CardDescription>
            </div>
            <Link href="/student/my-courses">
              <Button variant="ghost" className="text-base xl:text-lg">
                Xem táº¥t cáº£ <ArrowRight className="ml-2 h-5 w-5" />
              </Button>
            </Link>
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {[...Array(2)].map((_, i) => (
                  <Skeleton key={i} className="h-64 w-full" />
                ))}
              </div>
            ) : coursesInProgress.length > 0 ? (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {coursesInProgress.map((enrollment) => (
                  <Card
                    key={enrollment.enrollment_id}
                    className="flex flex-col border hover:border-primary transition-colors hover:shadow-md"
                  >
                    <CardHeader>
                      <CardTitle className="line-clamp-2 text-lg xl:text-xl h-14">
                        {enrollment.course.title}
                      </CardTitle>
                      <CardDescription className="text-base">
                        {enrollment.course.instructor?.full_name || "Admin"}
                      </CardDescription>
                    </CardHeader>
                    <CardContent className="flex-grow flex flex-col justify-end mt-4">
                      <div className="mb-4">
                        <div className="flex justify-between text-sm text-gray-500 mb-2">
                          <span>Tiáº¿n Ä‘á»™</span>
                          <span className="font-semibold">
                            {enrollment.completion_percentage}%
                          </span>
                        </div>
                        <Progress
                          value={enrollment.completion_percentage}
                          className="h-2"
                        />
                      </div>
                      <Link href={`/learn/courses/${enrollment.course_id}`}>
                        <Button className="w-full text-base py-6">
                          <PlayCircle className="mr-2 h-5 w-5" /> Tiáº¿p tá»¥c há»c
                        </Button>
                      </Link>
                    </CardContent>
                  </Card>
                ))}
              </div>
            ) : (
              <div className="text-center py-16 border-2 border-dashed rounded-lg bg-gray-50">
                <h3 className="text-xl xl:text-xl font-semibold text-gray-800 mb-3">
                  Báº¡n chÆ°a tham gia khÃ³a há»c nÃ o
                </h3>
                <p className="text-muted-foreground mt-2 mb-6 text-base xl:text-lg">
                  HÃ£y khÃ¡m phÃ¡ vÃ  báº¯t Ä‘áº§u hÃ nh trÃ¬nh cá»§a báº¡n ngay!
                </p>
                <Link href="/courses">
                  <Button className="text-base py-6 px-8">
                    KhÃ¡m phÃ¡ khÃ³a há»c
                  </Button>
                </Link>
              </div>
            )}
          </CardContent>
        </Card>

        <Card className="bg-white shadow-sm">
          <CardHeader>
            <CardTitle className="text-xl xl:text-xl flex items-center gap-2">
              <Activity /> Hoáº¡t Ä‘á»™ng gáº§n Ä‘Ã¢y
            </CardTitle>
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <div className="space-y-4">
                {[...Array(5)].map((_, i) => (
                  <Skeleton key={i} className="h-16 w-full" />
                ))}
              </div>
            ) : activities && activities.length > 0 ? (
              <div className="space-y-2">
                {activities.map((activity, index) => (
                  <ActivityItem key={index} activity={activity} />
                ))}
              </div>
            ) : (
              <p className="text-muted-foreground text-center py-10">
                KhÃ´ng cÃ³ hoáº¡t Ä‘á»™ng nÃ o gáº§n Ä‘Ã¢y.
              </p>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}


//(protected)\student\my-courses\page.tsx
"use client";

import { useState, useEffect } from "react";
import Link from "next/link";
import Image from "next/image";
import { toast } from "sonner";
import { learningService } from "@/lib/api/learningService";
import { Enrollment } from "@/lib/types";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Progress } from "@/components/ui/progress"; // Component thanh tiáº¿n Ä‘á»™

const MyCoursesSkeleton = () => (
  <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {[...Array(3)].map((_, i) => (
      <Card key={i}>
        <Skeleton className="h-64 w-full" />
      </Card>
    ))}
  </div>
);

export default function MyCoursesPage() {
  const [enrollments, setEnrollments] = useState<Enrollment[] | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const fetchEnrollments = async () => {
      setIsLoading(true);
      try {
        const response = await learningService.getMyEnrollments();
        // API cá»§a báº¡n tráº£ vá» data trong data ná»¯a, nÃªn lÃ  response.data.data
        // Cáº§n kiá»ƒm tra láº¡i cáº¥u trÃºc API response cá»§a báº¡n náº¿u cáº§n
        setEnrollments(response.data);
      } catch (error) {
        toast.error("KhÃ´ng thá»ƒ táº£i cÃ¡c khÃ³a há»c cá»§a báº¡n.");
      } finally {
        setIsLoading(false);
      }
    };
    fetchEnrollments();
  }, []);

  if (isLoading) {
    return <MyCoursesSkeleton />;
  }

  return (
    <div className="container mx-auto py-8">
      <h1 className="text-3xl font-bold mb-8">KhÃ³a há»c cá»§a tÃ´i</h1>
      {enrollments && enrollments.length > 0 ? (
        <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {enrollments.map((enrollment) => (
            <Card key={enrollment.enrollment_id} className="flex flex-col">
              <CardHeader className="p-0">
                <Image
                  src={enrollment.course.thumbnail_url || "/placeholder.png"}
                  alt={enrollment.course.title}
                  width={400}
                  height={200}
                  className="rounded-t-lg w-full object-cover"
                />
              </CardHeader>
              <CardContent className="p-4 flex flex-col grow">
                <h3 className="font-semibold text-lg line-clamp-2 grow">
                  {enrollment.course.title}
                </h3>
                <div className="mt-4">
                  <div className="flex justify-between text-sm text-gray-500 mb-1">
                    <span>Tiáº¿n Ä‘á»™</span>
                    <span>{enrollment.completion_percentage}%</span>
                  </div>
                  <Progress value={enrollment.completion_percentage} />
                </div>
                <Link
                  href={`/learn/courses/${enrollment.course_id}`}
                  className="mt-4"
                >
                  <Button className="w-full">VÃ o há»c</Button>
                </Link>
              </CardContent>
            </Card>
          ))}
        </div>
      ) : (
        <div className="text-center py-20 border-2 border-dashed rounded-lg">
          <h2 className="text-xl font-semibold">
            Báº¡n chÆ°a tham gia khÃ³a há»c nÃ o
          </h2>
          <Link href="/courses" className="mt-4 inline-block">
            <Button>KhÃ¡m phÃ¡ khÃ³a há»c</Button>
          </Link>
        </div>
      )}
    </div>
  );
}


//(protected)\student\my-enrollments\page.tsx
export default function MyEnrollmentsPage() {
  return (
    <div>
      <h1 className="text-2xl font-bold">Student: My Enrollments</h1>
      <p>This is a placeholder page for students to view their enrollments.</p>
    </div>
  );
}


//(protected)\student\profile\page.tsx
"use client";

import { useAuth } from "@/lib/hooks/useAuth";
import { UserProfile } from "@/components/shared/UserProfile"; // Import component chung
import { Skeleton } from "@/components/ui/skeleton"; // CÃ³ thá»ƒ dÃ¹ng láº¡i skeleton
import { ProfilePageSkeleton } from "@/components/skeleton/ProfilePageSkeleton";

export default function StudentProfilePage() {
  const { user, isLoading } = useAuth({ redirectToLoginIfFail: true });

  if (isLoading) {
    return <ProfilePageSkeleton />;
  }

  if (!user) {
    return null;
  }

  return (
    <div>
      <h1 className="text-3xl font-bold mb-8 text-center">Trang cÃ¡ nhÃ¢n</h1>
      <UserProfile user={user} />
    </div>
  );
}


//(public)\layout.tsx
"use client";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { useAuth } from "@/lib/hooks/useAuth";
import { Header } from "../page";

const PublicFooter = () => (
  <footer className="bg-gray-800 text-gray-400 py-8">
    <div className="container mx-auto text-center text-sm">
      <p>Â© 2025 EngBreaking. Ná»n táº£ng há»c tiáº¿ng Anh trá»±c tuyáº¿n.</p>
    </div>
  </footer>
);

export default function PublicLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="min-h-screen flex flex-col">
      <Header />
      <main className="grow">{children}</main>{" "}
      {/* Sá»­a láº¡i className tá»« 'flex-grow' thÃ nh 'grow' cho tailwindcss v4 */}
      <PublicFooter />
    </div>
  );
}


//(public)\courses\CoursesClientComponent.tsx
"use client";

import { useState, useEffect, useCallback } from "react";
import { useSearchParams, useRouter, usePathname } from "next/navigation";
import { toast } from "sonner";
import { courseService } from "@/lib/api/courseService";
import { Course, Category } from "@/lib/types";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardFooter,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Badge } from "@/components/ui/badge";
import Link from "next/link";
import { useDebounce } from "use-debounce";
import Image from "next/image";

// Component con cho tá»«ng tháº» khÃ³a há»c
const CourseCard = ({ course }: { course: Course }) => (
  <Link href={`/courses/${course.course_id}`}>
    <Card className="h-full flex flex-col hover:shadow-lg transition-shadow">
      <CardHeader className="p-0">
        <div className="relative w-full h-40">
          <Image
            src={course.thumbnail_url || "/placeholder.png"}
            alt={course.title}
            fill
            style={{ objectFit: "cover" }}
            className="rounded-t-lg"
          />
        </div>
      </CardHeader>
      <CardContent className="flex-grow p-4">
        <Badge variant="secondary" className="mb-2">
          {course.category?.name || "Uncategorized"}
        </Badge>
        <h3 className="font-semibold text-lg line-clamp-2">{course.title}</h3>
      </CardContent>
      <CardFooter className="p-4 flex justify-between items-center">
        <p className="text-lg font-bold text-primary">
          {new Intl.NumberFormat("vi-VN", {
            style: "currency",
            currency: "VND",
          }).format(course.price)}
        </p>
        <Badge variant="outline" className="capitalize">
          {course.level}
        </Badge>
      </CardFooter>
    </Card>
  </Link>
);

// Component Skeleton
const CourseGridSkeleton = () => (
  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    {[...Array(8)].map((_, i) => (
      <Card key={i}>
        <div className="flex flex-col space-y-3 p-4">
          <Skeleton className="h-40 w-full" />
          <Skeleton className="h-6 w-3/4" />
          <Skeleton className="h-5 w-1/2" />
        </div>
      </Card>
    ))}
  </div>
);

export default function CoursesPage() {
  const pathname = usePathname();
  const searchParams = useSearchParams();

  const [courses, setCourses] = useState<Course[] | null>(null);
  const [categories, setCategories] = useState<Category[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  // State cho bá»™ lá»c, Ä‘á»c giÃ¡ trá»‹ ban Ä‘áº§u tá»« URL
  const [searchTerm, setSearchTerm] = useState(
    searchParams.get("search") || ""
  );
  const [selectedCategory, setSelectedCategory] = useState(
    searchParams.get("category_id") || ""
  );

  const [debouncedSearch] = useDebounce(searchTerm, 500);

  // âœ… 1. Di chuyá»ƒn setIsLoading(true) vÃ o cÃ¡c hÃ m handler
  const handleSearchChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setIsLoading(true);
    setSearchTerm(e.target.value);
  };

  const handleCategoryChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    setIsLoading(true);
    setSelectedCategory(e.target.value);
  };

  // Fetch categories chá»‰ má»™t láº§n
  useEffect(() => {
    courseService
      .listCategories()
      .then(setCategories)
      .catch(() => toast.error("KhÃ´ng thá»ƒ táº£i danh má»¥c."));
  }, []);

  // Fetch courses khi filter thay Ä‘á»•i
  useEffect(() => {
    const params = new URLSearchParams();
    if (debouncedSearch) params.set("search", debouncedSearch);
    if (selectedCategory) params.set("category_id", selectedCategory);

    const newUrl = `${pathname}?${params.toString()}`;
    window.history.pushState(null, "", newUrl);

    courseService
      .listCourses({
        search: debouncedSearch,
        category_id: selectedCategory ? Number(selectedCategory) : undefined,
        status: "published",
        approval_status: "approved",
      })
      .then((response) => setCourses(response.data))
      .catch((err) => {
        toast.error(err.message || "Lá»—i khi táº£i khÃ³a há»c.");
        setCourses([]);
      })
      .finally(() => setIsLoading(false));
  }, [debouncedSearch, selectedCategory, pathname]);

  return (
    <div className="container mx-auto py-12">
      <header className="text-center mb-12">
        <h1 className="text-4xl font-bold">KhÃ¡m phÃ¡ KhÃ³a há»c</h1>
        <p className="text-muted-foreground mt-2">
          TÃ¬m kiáº¿m khÃ³a há»c phÃ¹ há»£p vá»›i báº¡n tá»« hÃ ng trÄƒm lá»±a chá»n.
        </p>
      </header>

      <div className="flex flex-col md:flex-row gap-4 mb-8">
        <Input
          placeholder="TÃ¬m kiáº¿m khÃ³a há»c..."
          className="flex-grow"
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
        />
        <select
          value={selectedCategory}
          onChange={(e) => setSelectedCategory(e.target.value)}
          className="border p-2 rounded-md bg-background"
        >
          <option value="">Táº¥t cáº£ danh má»¥c</option>
          {categories.map((cat) => (
            <option key={cat.category_id} value={cat.category_id}>
              {cat.name}
            </option>
          ))}
        </select>
      </div>

      {isLoading ? (
        <CourseGridSkeleton />
      ) : courses && courses.length > 0 ? (
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          {courses.map((course) => (
            <CourseCard key={course.course_id} course={course} />
          ))}
        </div>
      ) : (
        <div className="text-center py-20">
          <h2 className="text-xl font-semibold">KhÃ´ng tÃ¬m tháº¥y khÃ³a há»c nÃ o</h2>
          <p className="text-muted-foreground mt-2">
            Vui lÃ²ng thá»­ láº¡i vá»›i tá»« khÃ³a hoáº·c bá»™ lá»c khÃ¡c.
          </p>
        </div>
      )}

      {/* Pagination cÃ³ thá»ƒ thÃªm á»Ÿ Ä‘Ã¢y */}
    </div>
  );
}


//(public)\courses\page.tsx
import { Suspense } from "react";
import CoursesClientComponent from "./CoursesClientComponent";
import { Skeleton } from "@/components/ui/skeleton";

const CoursesPageSkeleton = () => (
  <div className="container mx-auto py-12">
    <header className="text-center mb-12">
      <Skeleton className="h-10 w-1/2 mx-auto" />
      <Skeleton className="h-5 w-3/4 mx-auto mt-4" />
    </header>
    <div className="flex flex-col md:flex-row gap-4 mb-8">
      <Skeleton className="h-10 grow" />
      <Skeleton className="h-10 w-48" />
    </div>
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      {[...Array(8)].map((_, i) => (
        <div key={i} className="flex flex-col space-y-3 p-4 border rounded-lg">
          <Skeleton className="h-40 w-full" />
          <Skeleton className="h-6 w-3/4" />
          <Skeleton className="h-5 w-1/2" />
        </div>
      ))}
    </div>
  </div>
);

export default function CoursesPage() {
  return (
    <Suspense fallback={<CoursesPageSkeleton />}>
      <CoursesClientComponent />
    </Suspense>
  );
}


//(public)\courses\[id]\page.tsx
"use client";

import { useState, useEffect } from "react";
import { useParams } from "next/navigation";
import Image from "next/image";
import { toast } from "sonner";
import { courseService } from "@/lib/api/courseService";
import { Course } from "@/lib/types";
import { Button } from "@/components/ui/button";
import { Skeleton } from "@/components/ui/skeleton";
import { Clock, BarChart, Users, PlayCircle, Lock, Star } from "lucide-react";
import { Card, CardContent, CardHeader } from "@/components/ui/card";
import { useAuth } from "@/lib/hooks/useAuth";
import { useRouter } from "next/navigation";
import { paymentService } from "@/lib/api/paymentService";

// Component Skeleton cho trang chi tiáº¿t
const CourseDetailSkeleton = () => (
  <div className="container mx-auto py-12">
    <div className="grid md:grid-cols-3 gap-8">
      <div className="md:col-span-2 space-y-6">
        <Skeleton className="h-8 w-3/4" />
        <Skeleton className="h-5 w-full" />
        <Skeleton className="h-5 w-5/6" />
        <Skeleton className="h-64 w-full rounded-lg" />
        <Skeleton className="h-8 w-1/3 mt-4" />
        <Skeleton className="h-48 w-full" />
      </div>
      <div className="space-y-4">
        <Skeleton className="h-64 w-full" />
      </div>
    </div>
  </div>
);

export default function CourseDetailPage() {
  const params = useParams();
  const courseId = Number(params.id);
  const { user, isAuthenticated } = useAuth(); // Láº¥y thÃ´ng tin user
  const [course, setCourse] = useState<Course | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const router = useRouter();
  const [isPurchasing, setIsPurchasing] = useState(false);
  const handlePurchase = async () => {
    if (!isAuthenticated || !user) {
      toast.info("Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ mua khÃ³a há»c.");
      router.push(`/login?redirect=/courses/${courseId}`);
      return;
    }

    setIsPurchasing(true);
    try {
      // BÆ°á»›c 1: Táº¡o giao dá»‹ch
      toast.loading("Äang táº¡o giao dá»‹ch...");
      const transaction = await paymentService.createTransaction([courseId]);

      // BÆ°á»›c 2: MÃ´ phá»ng thanh toÃ¡n vÃ  checkout
      // (Trong thá»±c táº¿, bÆ°á»›c nÃ y sáº½ chuyá»ƒn hÆ°á»›ng Ä‘áº¿n cá»•ng thanh toÃ¡n)
      toast.loading("Äang xá»­ lÃ½ thanh toÃ¡n...");
      await paymentService.checkout({
        transaction_id: transaction.transaction_id,
        payment_method: "e_wallet", // Giáº£ láº­p
        payment_gateway: "MockGateway", // Giáº£ láº­p
      });

      toast.dismiss(); // XÃ³a cÃ¡c toast loading
      toast.success("Mua khÃ³a há»c thÃ nh cÃ´ng! Báº¡n sáº½ Ä‘Æ°á»£c chuyá»ƒn hÆ°á»›ng.");

      // Chuyá»ƒn hÆ°á»›ng Ä‘áº¿n trang "KhÃ³a há»c cá»§a tÃ´i" cá»§a há»c viÃªn
      router.push("/student/my-courses");
    } catch (error) {
      toast.dismiss();
      toast.error(
        error instanceof Error
          ? error.message
          : "ÄÃ£ xáº£y ra lá»—i khi mua khÃ³a há»c."
      );
    } finally {
      setIsPurchasing(false);
    }
  };
  useEffect(() => {
    if (!courseId) return;

    const fetchCourse = async () => {
      setIsLoading(true);
      try {
        const data = await courseService.getCourse(courseId);
        setCourse(data);
      } catch (error) {
        toast.error("KhÃ´ng thá»ƒ táº£i thÃ´ng tin khÃ³a há»c.");
      } finally {
        setIsLoading(false);
      }
    };
    fetchCourse();
  }, [courseId]);

  if (isLoading) {
    return <CourseDetailSkeleton />;
  }

  if (!course) {
    return (
      <div className="text-center py-20">
        <h2 className="text-2xl font-bold">KhÃ´ng tÃ¬m tháº¥y khÃ³a há»c</h2>
        <p className="text-muted-foreground mt-2">
          KhÃ³a há»c báº¡n Ä‘ang tÃ¬m kiáº¿m khÃ´ng tá»“n táº¡i hoáº·c Ä‘Ã£ bá»‹ xÃ³a.
        </p>
      </div>
    );
  }

  // Xá»­ lÃ½ giÃ¡
  const displayPrice = new Intl.NumberFormat("vi-VN", {
    style: "currency",
    currency: "VND",
  }).format(course.price);

  return (
    <div className="bg-slate-50">
      {/* Header */}
      <header className="bg-gray-800 text-white py-12">
        <div className="container mx-auto">
          <h1 className="text-4xl font-bold mb-2">{course.title}</h1>
          <p className="text-lg text-gray-300 mb-4">
            {course.description?.substring(0, 150)}...
          </p>
          <div className="flex items-center gap-6 text-sm">
            <span className="flex items-center gap-2">
              <BarChart size={16} /> {course.level}
            </span>
            <span className="flex items-center gap-2">
              <Users size={16} /> {course.total_students} há»c viÃªn
            </span>
            <span className="flex items-center gap-2">
              <Star size={16} /> {Number(course.average_rating ?? 0).toFixed(1)}{" "}
              ({course.reviewed_by || 0} Ä‘Ã¡nh giÃ¡)
            </span>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <div className="container mx-auto py-12">
        <div className="grid md:grid-cols-3 gap-8">
          {/* Left Column: Course Content */}
          <div className="md:col-span-2">
            <h2 className="text-2xl font-bold mb-4">Ná»™i dung khÃ³a há»c</h2>
            <div className="space-y-4">
              {course.sections?.map((section) => (
                <div
                  key={section.section_id}
                  className="border rounded-lg bg-white"
                >
                  <h3 className="font-semibold p-4 bg-gray-50 rounded-t-lg border-b">
                    {section.title}
                  </h3>
                  <ul className="divide-y">
                    {section.lessons?.map((lesson) => (
                      <li
                        key={lesson.lesson_id}
                        className="flex justify-between items-center p-3"
                      >
                        <span className="flex items-center gap-3">
                          {lesson.allow_preview ? (
                            <PlayCircle className="text-blue-500" size={20} />
                          ) : (
                            <Lock className="text-gray-400" size={20} />
                          )}
                          {lesson.title}
                        </span>
                        <span className="text-sm text-gray-500">
                          {lesson.allow_preview ? "Xem trÆ°á»›c" : "5 phÃºt"}
                        </span>
                      </li>
                    ))}
                  </ul>
                </div>
              ))}
            </div>
          </div>

          {/* Right Column: Purchase Card */}
          <aside className="sticky top-24 self-start">
            <Card>
              <CardHeader className="p-0">
                <Image
                  src={course.thumbnail_url || "/placeholder.png"}
                  alt={course.title}
                  width={400}
                  height={200}
                  className="rounded-t-lg w-full object-cover"
                />
              </CardHeader>
              <CardContent className="p-6">
                <p className="text-3xl font-bold mb-4">{displayPrice}</p>
                <Button
                  size="lg"
                  className="w-full"
                  onClick={handlePurchase}
                  disabled={isPurchasing}
                >
                  {isPurchasing ? "Äang xá»­ lÃ½..." : "Mua ngay"}
                </Button>
                <ul className="mt-6 space-y-3 text-sm text-gray-600">
                  <li className="flex items-center gap-3">
                    <Clock size={16} /> Thá»i lÆ°á»£ng: {course.duration_hours} giá»
                  </li>
                  <li className="flex items-center gap-3">
                    <BarChart size={16} /> TrÃ¬nh Ä‘á»™: {course.level}
                  </li>
                  <li className="flex items-center gap-3">
                    <Users size={16} /> {course.total_students} há»c viÃªn Ä‘Ã£ tham
                    gia
                  </li>
                </ul>
              </CardContent>
            </Card>
          </aside>
        </div>
      </div>
    </div>
  );
}


