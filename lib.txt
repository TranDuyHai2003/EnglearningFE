//utils.ts
import { type ClassValue, clsx } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}


//api\adminService.ts
import apiClient from "./apiClient";
import {
  ApiResponse,
  PaginatedResponse,
  SystemSetting,
  SupportTicket,
} from "@/lib/types";

// Kiá»ƒu dá»¯ liá»‡u cho response cá»§a dashboard summary
interface DashboardSummary {
  total_users: number;
  total_courses: number;
  pending_courses: number;
  pending_instructors: number;
  total_enrollments: number;
  total_revenue: number;
}

export const adminService = {
  /**
   * Láº¥y dá»¯ liá»‡u thá»‘ng kÃª cho Dashboard.
   */
  async getDashboardSummary(): Promise<DashboardSummary> {
    const response = await apiClient.get<ApiResponse<DashboardSummary>>(
      "/admin/dashboard/summary"
    );
    if (response.data.success) {
      return response.data.data;
    }
    throw new Error(
      response.data.message || "KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u dashboard."
    );
  },

  /**
   * Láº¥y danh sÃ¡ch táº¥t cáº£ cÃ i Ä‘áº·t há»‡ thá»‘ng.
   */
  async listSettings(): Promise<SystemSetting[]> {
    const response = await apiClient.get<ApiResponse<SystemSetting[]>>(
      "/admin/settings"
    );
    if (response.data.success) {
      return response.data.data;
    }
    throw new Error(response.data.message || "KhÃ´ng thá»ƒ táº£i cÃ i Ä‘áº·t há»‡ thá»‘ng.");
  },

  /**
   * ThÃªm hoáº·c cáº­p nháº­t má»™t cÃ i Ä‘áº·t.
   */
  async upsertSetting(
    key: string,
    value: string,
    description?: string
  ): Promise<SystemSetting> {
    const response = await apiClient.post<ApiResponse<SystemSetting>>(
      "/admin/settings",
      { key, value, description }
    );
    if (response.data.success) {
      return response.data.data;
    }
    throw new Error(response.data.message || "LÆ°u cÃ i Ä‘áº·t tháº¥t báº¡i.");
  },

  /**
   * XÃ³a má»™t cÃ i Ä‘áº·t.
   */
  async deleteSetting(key: string): Promise<void> {
    const response = await apiClient.delete<ApiResponse<null>>(
      `/admin/settings/${key}`
    );
    if (!response.data.success) {
      throw new Error(response.data.message || "XÃ³a cÃ i Ä‘áº·t tháº¥t báº¡i.");
    }
  },

  /**
   * Láº¥y danh sÃ¡ch cÃ¡c ticket há»— trá»£.
   */
  async listSupportTickets(
    page: number = 1,
    limit: number = 10
  ): Promise<PaginatedResponse<SupportTicket>> {
    const response = await apiClient.get<PaginatedResponse<SupportTicket>>(
      "/admin/support/tickets",
      { params: { page, limit } }
    );

    // Tráº£ luÃ´n response.data vÃ¬ nÃ³ Ä‘Ã£ cÃ³ dáº¡ng { data, meta }
    return response.data;
  },
};


//api\apiClient.ts
import axios from "axios";
import { clearAuthData, getAuthToken } from "@/lib/auth/utils";

const baseURL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:5000/api";

const apiClient = axios.create({
  baseURL: baseURL,
  headers: {
    "Content-Type": "application/json",
  },
});

/**
 * Interceptor Ä‘á»ƒ tá»± Ä‘á»™ng thÃªm token vÃ o má»—i request.
 */
apiClient.interceptors.request.use(
  (config) => {
    // Chá»‰ thá»±c thi á»Ÿ phÃ­a client
    if (typeof window !== "undefined") {
      const token = getAuthToken();
      if (token) {
        config.headers["Authorization"] = `Bearer ${token}`;
      }
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

/**
 * Interceptor Ä‘á»ƒ xá»­ lÃ½ lá»—i response, Ä‘áº·c biá»‡t lÃ  lá»—i 401 (Unauthorized).
 */
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    // Chá»‰ thá»±c thi á»Ÿ phÃ­a client
    if (typeof window !== "undefined" && error.response?.status === 401) {
      console.error("Unauthorized! Token might be expired. Logging out.");
      clearAuthData();
      // Redirect vá» trang login Ä‘á»ƒ ngÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p láº¡i
      window.location.href = "/login";
    }
    return Promise.reject(error);
  }
);

export default apiClient;


//api\authService.ts
import apiClient from "./apiClient";
import {
  ApiResponse,
  LoginRequest,
  RegisterRequest,
  User,
  AuthenticatedUser,
} from "../types";
import { AxiosError } from "axios";

// Kiá»ƒu dá»¯ liá»‡u cho pháº§n `data` trong response cá»§a API login/register
interface AuthResponseData {
  token: string;
  user: AuthenticatedUser; // Sá»­ dá»¥ng AuthenticatedUser Ä‘á»ƒ an toÃ n hÆ¡n
}

// HÃ m trá»£ giÃºp Ä‘á»ƒ xá»­ lÃ½ lá»—i má»™t cÃ¡ch nháº¥t quÃ¡n
const getErrorMessage = (error: unknown, defaultMessage: string): string => {
  if (error instanceof AxiosError) {
    // Lá»—i tá»« Axios, cÃ³ thá»ƒ chá»©a response.data.message
    return error.response?.data?.message || error.message || defaultMessage;
  }
  if (error instanceof Error) {
    // Lá»—i JavaScript thÃ´ng thÆ°á»ng
    return error.message;
  }
  // TrÆ°á»ng há»£p khÃ´ng xÃ¡c Ä‘á»‹nh
  return defaultMessage;
};

/**
 * Gá»­i yÃªu cáº§u Ä‘Äƒng nháº­p Ä‘áº¿n server.
 * @throws {Error} Náº¿u Ä‘Äƒng nháº­p tháº¥t báº¡i.
 */
const login = async (credentials: LoginRequest): Promise<AuthResponseData> => {
  try {
    const response = await apiClient.post<ApiResponse<AuthResponseData>>(
      "/auth/login",
      credentials
    );
    const apiResponse = response.data;
    if (apiResponse.success && apiResponse.data) {
      return apiResponse.data;
    } else {
      throw new Error(apiResponse.message || "Email hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng.");
    }
  } catch (error: unknown) {
    throw new Error(getErrorMessage(error, "ÄÃ£ xáº£y ra lá»—i káº¿t ná»‘i."));
  }
};

/**
 * Gá»­i yÃªu cáº§u Ä‘Äƒng kÃ½ Ä‘áº¿n server.
 * @throws {Error} Náº¿u Ä‘Äƒng kÃ½ tháº¥t báº¡i.
 */
const register = async (data: RegisterRequest): Promise<AuthResponseData> => {
  try {
    const response = await apiClient.post<ApiResponse<AuthResponseData>>(
      "/auth/register",
      data
    );
    const apiResponse = response.data;
    if (apiResponse.success && apiResponse.data) {
      return apiResponse.data;
    } else {
      throw new Error(apiResponse.message || "ÄÄƒng kÃ½ tháº¥t báº¡i.");
    }
  } catch (error: unknown) {
    throw new Error(getErrorMessage(error, "Lá»—i Ä‘Äƒng kÃ½."));
  }
};

/**
 * Láº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng hiá»‡n táº¡i tá»« server.
 * @throws {Error} Náº¿u token khÃ´ng há»£p lá»‡.
 */
const getMe = async (): Promise<AuthenticatedUser> => {
  try {
    const response = await apiClient.get<ApiResponse<AuthenticatedUser>>(
      "/auth/me"
    );
    const apiResponse = response.data;
    if (apiResponse.success && apiResponse.data) {
      return apiResponse.data;
    } else {
      throw new Error(apiResponse.message || "PhiÃªn Ä‘Äƒng nháº­p khÃ´ng há»£p lá»‡.");
    }
  } catch (error: unknown) {
    throw new Error(getErrorMessage(error, "KhÃ´ng thá»ƒ xÃ¡c thá»±c ngÆ°á»i dÃ¹ng."));
  }
};

export const authService = {
  login,
  register,
  getMe,
};


//api\courseService.ts
import apiClient from "./apiClient";
import {
  ApiResponse,
  PaginatedResponse,
  Course,
  CourseForm,
  Category,
  CourseTag,
  CourseStatus,
  ApprovalStatus,
  SectionForm,
  Section,
  LessonForm,
  Lesson,
} from "@/lib/types";

// Kiá»ƒu cho tham sá»‘ lá»c khÃ³a há»c
interface ListCoursesParams {
  limit?: number;
  page?: number;
  status?: CourseStatus;
  approval_status?: ApprovalStatus;
  instructor_id?: number;
  category_id?: number;
  search?: string;
}

interface ListCoursesApiResponse {
  success: boolean;
  data: Course[];
  meta: PaginatedResponse<unknown>["meta"];
  message?: string;
}

export const courseService = {
  /**
   * Láº¥y danh sÃ¡ch khÃ³a há»c cÃ³ phÃ¢n trang vÃ  bá»™ lá»c.
   */
  async listCourses(
    params: ListCoursesParams
  ): Promise<PaginatedResponse<Course>> {
    // âœ… Sá»¬A Lá»–I á»ž ÄÃ‚Y:
    const response = await apiClient.get<ListCoursesApiResponse>("/courses", {
      params,
    });
    const apiData = response.data;

    if (apiData.success && apiData.data && apiData.meta) {
      return {
        data: apiData.data,
        meta: apiData.meta,
      };
    }

    throw new Error(apiData.message || "KhÃ´ng thá»ƒ táº£i danh sÃ¡ch khÃ³a há»c.");
  },

  /**
   * Láº¥y thÃ´ng tin chi tiáº¿t má»™t khÃ³a há»c báº±ng ID.
   */
  async getCourse(id: number): Promise<Course> {
    const response = await apiClient.get<ApiResponse<Course>>(`/courses/${id}`);
    if (response.data.success && response.data.data) {
      return response.data.data;
    }
    throw new Error(response.data.message || "KhÃ´ng thá»ƒ tÃ¬m tháº¥y khÃ³a há»c.");
  },

  /**
   * Táº¡o má»™t khÃ³a há»c má»›i.
   */
  async createCourse(data: CourseForm): Promise<Course> {
    const response = await apiClient.post<ApiResponse<Course>>(
      "/courses",
      data
    );
    if (response.data.success && response.data.data) {
      return response.data.data;
    }
    throw new Error(response.data.message || "Táº¡o khÃ³a há»c tháº¥t báº¡i.");
  },

  /**
   * Cáº­p nháº­t má»™t khÃ³a há»c.
   */
  async updateCourse(id: number, data: Partial<CourseForm>): Promise<Course> {
    const response = await apiClient.patch<ApiResponse<Course>>(
      `/courses/${id}`,
      data
    );
    if (response.data.success && response.data.data) {
      return response.data.data;
    }
    throw new Error(response.data.message || "Cáº­p nháº­t khÃ³a há»c tháº¥t báº¡i.");
  },

  /**
   * Láº¥y danh sÃ¡ch táº¥t cáº£ cÃ¡c danh má»¥c.
   */
  async listCategories(): Promise<Category[]> {
    const response = await apiClient.get<ApiResponse<Category[]>>(
      "/courses/meta/categories"
    );
    if (response.data.success && response.data.data) {
      return response.data.data;
    }
    throw new Error(response.data.message || "KhÃ´ng thá»ƒ táº£i danh má»¥c.");
  },

  /**
   * Láº¥y danh sÃ¡ch táº¥t cáº£ cÃ¡c tag.
   */
  async listTags(): Promise<CourseTag[]> {
    const response = await apiClient.get<ApiResponse<CourseTag[]>>(
      "/courses/meta/tags"
    );
    if (response.data.success && response.data.data) {
      return response.data.data;
    }
    throw new Error(response.data.message || "KhÃ´ng thá»ƒ táº£i danh sÃ¡ch tag.");
  },
  async createSection(courseId: number, data: SectionForm): Promise<Section> {
    const response = await apiClient.post<ApiResponse<Section>>(
      `/courses/${courseId}/sections`,
      data
    );
    if (response.data.success && response.data.data) return response.data.data;
    throw new Error(response.data.message || "Táº¡o chÆ°Æ¡ng há»c tháº¥t báº¡i.");
  },

  async updateSection(
    courseId: number,
    sectionId: number,
    data: Partial<SectionForm>
  ): Promise<Section> {
    const response = await apiClient.patch<ApiResponse<Section>>(
      `/courses/${courseId}/sections/${sectionId}`,
      data
    );
    if (response.data.success && response.data.data) return response.data.data;
    throw new Error(response.data.message || "Cáº­p nháº­t chÆ°Æ¡ng há»c tháº¥t báº¡i.");
  },

  async deleteSection(courseId: number, sectionId: number): Promise<void> {
    const response = await apiClient.delete<ApiResponse<null>>(
      `/courses/${courseId}/sections/${sectionId}`
    );
    if (!response.data.success) {
      throw new Error(response.data.message || "XÃ³a chÆ°Æ¡ng há»c tháº¥t báº¡i.");
    }
  },

  // ===========================================
  // LESSON APIs
  // ===========================================
  async createLesson(sectionId: number, data: LessonForm): Promise<Lesson> {
    const response = await apiClient.post<ApiResponse<Lesson>>(
      `/courses/sections/${sectionId}/lessons`,
      data
    );
    if (response.data.success && response.data.data) return response.data.data;
    throw new Error(response.data.message || "Táº¡o bÃ i há»c tháº¥t báº¡i.");
  },

  /**
   * âœ… HÃ€M Má»šI: Cáº­p nháº­t má»™t bÃ i há»c.
   */
  async updateLesson(
    sectionId: number,
    lessonId: number,
    data: Partial<LessonForm>
  ): Promise<Lesson> {
    const response = await apiClient.patch<ApiResponse<Lesson>>(
      `/courses/sections/${sectionId}/lessons/${lessonId}`,
      data
    );
    if (response.data.success && response.data.data) return response.data.data;
    throw new Error(response.data.message || "Cáº­p nháº­t bÃ i há»c tháº¥t báº¡i.");
  },

  /**
   * âœ… HÃ€M Má»šI: XÃ³a má»™t bÃ i há»c.
   */
  async deleteLesson(sectionId: number, lessonId: number): Promise<void> {
    const response = await apiClient.delete<ApiResponse<null>>(
      `/courses/sections/${sectionId}/lessons/${lessonId}`
    );
    if (!response.data.success) {
      throw new Error(response.data.message || "XÃ³a bÃ i há»c tháº¥t báº¡i.");
    }
  },
};


//api\instructorService.ts
import apiClient from "./apiClient";
import {
  InstructorProfile,
  ApiResponse,
  InstructorApplicationForm,
  ApprovalStatus,
  PaginatedResponse,
} from "@/lib/types";
import { AxiosError } from "axios";

interface ListProfilesParams {
  limit?: number;
  page?: number;
  status?: ApprovalStatus;
}
interface ListProfilesApiResponse {
  success: boolean;
  data: InstructorProfile[];
  meta: PaginatedResponse<unknown>["meta"];
  message?: string;
}
export const instructorService = {
  /**
   * Láº¥y há»“ sÆ¡ cá»§a giáº£ng viÃªn Ä‘ang Ä‘Äƒng nháº­p.
   */
  async getMyProfile(): Promise<InstructorProfile | null> {
    try {
      const response = await apiClient.get<ApiResponse<InstructorProfile>>(
        "/instructors/profiles/my-profile"
      );
      if (response.data.success && response.data.data) {
        return response.data.data;
      }
      return null;
    } catch (error: unknown) {
      if (error instanceof AxiosError && error.response?.status === 404) {
        return null; // Tráº£ vá» null náº¿u chÆ°a cÃ³ há»“ sÆ¡ (404 Not Found)
      }
      throw error; // NÃ©m cÃ¡c lá»—i khÃ¡c
    }
  },

  /**
   * Ná»™p há»“ sÆ¡ á»©ng tuyá»ƒn (chá»‰ táº¡o má»›i).
   */
  async createProfile(
    data: InstructorApplicationForm
  ): Promise<InstructorProfile> {
    const response = await apiClient.post<ApiResponse<InstructorProfile>>(
      "/instructors/profiles",
      data
    );
    if (response.data.success && response.data.data) {
      return response.data.data;
    }
    throw new Error(response.data.message || "Ná»™p há»“ sÆ¡ tháº¥t báº¡i.");
  },

  /**
   * Cáº­p nháº­t há»“ sÆ¡ á»©ng tuyá»ƒn Ä‘Ã£ cÃ³.
   */
  async updateProfile(
    data: InstructorApplicationForm
  ): Promise<InstructorProfile> {
    const response = await apiClient.patch<ApiResponse<InstructorProfile>>(
      "/instructors/profiles",
      data
    );
    if (response.data.success && response.data.data) {
      return response.data.data;
    }
    throw new Error(response.data.message || "Cáº­p nháº­t há»“ sÆ¡ tháº¥t báº¡i.");
  },

  /**
   * Láº¥y danh sÃ¡ch há»“ sÆ¡ giáº£ng viÃªn (cho Admin).
   */
  async listProfiles(
    params: ListProfilesParams
  ): Promise<PaginatedResponse<InstructorProfile>> {
    // âœ… Sá»¬A Lá»–I á»ž ÄÃ‚Y:
    const response = await apiClient.get<ListProfilesApiResponse>(
      "/instructors/profiles",
      { params }
    );
    const apiData = response.data;

    if (apiData.success && apiData.data && apiData.meta) {
      return {
        data: apiData.data,
        meta: apiData.meta,
      };
    }
    throw new Error(response.data.message || "KhÃ´ng thá»ƒ táº£i danh sÃ¡ch há»“ sÆ¡.");
  },
  /**
   * Duyá»‡t má»™t há»“ sÆ¡ giáº£ng viÃªn (cho Admin).
   */
  async reviewProfile(
    profileId: number,
    status: "approved" | "rejected",
    reason?: string
  ): Promise<InstructorProfile> {
    const response = await apiClient.patch<ApiResponse<InstructorProfile>>(
      `/instructors/profiles/${profileId}/review`,
      { status, reason }
    );
    if (response.data.success && response.data.data) {
      return response.data.data;
    }
    throw new Error(response.data.message || "Duyá»‡t há»“ sÆ¡ tháº¥t báº¡i.");
  },
};


//api\userService.ts
import apiClient from "./apiClient";
import {
  AuthenticatedUser,
  UpdateProfileForm,
  ApiResponse,
  ChangePasswordForm,
  UserRole,
  UserStatus,
} from "@/lib/types";

// Kiá»ƒu dá»¯ liá»‡u cho cÃ¡c tham sá»‘ lá»c/phÃ¢n trang
interface ListUsersParams {
  limit?: number;
  page?: number;
  role?: UserRole;
  status?: UserStatus;
  keyword?: string;
}

interface ListUsersResponse {
  success: boolean;
  data: AuthenticatedUser[];
  meta: {
    total: number;
    page: number;
    limit: number;
    total_pages: number;
  };
  message?: string;
}

export const userService = {
  async listUsers(params: ListUsersParams): Promise<ListUsersResponse> {
    const response = await apiClient.get<ListUsersResponse>("/users", {
      params,
    });
    return response.data;
  },
  async getUser(userId: number): Promise<AuthenticatedUser> {
    const response = await apiClient.get<ApiResponse<AuthenticatedUser>>(
      `/users/${userId}`
    );
    if (response.data.success) {
      return response.data.data;
    }
    throw new Error(
      response.data.message || "KhÃ´ng thá»ƒ táº£i thÃ´ng tin ngÆ°á»i dÃ¹ng."
    );
  },

  /**
   * Cáº­p nháº­t thÃ´ng tin profile (cho cáº£ user tá»± cáº­p nháº­t vÃ  admin cáº­p nháº­t).
   * Backend dÃ¹ng PATCH, nÃªn Ä‘Ã¢y cÅ©ng lÃ  PATCH.
   */
  async updateUser(
    userId: number,
    data: UpdateProfileForm
  ): Promise<AuthenticatedUser> {
    const response = await apiClient.patch<ApiResponse<AuthenticatedUser>>(
      `/users/${userId}`,
      data
    );
    if (response.data.success) {
      return response.data.data;
    }
    throw new Error(response.data.message || "Cáº­p nháº­t thÃ´ng tin tháº¥t báº¡i.");
  },

  /**
   * Cáº­p nháº­t vai trÃ² cá»§a ngÆ°á»i dÃ¹ng (cho Admin).
   */
  async updateUserRole(
    userId: number,
    role: UserRole
  ): Promise<AuthenticatedUser> {
    const response = await apiClient.patch<ApiResponse<AuthenticatedUser>>(
      `/users/${userId}/role`,
      { role }
    );
    if (response.data.success) {
      return response.data.data;
    }
    throw new Error(response.data.message || "Cáº­p nháº­t vai trÃ² tháº¥t báº¡i.");
  },

  /**
   * Thay Ä‘á»•i máº­t kháº©u.
   */
  async changePassword(
    userId: number,
    data: ChangePasswordForm
  ): Promise<void> {
    const response = await apiClient.patch<ApiResponse<null>>(
      `/users/${userId}/password`,
      data
    );
    if (!response.data.success) {
      throw new Error(response.data.message || "Äá»•i máº­t kháº©u tháº¥t báº¡i.");
    }
  },
};


//auth\utils.ts
import { AuthenticatedUser } from "../types"; // âœ… Sá»­a thÃ nh AuthenticatedUser

const TOKEN_KEY = "authToken";
const USER_KEY = "authUser";

/**
 * LÆ°u token vÃ  thÃ´ng tin ngÆ°á»i dÃ¹ng vÃ o localStorage.
 */
export const setAuthData = (token: string, user: AuthenticatedUser): void => {
  // âœ… Sá»­a thÃ nh AuthenticatedUser
  if (typeof window === "undefined") return;
  localStorage.setItem(TOKEN_KEY, token);
  localStorage.setItem(USER_KEY, JSON.stringify(user));
};

/**
 * Láº¥y token xÃ¡c thá»±c tá»« localStorage.
 */
export const getAuthToken = (): string | null => {
  if (typeof window === "undefined") return null;
  return localStorage.getItem(TOKEN_KEY);
};

/**
 * Láº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng Ä‘Ã£ lÆ°u tá»« localStorage.
 */
export const getStoredUser = (): AuthenticatedUser | null => {
  // âœ… Sá»­a thÃ nh AuthenticatedUser
  if (typeof window === "undefined") return null;
  const userJson = localStorage.getItem(USER_KEY);
  if (!userJson) return null;
  try {
    return JSON.parse(userJson) as AuthenticatedUser;
  } catch (error) {
    console.error("Failed to parse user data from localStorage", error);
    clearAuthData();
    return null;
  }
};

/**
 * XÃ³a toÃ n bá»™ dá»¯ liá»‡u xÃ¡c thá»±c khá»i localStorage.
 */
export const clearAuthData = (): void => {
  if (typeof window === "undefined") return;
  localStorage.removeItem(TOKEN_KEY);
  localStorage.removeItem(USER_KEY);
};


//hooks\useAuth.ts
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { AuthenticatedUser } from "../types";
import {
  getAuthToken,
  clearAuthData,
  getStoredUser,
  setAuthData,
} from "../auth/utils";
import { authService } from "../api/authService";

interface UseAuthOptions {
  redirectToLoginIfFail?: boolean;
}

interface UseAuthReturn {
  user: AuthenticatedUser | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  updateUser: (newUser: AuthenticatedUser) => void; // âœ… 1. ThÃªm hÃ m updateUser vÃ o kiá»ƒu tráº£ vá»
}

export function useAuth(options: UseAuthOptions = {}): UseAuthReturn {
  const router = useRouter();
  const [user, setUser] = useState<AuthenticatedUser | null>(getStoredUser());
  const [isAuthenticated, setIsAuthenticated] = useState<boolean>(
    !!getAuthToken()
  );
  const [isLoading, setIsLoading] = useState(true);

  // âœ… 2. Táº¡o hÃ m updateUser Ä‘á»ƒ cáº­p nháº­t state vÃ  localStorage
  const updateUser = (newUser: AuthenticatedUser) => {
    const token = getAuthToken();
    if (token) {
      setUser(newUser);
      setAuthData(token, newUser);
    }
  };

  useEffect(() => {
    const verifyUserAuthentication = async () => {
      // ... logic xÃ¡c thá»±c khÃ´ng thay Ä‘á»•i ...
      const token = getAuthToken();
      if (!token) {
        setIsAuthenticated(false);
        setUser(null);
        setIsLoading(false);
        if (options.redirectToLoginIfFail) {
          router.replace("/login");
        }
        return;
      }
      try {
        const freshUserFromServer = await authService.getMe();
        const storedUser = getStoredUser();
        const updatedUser: AuthenticatedUser = {
          ...storedUser,
          ...freshUserFromServer,
        };
        setUser(updatedUser);
        setIsAuthenticated(true);
        setAuthData(token, updatedUser);
      } catch (error) {
        console.error("Auth verification failed:", error);
        clearAuthData();
        setIsAuthenticated(false);
        setUser(null);
        if (options.redirectToLoginIfFail) {
          router.replace("/login");
        }
      } finally {
        setIsLoading(false);
      }
    };
    verifyUserAuthentication();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // âœ… 3. Tráº£ vá» hÃ m updateUser
  return { user, isAuthenticated, isLoading, updateUser };
}


//mock\profile.ts
import { InstructorProfile } from "@/lib/types";

// Má»™t biáº¿n Ä‘á»ƒ giáº£ láº­p tráº¡ng thÃ¡i cá»§a há»“ sÆ¡
// Báº¡n cÃ³ thá»ƒ thay Ä‘á»•i giÃ¡ trá»‹ nÃ y Ä‘á»ƒ test cÃ¡c ká»‹ch báº£n khÃ¡c nhau:
// 'pending', 'approved', 'rejected', hoáº·c null (chÆ°a cÃ³ há»“ sÆ¡)
let mockProfileStatus: "pending" | "approved" | "rejected" | null = null;

const baseProfile: Omit<InstructorProfile, "approval_status"> = {
  profile_id: 101,
  user_id: 2, // Giáº£ sá»­ user ID cá»§a giáº£ng viÃªn lÃ  2
  bio: "TÃ´i lÃ  má»™t giáº£ng viÃªn cÃ³ 5 nÄƒm kinh nghiá»‡m giáº£ng dáº¡y tiáº¿ng Anh giao tiáº¿p vÃ  luyá»‡n thi IELTS. TÃ´i Ä‘am mÃª giÃºp Ä‘á»¡ há»c viÃªn vÆ°á»£t qua rÃ o cáº£n ngÃ´n ngá»¯.",
  education:
    "Cá»­ nhÃ¢n NgÃ´n ngá»¯ Anh - Äáº¡i há»c Khoa há»c XÃ£ há»™i vÃ  NhÃ¢n vÄƒn TP.HCM",
  experience: "5 nÄƒm táº¡i Trung tÃ¢m Anh ngá»¯ ABC, 2 nÄƒm dáº¡y online.",
  certificates: "IELTS 8.5, TESOL",
  rejection_reason:
    "Há»“ sÆ¡ chÆ°a cung cáº¥p Ä‘á»§ minh chá»©ng vá» kinh nghiá»‡m giáº£ng dáº¡y.",
};

// HÃ m Ä‘á»ƒ láº¥y dá»¯ liá»‡u giáº£
export const getMockInstructorProfile = (): InstructorProfile | null => {
  if (mockProfileStatus === null) {
    return null; // Giáº£ láº­p trÆ°á»ng há»£p chÆ°a cÃ³ há»“ sÆ¡
  }
  return {
    ...baseProfile,
    approval_status: mockProfileStatus,
  };
};

// HÃ m Ä‘á»ƒ cáº­p nháº­t dá»¯ liá»‡u giáº£ (giáº£ láº­p viá»‡c submit form)
export const updateMockInstructorProfile = (
  newData: Partial<InstructorProfile>
): InstructorProfile => {
  mockProfileStatus = "pending"; // Sau khi cáº­p nháº­t, tráº¡ng thÃ¡i luÃ´n lÃ  pending
  Object.assign(baseProfile, newData);
  return {
    ...baseProfile,
    approval_status: "pending",
  };
};

// HÃ m Ä‘á»ƒ thay Ä‘á»•i tráº¡ng thÃ¡i Ä‘á»ƒ test
export const setMockProfileStatus = (
  status: "pending" | "approved" | "rejected" | null
) => {
  mockProfileStatus = status;
};

// VÃ­ dá»¥: gá»i setMockProfileStatus('pending') trong console cá»§a trÃ¬nh duyá»‡t Ä‘á»ƒ test
if (typeof window !== "undefined") {
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  (window as any).setMockProfileStatus = setMockProfileStatus;
}


//types\index.ts
// ===================================================================
// ENUM TYPES (Dá»±a trÃªn schema CSDL)
// ===================================================================

export type UserRole =
  | "student"
  | "instructor"
  | "support_admin"
  | "system_admin";
export type UserStatus = "active" | "inactive" | "pending" | "locked";
export type ApprovalStatus = "pending" | "approved" | "rejected";
export type CourseLevel = "beginner" | "intermediate" | "advanced";
export type CourseStatus =
  | "draft"
  | "pending"
  | "published"
  | "rejected"
  | "archived";
export type EnrollmentStatus = "active" | "completed" | "dropped";
export type LessonType = "video" | "document" | "quiz" | "assignment";
export type ProgressStatus = "not_started" | "in_progress" | "completed";
export type QuestionType = "multiple_choice" | "true_false" | "fill_blank";
export type PaymentMethod = "bank_card" | "e_wallet" | "bank_transfer";
export type TransactionStatus = "pending" | "completed" | "failed" | "refunded";
export type NotificationType = "course" | "payment" | "message" | "system";
export type SupportCategory = "technical" | "payment" | "content" | "other";
export type SupportPriority = "low" | "medium" | "high" | "urgent";
export type SupportStatus = "open" | "in_progress" | "resolved" | "closed";

// ===================================================================
// DATABASE TABLE INTERFACES (tuÃ¢n thá»§ snake_case cá»§a CSDL)
// ===================================================================

export interface User {
  user_id: number;
  email: string;
  password_hash: string;
  full_name: string;
  phone?: string | null;
  avatar_url?: string | null;
  role: UserRole;
  status: UserStatus;
  created_at: string;
  updated_at: string;
  last_login?: string | null;
}

export interface InstructorProfile {
  profile_id: number;
  user_id: number;
  bio?: string | null;
  education?: string | null;
  experience?: string | null;
  certificates?: string | null;
  approval_status: ApprovalStatus;
  approved_by?: number | null;
  approved_at?: string | null;
  rejection_reason?: string | null;
  user?: AuthenticatedUser; // `user` lá»“ng vÃ o tá»« API listProfiles
}

export interface Category {
  category_id: number;
  name: string;
  slug: string;
  description?: string | null;
  parent_id?: number | null;
  display_order: number;
}

export interface Course {
  course_id: number;
  instructor_id: number;
  category_id?: number | null;
  title: string;
  slug: string;
  description?: string | null;
  thumbnail_url?: string | null;
  level: CourseLevel;
  language: string;
  price: number;
  discount_price?: number | null;
  duration_hours: number;
  status: CourseStatus;
  approval_status: ApprovalStatus;
  reviewed_by?: number | null;
  reviewed_at?: string | null;
  rejection_reason?: string | null;
  total_students: number;
  average_rating: number;
  created_at: string;
  updated_at: string;
  published_at?: string | null;

  instructor?: AuthenticatedUser;
  category?: Category;
  sections?: Section[];
  tags?: CourseTag[];
}

export interface CourseTag {
  tag_id: number;
  name: string;
  slug: string;
}

export interface Section {
  section_id: number;
  course_id: number;
  title: string;
  description?: string | null;
  display_order: number;
  created_at: string;
  lessons?: Lesson[]; // Quan há»‡ lá»“ng nhau
}

export interface Lesson {
  lesson_id: number;
  section_id: number;
  title: string;
  description?: string | null;
  lesson_type: LessonType;
  video_url?: string | null;
  video_duration: number;
  content?: string | null;
  allow_preview: boolean;
  display_order: number;
  created_at: string;
  updated_at: string;
  resources?: LessonResource[]; // Quan há»‡ lá»“ng nhau
}

export interface LessonResource {
  resource_id: number;
  lesson_id: number;
  title: string;
  file_url: string;
  file_type?: string | null;
  file_size?: number | null;
  uploaded_at: string;
}

export interface CourseForm {
  title: string;
  description: string;
  category_id: number;
  level: CourseLevel;
  language: string;
  price: number;
  discount_price?: number;
  thumbnail_url?: string;
  duration_hours: number;
  tag_ids?: number[];
}

/**
 * Dá»¯ liá»‡u cho form táº¡o/cáº­p nháº­t Section
 */
export interface SectionForm {
  title: string;
  description?: string;
  display_order: number;
}

/**
 * Dá»¯ liá»‡u cho form táº¡o/cáº­p nháº­t Lesson
 */
export interface LessonForm {
  title: string;
  description?: string;
  lesson_type: LessonType;
  video_url?: string;
  video_duration?: number;
  content?: string;
  allow_preview: boolean;
  display_order: number;
}

export interface Quiz {
  quiz_id: number;
  lesson_id: number;
  title: string;
  description?: string | null;
  time_limit?: number | null;
  passing_score: number;
  max_attempts: number;
  shuffle_questions: boolean;
  show_correct_answers: boolean;
  created_at: string;
}

export interface Question {
  question_id: number;
  quiz_id: number;
  question_text: string;
  question_type: QuestionType;
  points: number;
  display_order: number;
  explanation?: string | null;
}

export interface AnswerOption {
  option_id: number;
  question_id: number;
  option_text: string;
  is_correct: boolean;
  display_order: number;
}

export interface Enrollment {
  enrollment_id: number;
  student_id: number;
  course_id: number;
  enrolled_at: string;
  completion_percentage: number;
  status: EnrollmentStatus;
  completed_at?: string | null;
  certificate_issued: boolean;
}

export interface LessonProgress {
  progress_id: number;
  enrollment_id: number;
  lesson_id: number;
  status: ProgressStatus;
  video_progress: number;
  started_at?: string | null;
  completed_at?: string | null;
}

export interface QuizAttempt {
  attempt_id: number;
  student_id: number;
  quiz_id: number;
  started_at: string;
  submitted_at?: string | null;
  score?: number | null;
  passed?: boolean | null;
  time_taken?: number | null;
}

export interface StudentAnswer {
  answer_id: number;
  attempt_id: number;
  question_id: number;
  selected_option_id?: number | null;
  answer_text?: string | null;
  is_correct?: boolean | null;
  points_earned: number;
}

export interface Transaction {
  transaction_id: number;
  student_id: number;
  transaction_code: string;
  total_amount: number;
  discount_amount: number;
  final_amount: number;
  payment_method?: PaymentMethod | null;
  payment_gateway?: string | null;
  status: TransactionStatus;
  payment_at?: string | null;
  refunded_at?: string | null;
  created_at: string;
}

export interface TransactionDetail {
  detail_id: number;
  transaction_id: number;
  course_id: number;
  price: number;
  discount: number;
  final_price: number;
}

export interface Review {
  review_id: number;
  course_id: number;
  student_id: number;
  rating: number;
  comment?: string | null;
  status: ApprovalStatus;
  created_at: string;
  updated_at: string;
}

export interface QaDiscussion {
  discussion_id: number;
  lesson_id: number;
  student_id: number;
  question: string;
  created_at: string;
  updated_at: string;
}

export interface QaReply {
  reply_id: number;
  discussion_id: number;
  user_id: number;
  reply_text: string;
  created_at: string;
  updated_at: string;
}

export interface Message {
  message_id: number;
  sender_id: number;
  receiver_id: number;
  course_id?: number | null;
  message_text: string;
  is_read: boolean;
  sent_at: string;
}

export interface Notification {
  notification_id: number;
  user_id: number;
  type: NotificationType;
  title: string;
  content?: string | null;
  is_read: boolean;
  created_at: string;
}

export interface SupportTicket {
  ticket_id: number;
  user_id: number;
  category: SupportCategory;
  subject: string;
  description: string;
  priority: SupportPriority;
  status: SupportStatus;
  assigned_to?: number | null;
  created_at: string;
  resolved_at?: string | null;
  user?: User;
  replies?: SupportReply[];
}

export interface SupportReply {
  reply_id: number;
  ticket_id: number;
  user_id: number;
  reply_text: string;
  created_at: string;
}

export interface SystemSetting {
  setting_id: number;
  setting_key: string;
  setting_value?: string | null;
  description?: string | null;
  updated_at: string;
}

// ===================================================================
// API RESPONSE & FORM PAYLOAD INTERFACES
// ===================================================================

/**
 * Cáº¥u trÃºc response chung tá»« API
 */
export interface ApiResponse<T> {
  success: boolean;
  data: T;
  message: string;
}

/**
 */
export interface PaginatedResponse<T> {
  data: T[];
  meta: {
    total: number;
    page: number;
    limit: number;
    total_pages: number;
  };
}

/**
 * Dá»¯ liá»‡u ngÆ°á»i dÃ¹ng tráº£ vá» sau khi xÃ¡c thá»±c (khÃ´ng chá»©a password_hash)
 * ThÆ°á»ng Ä‘Æ°á»£c táº¡o bá»Ÿi má»™t hÃ m serialize á»Ÿ backend.
 */
export interface AuthenticatedUser {
  id: number;
  user_id?: number;
  email: string;
  full_name: string;
  phone?: string | null;
  avatar_url?: string | null;
  role: UserRole;
  status: UserStatus;
}

/**
 * Dá»¯ liá»‡u cho API Ä‘Äƒng nháº­p
 */
export interface LoginRequest {
  email: string;
  password: string;
}

/**
 * Dá»¯ liá»‡u cho API Ä‘Äƒng kÃ½
 */
export interface RegisterRequest {
  full_name: string;
  email: string;
  password: string;
  role: "student" | "instructor";
}

/**
 * Dá»¯ liá»‡u cho form cáº­p nháº­t profile
 */
export interface UpdateProfileForm {
  full_name?: string;
  phone?: string;
  avatar_url?: string;
}

/**
 * Dá»¯ liá»‡u cho form Ä‘á»•i máº­t kháº©u
 */
export interface ChangePasswordForm {
  current_password: string;
  new_password: string;
}

/**
 * Dá»¯ liá»‡u cho form á»©ng tuyá»ƒn giáº£ng viÃªn
 */
export interface InstructorApplicationForm {
  bio: string;
  education: string;
  experience: string;
  certificates: string;
}


